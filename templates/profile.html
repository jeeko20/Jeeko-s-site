{%extends 'base.html'%}

{% block title %}Mon Profil | Eudushare{% endblock %}
{% block description %}Consulte et modifie ton profil sur Eudushare.{% endblock %}

 {%block extra_css%}
<link
  rel="stylesheet"
  href="{{url_for('static',filename='css/profile.css')}}"
/>
<style>
  /* Styles pour les activités quiz et flashcards */
.activity-quiz {
  border-left: 4px solid #ff9800;
  background: #fff3e0;
}

.activity-flashcard {
  border-left: 4px solid #4caf50;
  background: #e8f5e8;
}

.activity-item {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 15px;
  margin-bottom: 10px;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
  cursor: pointer;
  transition: all 0.3s ease;
}

.activity-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.activity-icon {
  font-size: 1.5em;
  flex-shrink: 0;
  margin-top: 2px;
}

.activity-content {
  flex: 1;
}

.activity-message {
  font-weight: 500;
  margin-bottom: 5px;
  color: #333;
}

.activity-meta {
  display: flex;
  justify-content: space-between;
  font-size: 0.85em;
  color: #666;
}

.activity-type {
  background: #e3f2fd;
  padding: 2px 8px;
  border-radius: 12px;
  font-weight: 500;
}
</style>
{%endblock%}
 {%block content%}

<!-- ================= HEADER ================= -->
<header class="header">
  <div class="header-content">
  {% if profile %}
  <div class="profile-details">
    <img src="{{ profile.avatar_path if profile.avatar_path else 'https://via.placeholder.com/150' }}" alt="Photo de profil" />
    <h2>{{ profile.complete_name }}</h2>
    <span>{{ profile.year_of_study }} année - {{ get_field_display_name(profile.field_of_study, profile.custom_field) }}</span>
  </div>
  <p>{{ profile.bio }}</p>
  <a href="#" class="btn-edit-profile">Modifier le profil</a>
  {% else %}
  <div class="profile-details">
    <img
      src="https://media.istockphoto.com/id/1386479313/photo/happy-millennial-afro-american-business-woman-posing-isolated-on-white.jpg?s=1024x1024&w=is&k=20&c=5OK7djfD3cnNmQ-DR0iQzF-vmA-iTNN1TbuEyCG1DfA="
      alt="Photo de profil"
    />
    <h2>User</h2>
  </div>
  <p>
    Lorem ipsum dolor sit amet consectetur adipisicing elit. Cum inventore
    libero a voluptates earum dolorem fugiat error, delectus iste iusto
    architecto laudantium blanditiis aspernatur. Et fugit aperiam ducimus
    excepturi expedita.
  </p>
  <a href="#" class="btn-edit-profile">Modifier le profil</a>
  {% endif %}
</div>


  <!-- Statistiques info-matière -->
  <div data-aos="zoom-in" class="info-matiere">
    <div>
      <span class="info">150+</span>
      <span>Notes partagees</span>
    </div>
    <div>
      <span class="info">45</span>
      <span>Etudiants actifs</span>
    </div>
    <div>
      <span class="info">8</span>
      <span>Matieres couvertes</span>
    </div>
    <div>
      <span class="info">95%</span>
      <span>Satisfaction</span>
    </div>
  </div>
</header>
<!-- ================= MAIN ================= -->

<nav>
  <button class="tab active" data-page="overview">
    <i class="fas fa-chart-line"></i> Vue d’ensemble
  </button>
  <button class="tab" data-page="settings">
    <i class="fas fa-cog"></i> Paramètres
  </button>
</nav>

<!-- Contenu dynamique -->
<main>
  <!-- OVERVIEW -->
<section id="overview" class="page active">
  <div class="section1">
    <!-- Colonne gauche : activités récentes AVEC NOTIFICATIONS -->
    <div class="recent-activities">
      <h3 data-aos="zoom-in">Activités récentes</h3>
      
      <!-- Filtres par date -->
      <div class="activity-filters">
        <select id="dateFilter">
          <option value="all">Toutes les activités</option>
          <option value="today">Aujourd'hui</option>
          <option value="week">Cette semaine</option>
          <option value="month">Ce mois</option>
        </select>
        <input type="date" id="customDate" style="display: none;">
      </div>
      
      <!-- Liste des activités -->
      <div id="activities-list" class="activities-list">
        <div data-aos="zoom-in" class="loading-activities">
          <div data-aos="zoom-in" class="spinner"></div>
          <p data-aos="zoom-in">Chargement des activités...</p>
        </div>
      </div>
      
      <!-- Pagination -->
      <div id="activities-pagination" data-aos="zoom-in" class="pagination"></div>
    </div>

    <!-- Colonne droite : actions rapides -->
    <div data-aos="fade-left" class="action-rapides">
      <h2 data-aos="zoom-in">Actions rapides</h2>
      <div data-aos="zoom-in" class="cards">
        <div data-aos="zoom-in" class="action-card" onclick="window.location.href='{{ url_for('communaute') }}'">
          <i data-aos="fade-left" class="fas fa-upload"></i>
          <span data-aos="zoom-in">Partager une nouvelle ressource</span>
        </div>

        <div  class="action-card" onclick="shareRessourceFromProfile()">
          <i data-aos="fade-left" class="fas fa-users"></i>
          <span data-aos="zoom-in">Voir les étudiants actifs</span>
        </div>

        <div class="action-card" onclick="window.location.href='{{ url_for('videos') }}'">
          <i data-aos="fade-left" class="fas fa-star"></i>
          <span data-aos="zoom-in">Voir les ressources populaires</span>
        </div>
      </div>
    </div>
  </div>
</section>


  <!-- SETTINGS -->
<section id="settings" class="page">
  <h2>Paramètres</h2>
  <form action="{{ url_for('profile') }}" method="POST" class="settings-form" enctype="multipart/form-data">
    <label for="fullname">Nom complet :</label>
    <input
      type="text"
      id="fullname"
      name="complete_name"
      placeholder="Votre nom complet"
      required
      value="{{profile.complete_name}}"
    />

    <label for="email">Email :</label>
    <input
      type="email"
      id="email"
      name="email"
      placeholder="exemple@mail.com"
      required
      value="{{profile.email}}"
    />

    <!-- NOUVEAU : Sélection de la filière -->
    <label for="field">Filière :</label>
    <select style="width: 70%;" id="field" name="field_of_study" required onchange="toggleCustomField()">
      <option value="">-- Sélectionnez votre filière --</option>
      <option value="informatique" {% if profile.field_of_study == 'informatique' %}selected{% endif %}>Informatique</option>
      <option value="administration" {% if profile.field_of_study == 'administration' %}selected{% endif %}>Administration</option>
      <option value="education" {% if profile.field_of_study == 'education' %}selected{% endif %}>Éducation</option>
      <option value="medecine" {% if profile.field_of_study == 'medecine' %}selected{% endif %}>Médecine</option>
      <option value="droit" {% if profile.field_of_study == 'droit' %}selected{% endif %}>Droit</option>
      <option value="ingenierie" {% if profile.field_of_study == 'ingenierie' %}selected{% endif %}>Ingénierie</option>
      <option value="commerce" {% if profile.field_of_study == 'commerce' %}selected{% endif %}>Commerce</option>
      <option value="autre" {% if profile.field_of_study == 'autre' %}selected{% endif %}>Autre</option>
    </select>

    <!-- Champ pour préciser si "autre" est sélectionné -->
    <div id="customFieldContainer" style="display: {% if profile.field_of_study == 'autre' %}block{% else %}none{% endif %};">
      <label for="custom_field">Précisez votre filière :</label>
      <input
        type="text"
        id="custom_field"
        name="custom_field"
        placeholder="Ex: Architecture, Psychologie, etc."
        value="{{ profile.custom_field if profile.custom_field else '' }}"
      />
    </div>

    <label for="year">Année d'étude :</label>
    <select id="year" name="year_of_study" required>
      <option value="">-- Sélectionnez --</option>
      <option value="1" {% if profile.year_of_study == '1' %}selected{% endif %}>1ère année</option>
      <option value="2" {% if profile.year_of_study == '2' %}selected{% endif %}>2ème année</option>
      <option value="3" {% if profile.year_of_study == '3' %}selected{% endif %}>3ème année</option>
      <option value="4" {% if profile.year_of_study == '4' %}selected{% endif %}>4ème année</option>
      <option value="5" {% if profile.year_of_study == '5' %}selected{% endif %}>5ème année</option>
    </select>

    <label for="avatar">Photo de profil :</label>
    <input type="file" id="avatar" name="avatar" accept="image/*" />

    <label for="bio">Bio :</label>
    <textarea
      id="bio"
      name="bio"
      rows="4"
      placeholder="Écrivez une courte description..."
    >{{profile.bio}}</textarea>

    <button type="submit">Sauvegarder</button>
  </form>
</section>
</main>
{%endblock%} {%block script%}
<script>
  /*=====================script SPA=======================*/
  // Sélectionner tous les boutons de navigation
  const tabs = document.querySelectorAll(".tab");
  const pages = document.querySelectorAll(".page");

  tabs.forEach((tab) => {
    tab.addEventListener("click", () => {
      // Retirer l'activation de tous les boutons
      tabs.forEach((t) => t.classList.remove("active"));
      // Activer le bouton cliqué
      tab.classList.add("active");

      // Masquer toutes les sections
      pages.forEach((page) => page.classList.remove("active"));
      // Afficher la section correspondante
      const target = tab.getAttribute("data-page");
      document.getElementById(target).classList.add("active");
    });
  });

  /*=====================script ACTIVITIES=======================*/
// ================= ACTIVITIES SYSTEM =================
let currentActivitiesPage = 1;
const ACTIVITIES_PER_PAGE = 10;
let allActivities = [];

// Fonction pour charger TOUTES les activités (ressources + quiz)
function loadActivities(filter = 'all', customDate = null) {
  console.log('Chargement des activités...');
  
  // Charger les notifications de ressources
  Promise.all([
    fetch('/api/notifications').then(res => res.json()),
    fetch('/api/quiz_notifications').then(res => res.json())
  ])
  .then(([ressourceNotifications, quizNotifications]) => {
    console.log('Notifications ressources:', ressourceNotifications);
    console.log('Notifications quiz:', quizNotifications);
    
    // Transformer les notifications quiz pour qu'elles aient le même format
    const transformedQuizNotifications = quizNotifications.map(notif => ({
      id: notif.id,
      message: notif.message,
      is_read: notif.is_read,
      created_at: notif.created_at,
      ressource_id: notif.quiz_id || notif.flashcard_id,
      ressource_type: notif.quiz_id ? 'quiz' : 'flashcard',
      notification_type: 'quiz' // Nouveau champ pour identifier le type
    }));
    
    // Combiner les deux types de notifications
    allActivities = [...ressourceNotifications, ...transformedQuizNotifications];
    
    let filtered = filterActivities(allActivities, filter, customDate);
    renderActivities(filtered, currentActivitiesPage);
  })
  .catch(err => {
    console.error('Erreur chargement activités:', err);
    document.getElementById('activities-list').innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c;">
        <p>Erreur lors du chargement des activités</p>
        <button onclick="loadActivities()" style="padding: 10px 20px; background: #6c5ce7; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">
          Réessayer
        </button>
      </div>
    `;
  });
}

function filterActivities(activities, filter, customDate) {
  const now = new Date();
  let startDate;
  
  switch(filter) {
    case 'today':
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      break;
    case 'week':
      startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      break;
    case 'month':
      startDate = new Date(now.getFullYear(), now.getMonth(), 1);
      break;
    case 'custom':
      if (customDate) startDate = new Date(customDate);
      break;
    default:
      return activities;
  }
  
  if (startDate) {
    return activities.filter(activity => new Date(activity.created_at) >= startDate);
  }
  
  return activities;
}

function renderActivities(activities, page) {
  const container = document.getElementById('activities-list');
  const totalPages = Math.ceil(activities.length / ACTIVITIES_PER_PAGE);
  const start = (page - 1) * ACTIVITIES_PER_PAGE;
  const paginated = activities.slice(start, start + ACTIVITIES_PER_PAGE);
  
  console.log('Rendu des activités:', paginated.length, 'sur page', page);
  
  if (paginated.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #666;">
        <i class="fas fa-inbox" style="font-size: 3em; margin-bottom: 15px; opacity: 0.5;"></i>
        <h4>Aucune activité récente</h4>
        <p>Les nouvelles ressources et quiz partagés apparaîtront ici</p>
      </div>
    `;
    document.getElementById('activities-pagination').innerHTML = '';
    return;
  }
  
  container.innerHTML = paginated.map(activity => {
    const typeClass = getActivityTypeClass(activity.ressource_type, activity.notification_type);
    const typeLabel = getResourceTypeLabel(activity.ressource_type, activity.notification_type);
    const icon = getActivityIcon(activity.ressource_type, activity.notification_type);
    
    return `
      <div class="activity-item ${typeClass}" 
           onclick="navigateToResource('${activity.ressource_type}', ${activity.ressource_id}, '${activity.notification_type}')">
        <div class="activity-icon">${icon}</div>
        <div class="activity-content">
          <div class="activity-message">${activity.message}</div>
          <div class="activity-meta">
            <span>${formatTimeAgo(activity.created_at)}</span>
            <span class="activity-type">${typeLabel}</span>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  renderActivitiesPagination(totalPages, page);
}

function getActivityTypeClass(resourceType, notificationType) {
  if (notificationType === 'quiz') {
    if (resourceType === 'quiz') return 'activity-quiz';
    if (resourceType === 'flashcard') return 'activity-flashcard';
  }
  
  if (resourceType === 'youtube') return 'activity-youtube';
  if (['mp4','mov','avi','mkv','webm'].includes(resourceType)) return 'activity-video';
  if (resourceType === 'pdf') return 'activity-pdf';
  if (['png','jpg','jpeg','gif'].includes(resourceType)) return 'activity-image';
  if (['doc','docx'].includes(resourceType)) return 'activity-document';
  return 'activity-document';
}

function getResourceTypeLabel(resourceType, notificationType) {
  if (notificationType === 'quiz') {
    if (resourceType === 'quiz') return 'Quiz';
    if (resourceType === 'flashcard') return 'Flashcards';
  }
  
  const types = {
    'youtube': 'YouTube',
    'mp4': 'Vidéo', 'mov': 'Vidéo', 'avi': 'Vidéo', 'mkv': 'Vidéo', 'webm': 'Vidéo',
    'pdf': 'PDF',
    'png': 'Image', 'jpg': 'Image', 'jpeg': 'Image', 'gif': 'Image',
    'doc': 'Word', 'docx': 'Word'
  };
  return types[resourceType] || 'Fichier';
}

function getActivityIcon(resourceType, notificationType) {
  if (notificationType === 'quiz') {
    if (resourceType === 'quiz') return '📝';
    if (resourceType === 'flashcard') return '🎴';
  }
  
  if (resourceType === 'youtube') return '📹';
  if (['mp4','mov','avi','mkv','webm'].includes(resourceType)) return '🎥';
  if (resourceType === 'pdf') return '📄';
  if (['png','jpg','jpeg','gif'].includes(resourceType)) return '🖼️';
  if (['doc','docx'].includes(resourceType)) return '📝';
  return '📁';
}

function navigateToResource(resourceType, resourceId, notificationType = '') {
  console.log('Navigation vers ressource:', resourceType, resourceId, notificationType);
  
  // Marquer comme lu selon le type
  if (notificationType === 'quiz') {
    fetch(`/api/quiz_notifications/read/${resourceId}`, { method: 'POST' })
      .then(() => {
        console.log('Notification quiz marquée comme lue');
        loadActivities(); // Recharger les activités
      })
      .catch(err => console.error('Erreur marquage quiz comme lu:', err));
  } else {
    const activity = allActivities.find(a => a.ressource_id === resourceId && !a.notification_type);
    if (activity && !activity.is_read) {
      fetch(`/api/notifications/read/${activity.id}`, { method: 'POST' })
        .then(() => {
          console.log('Notification marquée comme lue');
        })
        .catch(err => console.error('Erreur marquage comme lu:', err));
    }
  }
  
  // Rediriger selon le type de ressource
  if (notificationType === 'quiz') {
    // Rediriger vers la page quiz/flashcards avec l'ID spécifique
    if (resourceType === 'quiz') {
      window.location.href = `/quiz_flashcards#quiz-${resourceId}`;
    } else if (resourceType === 'flashcard') {
      window.location.href = `/quiz_flashcards#flashcard-${resourceId}`;
    } else {
      window.location.href = `/quiz_flashcards`;
    }
  } else if (resourceType === 'youtube' || ['mp4','mov','avi','mkv','webm'].includes(resourceType)) {
    window.location.href = `/videos#video-${resourceId}`;
  } else {
    window.location.href = `/communaute#ressource-${resourceId}`;
  }
}

function renderActivitiesPagination(totalPages, currentPage) {
  const container = document.getElementById('activities-pagination');
  if (totalPages <= 1) {
    container.innerHTML = '';
    return;
  }
  
  let html = '<div class="pagination">';
  
  // Bouton précédent
  if (currentPage > 1) {
    html += `<button onclick="changeActivitiesPage(${currentPage - 1})">&laquo; Précédent</button>`;
  }
  
  // Pages
  const maxVisible = 5;
  let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
  let endPage = Math.min(totalPages, startPage + maxVisible - 1);
  
  if (endPage - startPage + 1 < maxVisible) {
    startPage = Math.max(1, endPage - maxVisible + 1);
  }
  
  for (let i = startPage; i <= endPage; i++) {
    if (i === currentPage) {
      html += `<span class="current-page">${i}</span>`;
    } else {
      html += `<button onclick="changeActivitiesPage(${i})">${i}</button>`;
    }
  }
  
  // Bouton suivant
  if (currentPage < totalPages) {
    html += `<button onclick="changeActivitiesPage(${currentPage + 1})">Suivant &raquo;</button>`;
  }
  
  html += '</div>';
  container.innerHTML = html;
}

function changeActivitiesPage(page) {
  currentActivitiesPage = page;
  const filter = document.getElementById('dateFilter').value;
  const customDate = document.getElementById('customDate').value;
  loadActivities(filter, customDate);
  
  // Scroll vers le haut de la liste
  document.getElementById('activities-list').scrollTo(0, 0);
}

// Fonction formatTimeAgo (identique à celle de base.html)
function formatTimeAgo(dateStr) {
  const now = new Date();
  const date = new Date(dateStr);
  const diffSec = Math.floor((now - date) / 1000);
  
  if (diffSec < 60) return "à l'instant";
  if (diffSec < 3600) {
    const m = Math.floor(diffSec / 60);
    return `il y a ${m} minute${m > 1 ? 's' : ''}`;
  }
  if (diffSec < 86400) {
    const h = Math.floor(diffSec / 3600);
    return `il y a ${h} heure${h > 1 ? 's' : ''}`;
  }
  if (diffSec < 604800) {
    const d = Math.floor(diffSec / 86400);
    return `il y a ${d} jour${d > 1 ? 's' : ''}`;
  }
  return date.toLocaleDateString('fr-FR');
}

// Initialisation des activités
document.addEventListener('DOMContentLoaded', function() {
  console.log('Initialisation des activités...');
  
  // Vérifier si on est sur la page de profil et dans l'onglet overview
  if (document.getElementById('activities-list') && document.getElementById('overview').classList.contains('active')) {
    console.log('Chargement des activités...');
    loadActivities();
    
    // Écouter les changements de filtre
    const dateFilter = document.getElementById('dateFilter');
    if (dateFilter) {
      dateFilter.addEventListener('change', function(e) {
        currentActivitiesPage = 1;
        if (e.target.value === 'custom') {
          document.getElementById('customDate').style.display = 'block';
        } else {
          document.getElementById('customDate').style.display = 'none';
          loadActivities(e.target.value);
        }
      });
    }
    
    const customDate = document.getElementById('customDate');
    if (customDate) {
      customDate.addEventListener('change', function(e) {
        currentActivitiesPage = 1;
        loadActivities('custom', e.target.value);
      });
    }
  }
  
  // Recharger les activités quand on change d'onglet
  const tabs = document.querySelectorAll(".tab");
  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      setTimeout(() => {
        if (document.getElementById('overview').classList.contains('active')) {
          console.log('Onglet overview activé - rechargement activités');
          loadActivities();
        }
      }, 100);
    });
  });
});

// Recharger aussi quand on arrive sur la page avec le hash #overview
window.addEventListener('hashchange', function() {
  if (window.location.hash === '#overview') {
    setTimeout(() => {
      console.log('Hash changé vers overview - rechargement activités');
      loadActivities();
    }, 500);
  }
});

// Recharger au chargement si hash #overview
if (window.location.hash === '#overview') {
  setTimeout(() => {
    console.log('Page chargée avec hash overview - rechargement activités');
    loadActivities();
  }, 1000);
}

//champ autre pour la filiere
function toggleCustomField() {
    const fieldSelect = document.getElementById('field');
    const customContainer = document.getElementById('customFieldContainer');
    
    if (fieldSelect.value === 'autre') {
        customContainer.style.display = 'block';
    } else {
        customContainer.style.display = 'none';
    }
}

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', function() {
    toggleCustomField();
});

function shareRessourceFromProfile() {
    // Marquer qu'on veut ouvrir le formulaire
    sessionStorage.setItem('openShareForm', 'true');
    
    // Rediriger
    window.location.href = "{{ url_for('communaute') }}";
}
  </script>

{%endblock%}
