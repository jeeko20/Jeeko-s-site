{% extends 'base.html' %}
{% block title %}Communaut√© | Univloop{% endblock %}
{% block description %}Rejoins la communaut√© Univloop et √©change avec d'autres utilisateurs.{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/communaute.css') }}">
<style>
  .modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background: white !important;
    color: black !important;
    padding: 20px;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .close {
    float: right;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    color: #555;
  }
  .close:hover {
    color: #000;
  }

  /* Pagination style */
  .pagination {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin: 20px 0;
    flex-wrap: wrap;
  }
  .pagination button {
    padding: 6px 12px;
    border: 1px solid #ccc;
    background: #f8f9fa;
    cursor: pointer;
    border-radius: 4px;
  }
  .pagination button:hover {
    background: #e9ecef;
  }
  .current-page {
    padding: 6px 12px;
    background: #007bff;
    color: white;
    border-radius: 4px;
  }

  /* Reprise du style note.html pour les cartes de ressources */
  .ressources-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 24px;
    padding: 20px 0;
    align-items: start;
  }

  .ressources-list {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    height: 520px; /* fixe pour uniformit√© */
    overflow: hidden;
  }

  .ressource-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 18px 18px 12px;
    flex-shrink: 0;
  }

  .ressource-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #f0f0f0;
    flex-shrink: 0;
  }

  .ressource-title {
    font-size: 1.1em;
    font-weight: 600;
    margin: 0;
    color: #212529;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.3;
  }

  .ressource-meta-container {
    padding: 0 18px 12px;
    flex-shrink: 0;
  }

  .ressource-meta {
    display: flex;
    justify-content: space-between;
    font-size: 0.85em;
    color: #6c757d;
    flex-wrap: wrap;
    gap: 8px;
  }

  .ressource-subject {
    background: #e9ecef;
    padding: 2px 10px;
    border-radius: 20px;
    font-weight: 500;
    white-space: nowrap;
  }

  .ressource-media {
    flex: 1; /* prend l'espace restant */
    margin: 0 18px;
    border-radius: 8px;
    overflow: hidden;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  .ressource-media img,
  .ressource-media video {
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: white;
  }

  .ressource-media .icon-placeholder {
    text-align: center;
    color: #6c757d;
    padding: 20px;
  }
  .ressource-media .icon-placeholder i {
    font-size: 3em;
    margin-bottom: 12px;
    color: #007bff;
  }

  .ressource-actions {
    display: flex;
    gap: 10px;
    padding: 12px 18px 18px;
    border-top: 1px solid #eee;
    flex-shrink: 0;
  }

  .ressource-actions button {
    flex: 1;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
  }

  .btn-view { background: #007bff; color: white; }
  .btn-view:hover { background: #0069d9; }
  .btn-download { background: #28a745; color: white; }
  .btn-download:hover { background: #218838; }

  @media (max-width: 768px) {
    .ressources-grid { grid-template-columns: 1fr; gap: 16px; }
    .ressources-list { height: 480px; }
  }
  /* Styles pour l'ic√¥ne de sauvegarde */
.ressource-header {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 18px 18px 12px;
  flex-shrink: 0;
  position: relative; /* Pour positionner l'ic√¥ne de sauvegarde */
}

.save-icon {
  position: absolute;
  top: 15px;
  right: 15px;
  cursor: pointer;
  font-size: 1.2em;
  z-index: 2;
}

.save-icon .fa-regular {
  color: #ccc;
}

.save-icon .fa-solid {
  color: #007bff;
}

  /* Am√©liore la lisibilit√© du lien 'Partager une ressource' en clair et sombre */
  .action-rapide .share-ressource {
    cursor: pointer;
    color: #212529; /* texte fonc√© par d√©faut */
    font-weight: 600;
  }
  .action-rapide .share-ressource:hover {
    text-decoration: underline;
    color: #0b5ed7;
  }

  /* Si l'utilisateur a un th√®me sombre, forcer une couleur claire pour une bonne lisibilit√© */
  @media (prefers-color-scheme: dark) {
    .action-rapide .share-ressource {
      color: #ffffff; /* blanc pur pour bonne lisibilit√© en dark */
      text-shadow: 0 1px 2px rgba(0,0,0,0.6);
    }
    .action-rapide .share-ressource:hover {
      color: #ffffff;
      opacity: 0.92;
    }
  }

.ressource-title {
  font-size: 1.1em;
  font-weight: 600;
  margin: 0;
  color: #212529;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.3;
  flex: 1;
  padding-right: 30px; /* Espace pour l'ic√¥ne de sauvegarde */
}

/* Version alternative plus simple */
#comment-modal .modal-content {
    max-height: 80vh;
    display: flex;
    flex-direction: column;
}

#comments-list {
    height: 300px; /* Hauteur fixe */
    overflow-y: auto;
    margin: 15px 0;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #f9f9f9;
}

.comment-item {
    padding: 10px;
    margin-bottom: 10px;
    background: white;
    border-radius: 4px;
    border-left: 3px solid #007bff;
}
</style>
{% endblock %}

{% block content %}
<!-- ================= HEADER ================= -->
<header class="header">
  <div class="header-content">
    <h1>Communaut√© d'Univloop</h1>
    <p>Echangez, discutez et partagez vos connaissances avec la communaut√©</p>
  </div>
  <!-- Navigation -->
  <nav>
    <button class="tab active" data-page="discussion">
      <i class="fas fa-chart-line"></i> Discussion
    </button>
    <button class="tab" data-page="partages">
      <i class="fas fa-folder-open"></i> Partages recentes
    </button>
  <!-- global view removed -->
    <button class="tab" onclick="window.location.href='/videos'" 
    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
<i class="fas fa-video"></i> Vid√©os
</button>
  </nav>
</header>

<main>
  <!-- Section DISCUSSION -->
  <section id="discussion" class="page active">
    <div class="discussion">
      <div class="info-discussion">
        <div class="start-discussion">
          <h2>Nouvelle discussion</h2>
          <div id="area-1">
            <img src="{{ current_user.avatar_url or 'https://cdn.pixabay.com/photo/2024/06/22/22/55/man-8847064_640.jpg' }}" alt="photo">
            <form id="new-discussion-form" class="form-control">
              <textarea id="discussion-content" required placeholder="Poser une question ou commencer une discussion"></textarea>
              <div id="area-3">
                <select id="discussion-subject" required>
                  <option value="">-- Choisir une mati√®re --</option>
                  <option value="C++">C++</option>
                  <option value="HTML">HTML</option>
                  <option value="CSS">CSS</option>
                  <option value="Javascript">Javascript</option>
                  <option value="Algorithme">Algorithme</option>
                  <option value="autre">Autre (pr√©cisez)</option>
                </select>
                <input type="text" id="autre-subject" placeholder="Pr√©cisez la mati√®re" style="display: none; margin-top: 8px; width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                  <button type="submit">Publier</button>
                </div>
              </div>
            </form>
          </div>
        </div>

        <!-- Barre de recherche et tri -->
        <div style="margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap; align-items: end;">
          <div style="flex: 1; min-width: 200px;">
            <input type="text" id="search-discussions" placeholder="Rechercher une discussion..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          </div>
          <div style="min-width: 150px;">
            <select id="sort-discussions" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
              <option value="date">Plus r√©cent</option>
              <option value="likes">Populaires</option>
              <option value="subject">Par mati√®re</option>
            </select>
          </div>
        </div>

        <!-- Discussions dynamiques -->
        <div id="discussions-container">
          <!-- Charg√© par JavaScript -->
        </div>
        <div id="discussions-pagination"></div> <!-- ‚úÖ Pagination ici -->
      </div>

      <!-- Colonne droite -->
      <div class="block-2">
        <div data-aos="fade-left" class="action-rapide">
          <h2 data-aos="zoom-in">Actions rapides</h2>
          <ul>
            <li data-aos="zoom-in" class="share-ressource">Partager une ressource</li>
            <li data-aos="zoom-in"><a href="#" style="color: black; text-decoration: none;">Poser une question</a></li>
            <li data-aos="zoom-in" class="join-group" onclick="window.location.href='/quiz_flashcards'">Voir les Quiz / Flashcards</li>
          </ul>
        </div>

        <div data-aos="fade-left" class="sujet-populaire">
          <h2 data-aos="zoom-in">Sujets populaires</h2>
          <ul>
            <li data-aos="zoom-in"><span>Optimisation C++</span><span>24</span></li>
            <li data-aos="zoom-in"><span>CSS Grid</span><span>18</span></li>
            <li data-aos="zoom-in"><span>Algorithme de tri</span><span>15</span></li>
            <li data-aos="zoom-in"><span>Gestion m√©moire</span><span>12</span></li>
            <li data-aos="zoom-in"><span>JavaScript async</span><span>10</span></li>
          </ul>
        </div>

        <div class="statistique">
          <h2>Statistiques</h2>
          <ul>
            <li><span>Membres actifs</span><span id="active-users">‚Äî</span></li>
            <li><span>Discussions ouvertes</span><span id="total-discussions">‚Äî</span></li>
            <li><span>Ressources partag√©es</span><span id="total-ressources">‚Äî</span></li>
            <li><span>Messages aujourd'hui</span><span>12</span></li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal pour les commentaires -->
  <div id="comment-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3 id="modal-title">Commentaires</h3>
      <!-- Indicator when replying to a specific comment -->
      <div id="reply-indicator" style="display:none; margin-bottom:8px; padding:8px; background:#fff3e0; border-radius:6px; border:1px solid #ffd6a5;">
        <small>En r√©ponse √† <strong id="reply-to-name"></strong></small>
        <button id="cancel-reply" style="float:right; background:none; border:none; color:#007bff; cursor:pointer;">Annuler la r√©ponse</button>
      </div>
      <div id="comments-list"></div>
      <form id="comment-form" style="margin-top:15px;">
        <textarea id="comment-input" placeholder="√âcrivez un commentaire..." required style="width:100%; height:60px; padding:8px; border:1px solid #ccc; border-radius:4px;"></textarea>
        <button type="submit" style="margin-top:8px; padding:6px 12px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer;">Envoyer</button>
      </form>
    </div>
  </div>

  <!-- Section PARTAGES -->
  <section id="partages" class="page">
    <div class="discussion">
      <div class="info-discussion">
        <!-- Menu de tri et recherche -->
        <div class="tri-bar">
          <label for="sort">Trier par :</label>
          <select id="sort">
            <option value="date-desc">Date (r√©cent ‚Üí ancien)</option>
            <option value="date-asc">Date (ancien ‚Üí r√©cent)</option>
            <option value="file_type-asc">Type (A-Z)</option>
            <option value="file_type-desc">Type (Z-A)</option>
            <option value="likes-desc">Likes (plus aim√©s)</option>
          </select>
          <div>
            <input type="text" id="search" placeholder="Rechercher un titre ou un sujet...">
          </div>
        </div>

        <!-- Liste dynamique -->
        <!-- IMPORTANT: Le rendu des ressources (grid de cartes) est maintenant g√©r√© par renderPaginated + renderRessources -->
        <div id="ressource-list-wrapper">
          <div id="ressource-list"></div>
          <div id="ressources-pagination"></div> <!-- Pagination plac√©e ici -->
        </div>
      </div>

      <!-- Colonne droite -->
      <div class="block-2">
        <div class="action-rapide">
          <h2>Actions rapides</h2>
          <ul>
            <li class="share-ressource">Partager une ressource</li>
            <li><a href="{{ url_for('communaute') }}" style="color: black; text-decoration: none;">Poser une question</a></li>
            <li class="join-group">Rejoindre un groupe</li>
          </ul>
        </div>

        <div class="sujet-populaire">
          <h2>Sujets populaires</h2>
          <ul>
            <li><span>Optimisation C++</span><span>24</span></li>
            <li><span>CSS Grid</span><span>18</span></li>
            <li><span>Algorithme de tri</span><span>15</span></li>
            <li><span>Gestion m√©moire</span><span>12</span></li>
            <li><span>JavaScript async</span><span>10</span></li>
          </ul>
        </div>

        <div class="statistique">
          <h2>Statistiques</h2>
          <ul>
            <li><span>Membres actifs</span><span>24</span></li>
            <li><span>Discussions ouvertes</span><span>18</span></li>
            <li><span>Ressources partag√©es</span><span>15</span></li>
            <li><span>Messages aujourd'hui</span><span>12</span></li>
          </ul>
        </div>
      </div>
    </div>
  </section>
</main>

<div id="modal-overlay" class="modal-overlay" style="display:none;">
<form id="form-partage" class="form-partage" method="post" action="{{ url_for('share_ressource') }}" enctype="multipart/form-data">
  <label for="titre">Titre:</label>
  <input type="text" id="titre" name="titre" placeholder="Le titre du document" required />

  <label for="MYmatiere">Mati√®re :</label>
  <select id="MYmatiere" name="matiere" required>
    <option value="">-- S√©lectionnez --</option>
    <option value="JavaScript">JavaScript</option>
    <option value="HTML">HTML</option>
    <option value="C++">C++</option>
    <option value="CSS">CSS</option>
    <option value="Syst√®mes">Syst√®me</option>
    <option value="autre">Autre (pr√©cisez)</option>
  </select>
  <input type="text" id="autre-matiere" name="autre_matiere" placeholder="Pr√©cisez la mati√®re" style="display: none; margin-top: 8px; width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">

  <label for="file">Fichier(s) (images, pdf, vid√©o) :</label>
  <input type="file" id="file" name="files" accept=".png,.jpg,.jpeg,.gif,.pdf,.doc,.docx,.mp4,.mov,.avi,.mkv" multiple required>

  <div class="bbtn">
    <button type="submit">Publier</button>
    <button type="button" onclick="fermerFormulaire()">Annuler</button>
  </div>
  <!-- üîµ Nouveau bouton pour YouTube (vid√©os lourdes) -->
  <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
    <p><strong>üé• Vid√©o trop lourde ?</strong> (plus de 100 Mo)</p>
    <a href="{{ url_for('youtube_auth') }}" class="btn btn-primary" style="text-decoration: none; display: inline-block; padding: 8px 16px; background: #ff0000; color: white; border-radius: 4px;">
      üì§ Uploader sur YouTube
    </a>
    <p style="font-size: 0.9em; margin-top: 8px; color: #555;">
      Votre vid√©o sera upload√©e sur <strong>votre propre cha√Æne YouTube</strong> et affich√©e ici.
    </p>
  </div>
</form>
</div>
{% endblock %}

{% block script %}
<script>
  // =============== CONFIGURATION ===============
  const ITEMS_PER_PAGE = 10;
  
  // Variables globales pour la pagination
  let ressources = [];
  let filteredRessources = [];
  let currentPageRessources = 1;
  
  let allDiscussions = [];
  let currentPageDiscussions = 1;
  let currentDiscussionId = null;

  // =============== FONCTIONS POUR LE SCROLL VERS RESSOURCE ===============
  function handleNotificationClick(notificationId, ressourceType, ressourceId) {
    console.log('Clic sur notification:', notificationId, ressourceType, ressourceId);
    
    // Marquer comme lu
    fetch(`/api/notifications/read/${notificationId}`, { method: 'POST' })
      .then(() => {
        console.log('Notification marqu√©e comme lue');
      })
      .catch(err => console.error('Erreur marquage comme lu:', err));
    
    // Rediriger selon le type de ressource
    if (ressourceType === 'youtube' || ['mp4','mov','avi','mkv','webm'].includes(ressourceType)) {
      window.location.href = `/videos#video-${ressourceId}`;
    } else {
      redirectToRessource(ressourceId);
    }
  }

  function redirectToRessource(ressourceId) {
    console.log('Redirection vers ressource:', ressourceId);
    
    // Stocker l'ID pour le scroll apr√®s chargement
    sessionStorage.setItem('targetRessourceId', ressourceId);
    
    if (window.location.pathname === '/communaute') {
      // Si d√©j√† sur la page, forcer le rechargement et scroll
      window.location.href = `/communaute#ressource-${ressourceId}`;
      setTimeout(() => {
        scrollToRessource(ressourceId);
      }, 1000);
    } else {
      // Sinon aller sur la page
      window.location.href = `/communaute#ressource-${ressourceId}`;
    }
  }

  function scrollToRessource(ressourceId) {
    console.log('Scroll vers ressource:', ressourceId);
    
    // S'assurer qu'on est sur le bon onglet
    const partagesTab = document.querySelector('[data-page="partages"]');
    if (partagesTab && !partagesTab.classList.contains('active')) {
      partagesTab.click();
      console.log('Changement vers onglet partages');
    }
    
    // Attendre que l'onglet soit charg√©
    setTimeout(() => {
      const maxAttempts = 10;
      let attempts = 0;
      
      const tryScroll = setInterval(() => {
        attempts++;
        const targetElement = document.querySelector(`.ressources-list[data-ressource-id="${ressourceId}"]`);
        console.log('Tentative', attempts, '√©l√©ment trouv√©:', targetElement);
        
        if (targetElement) {
          clearInterval(tryScroll);
          
          // Scroll vers l'√©l√©ment
          targetElement.scrollIntoView({ 
            behavior: 'smooth',
            block: 'center'
          });
          
          // Effet visuel
          targetElement.style.transition = 'all 0.5s ease';
          targetElement.style.border = '3px solid blueviolet';
          targetElement.style.borderRadius = '10px';
          targetElement.style.padding = '5px';
          
          setTimeout(() => {
            targetElement.style.boxShadow = '0 0 20px rgba(138, 43, 226, 0.5)';
          }, 300);
          
          setTimeout(() => {
            targetElement.style.boxShadow = '0 0 10px rgba(138, 43, 226, 0.3)';
          }, 1500);
          
          setTimeout(() => {
            targetElement.style.border = '';
            targetElement.style.boxShadow = '';
            targetElement.style.padding = '';
          }, 4000);
          
          console.log('Scroll r√©ussi vers ressource', ressourceId);
        } else if (attempts >= maxAttempts) {
          clearInterval(tryScroll);
          console.log('√âchec scroll - ressource non trouv√©e apr√®s', maxAttempts, 'tentatives');
        }
      }, 300);
    }, 500);
  }

  function handleHashOnLoad() {
    const hash = window.location.hash;
    console.log('Hash au chargement:', hash);
    
    if (hash && hash.startsWith('#ressource-')) {
      const ressourceId = hash.replace('#ressource-', '');
      console.log('Ressource ID depuis hash:', ressourceId);
      
      // Attendre un peu puis scroller
      setTimeout(() => {
        scrollToRessource(ressourceId);
      }, 1000);
    }
    
    // V√©rifier aussi le sessionStorage
    const storedRessourceId = sessionStorage.getItem('targetRessourceId');
    if (storedRessourceId) {
      console.log('Ressource ID depuis sessionStorage:', storedRessourceId);
      setTimeout(() => {
        scrollToRessource(storedRessourceId);
        sessionStorage.removeItem('targetRessourceId');
      }, 1500);
    }
  }

  // =============== CHARGEMENT DES RESSOURCES ===============
  async function loadRessources() {
    try {
  const res = await fetch('/api/ressources');
  ressources = await res.json();
        
        // üî• REGROUPEMENT DES RESSOURCES
        ressources = groupRessourcesByTitle(ressources);
        
        filteredRessources = [...ressources];
        
        // Mettre √† jour compteur
        document.getElementById('total-ressources').textContent = ressources.length || 0;

        // Afficher la premi√®re page
        renderPaginatedRessources(filteredRessources, currentPageRessources);
        
        // Apr√®s chargement, v√©rifier si on doit scroller
        setTimeout(handleHashOnLoad, 500);
    } catch (err) {
        console.error('Erreur loadRessources:', err);
        document.getElementById('ressource-list').innerHTML = '<p style="color:red; text-align:center;">Erreur lors du chargement des ressources.</p>';
    }
}

  // =============== FONCTIONS DE RENDU POUR RESSOURCES ===============
  function renderPaginatedRessources(list, page) {
    currentPageRessources = page;
    const totalPages = Math.ceil(list.length / ITEMS_PER_PAGE);
    const start = (page - 1) * ITEMS_PER_PAGE;
    const paginated = list.slice(start, start + ITEMS_PER_PAGE);

    // Rendu des cartes
    renderRessources(paginated, 'ressource-list');

    // Rendu de la pagination
    renderPagination(totalPages, page, (newPage) => {
      renderPaginatedRessources(list, newPage);
    }, 'ressources-pagination');
  }

  function renderRessources(list, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    if (list.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding:30px; color:#777; font-size:1.1em;">Aucune ressource.</p>';
        return;
    }

    container.innerHTML = '<div class="ressources-grid"></div>';
    const grid = container.querySelector('.ressources-grid');

    list.forEach(r => {
        const date = new Date(r.created_at).toLocaleDateString('fr-FR');
        
        // √âtat de sauvegarde
        const isSaved = r.is_saved || false;
        const bookmarkIconClass = isSaved ? 'fa-solid fa-bookmark' : 'fa-regular fa-bookmark';
        const bookmarkColor = isSaved ? '#007bff' : '#ccc';

        // üî• AFFICHAGE INTELLIGENT (CAROUSEL OU SIMPLE)
        let mediaHtml = '';
        if (r.is_multiple) {
            mediaHtml = `
                <div class="ressource-media">
                    ${createCarouselHtml(r.files, r.id)}
                </div>`;
        } else {
            const singleFile = r.files[0];
            mediaHtml = `
                <div class="ressource-media">
                    ${createSingleMediaHtml(singleFile, r.id, false)}
                </div>`;
        }

        grid.innerHTML += `
            <div class="ressources-list" data-ressource-id="${r.id}">
                <div class="ressource-header">
                    <img src="${r.user_avatar}" 
                         alt="Avatar" 
                         class="ressource-avatar"
                         loading="lazy"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9Ijc1IiB5PSI3NSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSI+QXZhdGFyPC90ZXh0Pjwvc3ZnPg=='">
                    <h3 class="ressource-title">${r.title}</h3>
                    <div class="save-icon" onclick="toggleSaveRessource(${r.id}, this)">
                        <i class="${bookmarkIconClass}" style="color: ${bookmarkColor};"></i>
                    </div>
                </div>
                
                <div class="ressource-meta">
                    <span class="ressource-subject">${r.subject}</span>
                    <span>par ${r.username || 'Utilisateur'}</span>
                </div>

                ${mediaHtml}

                <div class="ressource-meta">
                    <span>${date}</span>
                    <span>${r.files[0].page_count ? r.files[0].page_count + ' pages' : '‚Äî'}</span>
                </div>

                <div class="ressource-actions">
                    ${r.files[0].is_video ? `
                        <button class="btn-view" onclick="window.location.href='/videos#video-${r.id}'" style="background: #667eea;">
                            <i class="fa-solid fa-video"></i> Voir la vid√©o
                        </button>
                    ` : `
                        <button class="btn-view" onclick="window.open('${r.files[0].file_url}', '_blank')">
                            <i class="fa-solid fa-eye"></i> Voir
                        </button>
                    `}
          <button class="btn-download" onclick="downloadRessource(${r.id})">
                        <i class="fa-solid fa-download"></i> T√©l√©charger
                    </button>
                </div>
        <div style="margin-top:8px;">
          ${window.CURRENT_USER_ID && window.CURRENT_USER_ID === r.user_id ? `<button class="btn-delete-ressource" data-ressource-id="${r.id}" style="background:none; border:none; color:#d9534f; cursor:pointer; padding:6px 0;">Supprimer la ressource</button>` : ''}
        </div>
            </div>`;
    });

    // Initialiser les carousels apr√®s le rendu
    setTimeout(initializeCarousels, 100);
}

// Wire delete ressource actions (delegated since elements may be re-rendered)
document.addEventListener('click', function(e) {
    const delDisc = e.target.closest('.btn-delete-discussion');
    if (delDisc) {
      const id = delDisc.dataset.discussionId;
      if (!confirm('Supprimer cette discussion ?')) return;
      fetch(`/api/discussion/${id}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            loadAllDiscussions();
          } else {
            alert(data.error || 'Impossible de supprimer la discussion');
          }
        }).catch(() => alert('Erreur r√©seau'));
      return;
    }
  const del = e.target.closest('.btn-delete-ressource');
  if (!del) return;
  const id = del.dataset.ressourceId;
  if (!confirm('Supprimer cette ressource ?')) return;
  fetch(`/api/ressource/${id}`, { method: 'DELETE' })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        // Reload ressources list
        loadRessources();
      } else {
        alert(data.error || 'Impossible de supprimer la ressource');
      }
    }).catch(() => alert('Erreur r√©seau'));
});

  
  // =============== FONCTION DE SAUVEGARDE ===============
  function toggleSaveRessource(ressourceId, element) {
    const icon = element.querySelector('i');
    const isCurrentlySaved = icon.classList.contains('fa-solid');

    const url = isCurrentlySaved 
      ? `/api/unsave_ressource/${ressourceId}` 
      : `/api/save_ressource/${ressourceId}`;

    fetch(url, { method: 'POST' })
      .then(response => response.json())
      .then(data => {
        if (data.saved) {
          icon.className = 'fa-solid fa-bookmark';
          icon.style.color = '#007bff';
          const ressource = ressources.find(r => r.id === ressourceId);
          if (ressource) ressource.is_saved = true;
        } else {
          icon.className = 'fa-regular fa-bookmark';
          icon.style.color = '#ccc';
          const ressource = ressources.find(r => r.id === ressourceId);
          if (ressource) ressource.is_saved = false;
        }
      })
      .catch(err => {
        console.error('Erreur:', err);
        alert('Impossible de sauvegarder.');
      });
  }

  // =============== PAGINATION ===============
  function renderPagination(totalPages, currentPage, onPageChange, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    if (totalPages <= 1) {
      container.innerHTML = '';
      return;
    }

    let html = '<div class="pagination">';
    if (currentPage > 1) {
      html += `<button onclick="pageChangeHandler(${currentPage - 1}, '${containerId}')">&laquo; Pr√©c√©dent</button>`;
    }

    const maxVisible = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = Math.min(totalPages, startPage + maxVisible - 1);
    
    if (endPage - startPage + 1 < maxVisible) {
      startPage = Math.max(1, endPage - maxVisible + 1);
    }

    for (let i = startPage; i <= endPage; i++) {
      if (i === currentPage) {
        html += `<span class="current-page">${i}</span>`;
      } else {
        html += `<button onclick="pageChangeHandler(${i}, '${containerId}')">${i}</button>`;
      }
    }

    if (currentPage < totalPages) {
      html += `<button onclick="pageChangeHandler(${currentPage + 1}, '${containerId}')">Suivant &raquo;</button>`;
    }

    html += '</div>';
    container.innerHTML = html;
    container._pageChangeCallback = onPageChange;
  }

  function pageChangeHandler(page, containerId) {
    const container = document.getElementById(containerId);
    if (container && container._pageChangeCallback) {
      container._pageChangeCallback(page);
    }
  }

  // =============== TRI & RECHERCHE ===============
  document.getElementById('sort')?.addEventListener('change', (e) => {
    currentPageRessources = 1;
    const v = e.target.value;
    if (!ressources) return;
    
    filteredRessources = [...ressources];
    
    if (v === 'date-desc') {
      filteredRessources.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    } else if (v === 'date-asc') {
      filteredRessources.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
    } else if (v === 'file_type-asc') {
      filteredRessources.sort((a, b) => (a.file_type || '').localeCompare(b.file_type || ''));
    } else if (v === 'file_type-desc') {
      filteredRessources.sort((a, b) => (b.file_type || '').localeCompare(a.file_type || ''));
    } else if (v === 'likes-desc') {
      filteredRessources.sort((a, b) => (b.likes || 0) - (a.likes || 0));
    }
    
    renderPaginatedRessources(filteredRessources, currentPageRessources);
  });

  document.getElementById('search')?.addEventListener('input', (e) => {
    currentPageRessources = 1;
    const term = e.target.value.toLowerCase();
    filteredRessources = ressources.filter(r =>
      (r.title || '').toLowerCase().includes(term) ||
      (r.subject || '').toLowerCase().includes(term) ||
      (r.file_type || '').toLowerCase().includes(term)
    );
    renderPaginatedRessources(filteredRessources, currentPageRessources);
  });

  // =============== DISCUSSIONS ===============
  function formatTimeAgo(dateStr) {
    const now = new Date();
    const date = new Date(dateStr);
    const diffSec = Math.floor((now - date) / 1000);
    if (diffSec < 60) return "√† l'instant";
    if (diffSec < 3600) {
      const m = Math.floor(diffSec / 60);
      return `il y a ${m} minute${m > 1 ? 's' : ''}`;
    }
    if (diffSec < 86400) {
      const h = Math.floor(diffSec / 3600);
      return `il y a ${h} heure${h > 1 ? 's' : ''}`;
    }
    if (diffSec < 604800) {
      const d = Math.floor(diffSec / 86400);
      return `il y a ${d} jour${d > 1 ? 's' : ''}`;
    }
    return date.toLocaleDateString('fr-FR');
  }

  function sortDiscussions(discussions, sortBy) {
    return [...discussions].sort((a, b) => {
      if (sortBy === 'likes') return b.likes - a.likes;
      if (sortBy === 'subject') return a.subject.localeCompare(b.subject);
      return new Date(b.created_at) - new Date(a.created_at);
    });
  }

  function filterDiscussions(discussions, query) {
    if (!query) return discussions;
    const q = query.toLowerCase();
    return discussions.filter(d =>
      (d.title || '').toLowerCase().includes(q) ||
      (d.content || '').toLowerCase().includes(q) ||
      (d.subject || '').toLowerCase().includes(q)
    );
  }

  function renderDiscussions(discussions) {
    const container = document.getElementById('discussions-container');
    const totalPages = Math.ceil(discussions.length / ITEMS_PER_PAGE);
    const start = (currentPageDiscussions - 1) * ITEMS_PER_PAGE;
    const paginated = discussions.slice(start, start + ITEMS_PER_PAGE);

    if (discussions.length === 0) {
      container.innerHTML = '<p style="text-align:center; color:#777; padding:20px;">Aucune discussion trouv√©e.</p>';
      document.getElementById('discussions-pagination').innerHTML = '';
      return;
    }

    container.innerHTML = '';
    paginated.forEach(d => {
      const timeAgo = formatTimeAgo(d.created_at);
      const el = document.createElement('div');
      el.className = 'discussion-list';
      el.innerHTML = `
        <div class="discussion-head">
          <img src="${d.user_avatar || 'https://cdn.pixabay.com/photo/2024/06/22/22/55/man-8847064_640.jpg'}" alt="avatar" onerror="this.src='https://cdn.pixabay.com/photo/2024/06/22/22/55/man-8847064_640.jpg'">
          <div class="discussion-list-info">
            <p class="p1">
              <span>${d.title}</span>
              <span>${d.subject}</span>
              <span><i class="fa-solid fa-heart" onclick="likeDiscussion(${d.id})" style="cursor:pointer;"></i> ${d.likes}</span>
            </p>
            <p>${d.content}</p>
            <p>
              <span>par ${d.username}</span>
              <span>${timeAgo}</span>
              <span onclick="openComments(${d.id})" style="cursor:pointer;">
                <i class="fa-solid fa-comment"></i> ${d.comment_count} r√©ponse${d.comment_count !== 1 ? 's' : ''} 
              </span>
              ${window.CURRENT_USER_ID && window.CURRENT_USER_ID === d.user_id ? `<button class="btn-delete-discussion" data-discussion-id="${d.id}" style="background:none;border:none;color:#d9534f;cursor:pointer;padding:0;margin-left:8px;">Supprimer</button>` : ''}
            </p>
          </div>
        </div>
      `;
      container.appendChild(el);
    });

    renderPagination(totalPages, currentPageDiscussions, (page) => {
      currentPageDiscussions = page;
      renderDiscussions(discussions);
    }, 'discussions-pagination');
  }

  function applyFilters() {
    const query = document.getElementById('search-discussions').value.trim();
    const sortBy = document.getElementById('sort-discussions').value;
    const filtered = filterDiscussions(allDiscussions, query);
    const sorted = sortDiscussions(filtered, sortBy);
    renderDiscussions(sorted);
  }

  function loadAllDiscussions() {
    fetch('/api/discussions')
      .then(res => res.json())
      .then(discussions => {
        allDiscussions = discussions;
        document.getElementById('total-discussions').textContent = discussions.length;
        applyFilters();
      })
      .catch(err => {
        console.error("Erreur chargement discussions:", err);
        document.getElementById('discussions-container').innerHTML = '<p style="color:red; text-align:center;">Erreur de chargement.</p>';
      });
  }

  // =============== MODAL & INTERACTIONS COMMENTS ===============
  function openComments(discussionId) {
    currentDiscussionId = discussionId;
    document.getElementById('comment-modal').style.display = 'flex';
    loadComments(discussionId);
  }
  function renderCommentTree(comments) {
    if (!comments || !comments.length) return '<p style="color:#777;">Aucun commentaire.</p>';

  const renderNode = (c, depth = 0) => {
      const indent = Math.min(depth * 12, 48);
      const children = (c.children || []);
      const childrenHtml = children.map(child => renderNode(child, depth + 1)).join('');
      const hasChildren = children.length > 0;
      const toggleId = `children-of-${c.id}`;
      return `
        <div style="margin-bottom:8px; padding:10px; border-radius:6px; background:#fff; margin-left:${indent}px; border-left:3px solid #007bff;">
          <div style="display:flex; gap:8px; align-items:flex-start;">
            <img src="${c.user_avatar || 'https://cdn.pixabay.com/photo/2024/06/22/22/55/man-8847064_640.jpg'}" width="34" style="border-radius:50%;">
            <div style="flex:1;">
              <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                <strong>${c.username}</strong>
                <small style="color:#777;">${formatTimeAgo(c.created_at)}</small>
              </div>
              <div style="margin-top:6px;">${c.content}</div>
              <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                <button class="btn-reply" data-comment-id="${c.id}" style="background:none; border:none; color:blueviolet; cursor:pointer; padding:0;">R√©pondre</button>
                ${hasChildren ? `<button class="btn-toggle-children" data-target="${toggleId}" style="background:none; border:none; color:#666; cursor:pointer; padding:0;">Afficher ${children.length} r√©ponse${children.length>1?'s':''}</button>` : ''}
                ${window.CURRENT_USER_ID && window.CURRENT_USER_ID === c.user_id ? `<button class="btn-delete-comment" data-comment-id="${c.id}" style="background:none; border:none; color:#d9534f; cursor:pointer; padding:0;">Supprimer</button>` : ''}
              </div>
              ${hasChildren ? `<div id="${toggleId}" class="children-container" style="display:none; margin-top:8px;">${childrenHtml}</div>` : ''}
            </div>
          </div>
        </div>
      `;
    };

    return comments.map(c => renderNode(c)).join('');
  }

  function loadComments(discussionId) {
    fetch(`/api/discussion/${discussionId}/comments`)
      .then(res => res.json())
      .then(comments => {
        const list = document.getElementById('comments-list');
        list.innerHTML = renderCommentTree(comments);

        // Wire reply buttons
        document.querySelectorAll('.btn-reply').forEach(btn => {
          btn.addEventListener('click', function() {
            const parentId = this.dataset.commentId;
            const input = document.getElementById('comment-input');
            input.focus();
            input.dataset.parentId = parentId; // set parent_id for next submit
            // show reply indicator with the username
            const parentContainer = this.closest('div');
            const nameEl = parentContainer.querySelector('strong');
            const replyName = nameEl ? nameEl.textContent : 'utilisateur';
            document.getElementById('reply-to-name').textContent = replyName;
            document.getElementById('reply-indicator').style.display = 'block';
            document.getElementById('modal-title').textContent = 'R√©pondre au commentaire';
          });
        });

        // Wire delete comment buttons
        document.querySelectorAll('.btn-delete-comment').forEach(btn => {
          btn.addEventListener('click', function() {
            const commentId = this.dataset.commentId;
            if (!confirm('Supprimer ce commentaire ?')) return;
            fetch(`/api/comment/${commentId}`, { method: 'DELETE' })
              .then(res => res.json())
              .then(data => {
                if (data.success) {
                  loadComments(currentDiscussionId);
                } else {
                  alert(data.error || 'Impossible de supprimer le commentaire');
                }
              }).catch(() => alert('Erreur r√©seau'));
          });
        });

        // Cancel reply button
        const cancelBtn = document.getElementById('cancel-reply');
        if (cancelBtn) {
          cancelBtn.addEventListener('click', function() {
            const input = document.getElementById('comment-input');
            delete input.dataset.parentId;
            document.getElementById('reply-indicator').style.display = 'none';
            document.getElementById('modal-title').textContent = 'Commentaires';
          });
        }
        // Wire toggle children buttons
        document.querySelectorAll('.btn-toggle-children').forEach(btn => {
          btn.addEventListener('click', function() {
            const targetId = this.dataset.target;
            const el = document.getElementById(targetId);
            if (!el) return;
            if (el.style.display === 'none' || !el.style.display) {
              el.style.display = 'block';
              this.textContent = 'Masquer les r√©ponses';
            } else {
              el.style.display = 'none';
              const count = el.querySelectorAll(':scope > div').length;
              this.textContent = `Afficher ${count} r√©ponse${count>1?'s':''}`;
            }
          });
        });
      });
  }

  function likeDiscussion(id) {
    fetch(`/api/discussion/${id}/like`, { method: 'POST' })
      .then(res => res.json())
      .then(data => {
        const disc = allDiscussions.find(d => d.id === id);
        if (disc) disc.likes = data.likes;
        applyFilters();
      });
  }

  // =============== EVENTS ===============
  document.getElementById('discussion-subject')?.addEventListener('change', function(e) {
    const autreInput = document.getElementById('autre-subject');
    if (e.target.value === 'autre') {
      autreInput.style.display = 'block';
      autreInput.required = true;
    } else {
      autreInput.style.display = 'none';
      autreInput.required = false;
      autreInput.value = '';
    }
  });

  document.getElementById('new-discussion-form')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const content = document.getElementById('discussion-content').value.trim();
    let subject = document.getElementById('discussion-subject').value;
    const autreSubject = document.getElementById('autre-subject').value.trim();
    
    if (subject === 'autre') {
      if (!autreSubject) {
        alert("Veuillez pr√©ciser la mati√®re.");
        return;
      }
      subject = autreSubject;
    }
    
    if (!content || !subject) return alert("Veuillez remplir tous les champs.");
    const title = content.length > 60 ? content.substring(0, 60) + "‚Ä¶" : content;

    fetch('/api/discussion', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, subject, content })
    }).then(() => {
      document.getElementById('discussion-content').value = '';
      document.getElementById('discussion-subject').value = '';
      document.getElementById('autre-subject').value = '';
      document.getElementById('autre-subject').style.display = 'none';
      // Reset any removed global inputs
      loadAllDiscussions();
    }).catch(() => alert("Erreur lors de la publication."));
  });

  document.getElementById('search-discussions')?.addEventListener('input', applyFilters);
  document.getElementById('sort-discussions')?.addEventListener('change', applyFilters);

  document.querySelector('.close')?.addEventListener('click', () => {
    document.getElementById('comment-modal').style.display = 'none';
  });
  window.addEventListener('click', e => {
    if (e.target.id === 'comment-modal') {
      document.getElementById('comment-modal').style.display = 'none';
    }
  });

  document.getElementById('comment-form')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const content = document.getElementById('comment-input').value.trim();
    if (!content) return;
    const parentId = document.getElementById('comment-input').dataset.parentId || null;
    fetch(`/api/discussion/${currentDiscussionId}/comment`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content, parent_id: parentId })
    }).then(() => {
      document.getElementById('comment-input').value = '';
      delete document.getElementById('comment-input').dataset.parentId;
      document.getElementById('reply-indicator').style.display = 'none';
      document.getElementById('modal-title').textContent = 'Commentaires';
      loadComments(currentDiscussionId);
    });
  });

  // Global community toggle
  let isGlobalView = false;
  document.getElementById('global-toggle')?.addEventListener('click', function() {
    isGlobalView = !isGlobalView;
    this.textContent = isGlobalView ? 'Vue locale' : 'Vue globale';
    loadAllDiscussions();
  });

  // =============== MODAL PARTAGE ===============
  const partages = document.querySelectorAll('.share-ressource');
  const modalOverlay = document.getElementById('modal-overlay');
  const form_p = document.getElementById('form-partage');

  function ouvrirFormulaire() {
    if (modalOverlay) modalOverlay.style.display = 'flex';
  }

  function fermerFormulaire() {
    if (modalOverlay) {
      modalOverlay.style.display = 'none';
      const autreInput = document.getElementById('autre-matiere');
      if (autreInput) {
        autreInput.style.display = 'none';
        autreInput.value = '';
      }
      const matiereSelect = document.getElementById('MYmatiere');
      if (matiereSelect) {
        matiereSelect.disabled = false;
        matiereSelect.value = '';
      }
    }
  }

  partages.forEach(btn => {
    btn.addEventListener('click', ouvrirFormulaire);
  });

  if (modalOverlay) {
    modalOverlay.addEventListener('click', (e) => {
      if (e.target === modalOverlay) fermerFormulaire();
    });
  }

  if (form_p) {
    form_p.addEventListener('click', (e) => {
      e.stopPropagation();
    });
  }

  document.getElementById('MYmatiere')?.addEventListener('change', function(e) {
    const autreInput = document.getElementById('autre-matiere');
    if (e.target.value === 'autre') {
      autreInput.style.display = 'block';
      autreInput.required = true;
    } else {
      autreInput.style.display = 'none';
      autreInput.required = false;
      autreInput.value = '';
    }
  });

  if (form_p) {
    form_p.addEventListener('submit', function(e) {
      const matiereSelect = document.getElementById('MYmatiere');
      const autreInput = document.getElementById('autre-matiere');
      
      if (matiereSelect && matiereSelect.value === 'autre') {
        if (!autreInput || !autreInput.value.trim()) {
          e.preventDefault();
          alert("Veuillez pr√©ciser la mati√®re.");
          return false;
        }
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'matiere';
        hiddenInput.value = autreInput.value.trim();
        e.target.appendChild(hiddenInput);
        matiereSelect.disabled = true;
      }
      
      const files = document.getElementById('file').files;
      const maxSize = 50 * 1024 * 1024;
      
      for (let file of files) {
        if (file.size > maxSize) {
          e.preventDefault();
          alert(`Le fichier "${file.name}" est trop volumineux.\nTaille maximale : 50 Mo.`);
          return false;
        }
      }
    });
  }

  form_p?.addEventListener('submit', function() {
    setTimeout(() => {
      const autreInput = document.getElementById('autre-matiere');
      const matiereSelect = document.getElementById('MYmatiere');
      
      if (autreInput) {
        autreInput.style.display = 'none';
        autreInput.value = '';
      }
      if (matiereSelect) {
        matiereSelect.disabled = false;
        matiereSelect.value = '';
      }
      
      document.getElementById('titre').value = '';
      document.getElementById('file').value = '';
    }, 1000);
  });
 
  // =============== NAVIGATION ENTRE ONGLETS ===============
  const tabs = document.querySelectorAll(".tab");
  const pages = document.querySelectorAll(".page");

  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      tabs.forEach(t => t.classList.remove("active"));
      tab.classList.add("active");
      pages.forEach(page => page.classList.remove("active"));
      const target = tab.getAttribute("data-page");
      document.getElementById(target).classList.add("active");
    });
  });

  // =============== STATS ===============
  function loadStats() {
    fetch('/api/stats')
      .then(res => res.json())
      .then(data => {
        document.getElementById('active-users').textContent = data.active_users;
        document.getElementById('total-ressources').textContent = data.total_ressources || 0;
      });
  }

  // =============== INITIALISATION ===============
  document.addEventListener('DOMContentLoaded', () => {
    loadAllDiscussions();
    loadRessources();
    loadStats();
    
    // √âcouter les changements de hash
    window.addEventListener('hashchange', function() {
      console.log('Hash chang√©:', window.location.hash);
      setTimeout(handleHashOnLoad, 500);
    });
  });

  /* ==========================
     T√©l√©chargement des ressources (images / pdf / multiple)
     - downloadRessource(id): t√©l√©charge une seule ressource ou zip plusieurs fichiers
     - Utilise JSZip + FileSaver si n√©cessaire (charg√©s dynamiquement)
  ========================== */
  function getFilenameFromUrl(url){
    try{
      const u = url.split('?')[0];
      return decodeURIComponent(u.substring(u.lastIndexOf('/')+1)) || 'file';
    }catch(e){return 'file';}
  }

  function sanitizeFilename(name){
    return name.replace(/[^a-z0-9._-]/gi, '_');
  }

  async function downloadUrlAsFile(url, filename){
    try{
      const resp = await fetch(url);
      if(!resp.ok) throw new Error('Erreur r√©seau');
      const blob = await resp.blob();
      const a = document.createElement('a');
      const objectUrl = URL.createObjectURL(blob);
      a.href = objectUrl;
      a.download = filename || getFilenameFromUrl(url);
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=> URL.revokeObjectURL(objectUrl), 10000);
    }catch(err){
      console.error('download error', err);
      // Tentative de repli : demander au serveur de proxy le t√©l√©chargement (√©vite les probl√®mes CORS)
      try{
        const resp2 = await fetch('/api/ressources/download', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ files: [url], title: filename || '' })
        });
        if(!resp2.ok) throw new Error('Proxy failed');
        const blob2 = await resp2.blob();
        const a2 = document.createElement('a');
        const objectUrl2 = URL.createObjectURL(blob2);
        a2.href = objectUrl2;
        a2.download = filename || getFilenameFromUrl(url) || 'download';
        document.body.appendChild(a2);
        a2.click();
        a2.remove();
        setTimeout(()=> URL.revokeObjectURL(objectUrl2), 10000);
        return;
      }catch(proxyErr){
        console.error('proxy download error', proxyErr);
        alert('Erreur lors du t√©l√©chargement (CORS ou r√©seau).');
      }
    }
  }

  function ensureLibs(){
    return new Promise((resolve, reject)=>{
      const libs = [];
      if(!window.JSZip){
        libs.push(new Promise(res=>{
          const s=document.createElement('script');
          s.src='https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js';
          s.onload=res; s.onerror=res; document.head.appendChild(s);
        }));
      }
      if(!window.saveAs){
        libs.push(new Promise(res=>{
          const s=document.createElement('script');
          s.src='https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js';
          s.onload=res; s.onerror=res; document.head.appendChild(s);
        }));
      }
      if(libs.length===0) return resolve();
      Promise.all(libs).then(()=>resolve()).catch(()=>resolve());
    });
  }

  async function downloadRessource(ressourceId){
    // chercher la ressource dans les listes connues
    let resObj = (ressources || []).find(r=>r.id == ressourceId) || (filteredRessources || []).find(r=>r.id == ressourceId);
    if(!resObj){
      // tenter rechargement rapide
      try{ const r = await fetch(`/api/ressources`); const all = await r.json(); resObj = all.find(x=>x.id==ressourceId); }
      catch(e){}
    }
    if(!resObj) return alert('Ressource introuvable pour le t√©l√©chargement.');

    const files = resObj.files || [];
    if(files.length === 0){
      return alert('Aucun fichier disponible.');
    }

    // Si un seul fichier -> t√©l√©chargement direct
    if(files.length === 1){
      const url = files[0].download_url || files[0].file_url;
      const name = getFilenameFromUrl(url) || (`ressource-${resObj.id}`);
      return downloadUrlAsFile(url, name);
    }

    // Plusieurs fichiers -> demander au serveur de cr√©er un ZIP et le renvoyer (√©vite les probl√®mes CORS)
    try{
      const urls = files.map(f => f.download_url || f.file_url);
      const resp = await fetch('/api/ressources/download', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ files: urls, title: resObj.title || `ressources-${resObj.id}` })
      });
      if(!resp.ok) throw new Error('Proxy ZIP failed');
      const blob = await resp.blob();
      const zipName = sanitizeFilename(resObj.title || `ressources-${resObj.id}`) + '.zip';
      const a = document.createElement('a');
      const objectUrl = URL.createObjectURL(blob);
      a.href = objectUrl;
      a.download = zipName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=> URL.revokeObjectURL(objectUrl), 10000);
    }catch(err){
      console.error('proxy zip error', err);
      alert('Erreur lors du t√©l√©chargement du ZIP.');
    }
  }

  // Version simplifi√©e - √† ajouter dans communaute.html
function checkAndOpenShareForm() {
    const shouldOpenForm = sessionStorage.getItem('openShareForm');
    
    if (shouldOpenForm === 'true') {
        sessionStorage.removeItem('openShareForm');
        
        // Ouvrir directement le formulaire
        setTimeout(() => {
            ouvrirFormulaire(); // Cette fonction existe d√©j√† dans ton code
        }, 1000);
    }
}

// Appeler au chargement
document.addEventListener('DOMContentLoaded', checkAndOpenShareForm);

// carroussel
// =============== FONCTIONS DE REGROUPEMENT ===============

function groupRessourcesByTitle(ressources) {
    const grouped = {};
    
    ressources.forEach(ressource => {
        const key = `${ressource.title}-${ressource.subject}-${ressource.user_id}`;
        
        if (!grouped[key]) {
            grouped[key] = {
                id: ressource.id, // Garder le premier ID
                title: ressource.title,
                subject: ressource.subject,
                user_id: ressource.user_id,
                username: ressource.username,
                user_avatar: ressource.user_avatar,
                created_at: ressource.created_at,
                likes: ressource.likes,
                is_saved: ressource.is_saved,
                page_count: ressource.page_count,
                files: [{
                    id: ressource.id, // üî• TR√àS IMPORTANT : inclure l'ID original
                    file_url: ressource.file_url,
                    download_url: ressource.download_url,
                    file_type: ressource.file_type,
                    page_count: ressource.page_count,
                    is_video: ressource.is_video
                }],
                is_multiple: false
            };
        } else {
            grouped[key].files.push({
                id: ressource.id, // üî• TR√àS IMPORTANT : inclure l'ID original
                file_url: ressource.file_url,
                download_url: ressource.download_url,
                file_type: ressource.file_type,
                page_count: ressource.page_count,
                is_video: ressource.is_video
            });
        }
    });
    
    // Marquer les groupes multiples
    const result = Object.values(grouped).map(group => {
        if (group.files.length > 1) {
            group.is_multiple = true;
        }
        return group;
    });
    
    return result;
}
// =============== FONCTIONS POUR LE CAROUSEL ===============

function createCarouselHtml(files, ressourceId) {
    let slidesHtml = '';
    files.forEach((file, index) => {
        slidesHtml += `
            <div class="carousel-slide" data-index="${index}">
                ${createSingleMediaHtml(file, ressourceId, true)}
            </div>`;
    });

    let indicatorsHtml = '';
    files.forEach((_, index) => {
        const isActive = index === 0 ? 'active' : '';
        indicatorsHtml += `<button class="carousel-indicator ${isActive}" data-index="${index}"></button>`;
    });

    return `
        <div class="ressource-carousel" id="carousel-${ressourceId}">
            <div class="carousel-count">1/${files.length}</div>
            <div class="multi-file-badge">
                <i class="fa-solid fa-layer-group"></i> ${files.length} fichiers
            </div>
            <div class="carousel-track">
                ${slidesHtml}
            </div>
            ${files.length > 1 ? `
                <button class="carousel-nav carousel-prev" onclick="carouselPrev('${ressourceId}')">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
                <button class="carousel-nav carousel-next" onclick="carouselNext('${ressourceId}')">
                    <i class="fa-solid fa-chevron-right"></i>
                </button>
                <div class="carousel-indicators">
                    ${indicatorsHtml}
                </div>
            ` : ''}
        </div>`;
}

function createSingleMediaHtml(file, ressourceId, isInCarousel = false) {
    const containerClass = isInCarousel ? 'carousel-media' : '';
    const { file_url, file_type, is_video } = file;

    if (file_type === 'youtube') {
        return `
            <div class="${containerClass}">
                <iframe 
                    width="100%" 
                    height="200" 
                    src="${file_url}" 
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen>
                </iframe>
            </div>`;
    } else if (is_video || ['mp4','mov','avi','mkv','webm'].includes(file_type)) {
        return `
            <div class="${containerClass}" style="cursor: pointer;" onclick="window.location.href='/videos#video-${ressourceId}'">
                <div class="carousel-icon-placeholder" style="padding: 25px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px;">
                    <i class="fa-solid fa-video" style="font-size: 2.5em; margin-bottom: 12px;"></i>
                    <p style="margin: 0; font-weight: 500;">üìπ Vid√©o disponible</p>
                    <p style="margin: 8px 0 0 0; font-size: 0.9em; opacity: 0.9;">Cliquez pour voir dans la page Vid√©os</p>
                </div>
            </div>`;
    } else if (['png','jpg','jpeg','gif'].includes(file_type)) {
        return `
            <div class="${containerClass}">
                <img src="${file_url}" alt="Image" 
                     loading="lazy" 
                     style="width: 100%; height: 100%; object-fit: contain;"
                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5Ij5JbWFnZTwvdGV4dD48L3N2Zz4='">
            </div>`;
    } else if (file_type === 'pdf') {
        return `
            <div class="${containerClass}">
                <div class="carousel-icon-placeholder">
                    <i class="fa-solid fa-file-pdf"></i>
                    <p>Document PDF</p>
                    ${file.page_count ? `<small>${file.page_count} pages</small>` : ''}
                </div>
            </div>`;
    } else {
        return `
            <div class="${containerClass}">
                <div class="carousel-icon-placeholder">
                    <i class="fa-solid fa-file-lines"></i>
                    <p>${(file_type || 'DOC').toUpperCase()}</p>
                </div>
            </div>`;
    }
}

// =============== FONCTIONS DE NAVIGATION CAROUSEL ===============

function initializeCarousels() {
    document.querySelectorAll('.ressource-carousel').forEach(carousel => {
        const carouselId = carousel.id.replace('carousel-', '');
        carousel.currentSlide = 0;
        updateCarousel(carouselId);
    });
}

function carouselNext(carouselId) {
    const carousel = document.getElementById(`carousel-${carouselId}`);
    if (!carousel) return;
    
    const slides = carousel.querySelectorAll('.carousel-slide');
    carousel.currentSlide = (carousel.currentSlide + 1) % slides.length;
    updateCarousel(carouselId);
}

function carouselPrev(carouselId) {
    const carousel = document.getElementById(`carousel-${carouselId}`);
    if (!carousel) return;
    
    const slides = carousel.querySelectorAll('.carousel-slide');
    carousel.currentSlide = (carousel.currentSlide - 1 + slides.length) % slides.length;
    updateCarousel(carouselId);
}

function updateCarousel(carouselId) {
    const carousel = document.getElementById(`carousel-${carouselId}`);
    if (!carousel) return;
    
    const track = carousel.querySelector('.carousel-track');
    const slides = carousel.querySelectorAll('.carousel-slide');
    const indicators = carousel.querySelectorAll('.carousel-indicator');
    const count = carousel.querySelector('.carousel-count');
    
    if (!track || !slides.length) return;
    
    const slideWidth = 100; // 100% par slide
    track.style.transform = `translateX(-${carousel.currentSlide * slideWidth}%)`;
    
    // Mettre √† jour les indicateurs
    indicators.forEach((indicator, index) => {
        indicator.classList.toggle('active', index === carousel.currentSlide);
    });
    
    // Mettre √† jour le compteur
    if (count) {
        count.textContent = `${carousel.currentSlide + 1}/${slides.length}`;
    }
}

// Navigation par indicateurs et swipe
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('carousel-indicator')) {
        const carousel = e.target.closest('.ressource-carousel');
        const carouselId = carousel.id.replace('carousel-', '');
        const index = parseInt(e.target.getAttribute('data-index'));
        if (carousel && !isNaN(index)) {
            carousel.currentSlide = index;
            updateCarousel(carouselId);
        }
    }
});

// Support du swipe sur mobile
let touchStartX = 0;
let touchEndX = 0;

document.addEventListener('touchstart', e => {
    touchStartX = e.changedTouches[0].screenX;
});

document.addEventListener('touchend', e => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
});

function handleSwipe() {
    const swipeThreshold = 50;
    const diff = touchStartX - touchEndX;
    
    if (Math.abs(diff) > swipeThreshold) {
        const activeCarousel = document.querySelector('.ressource-carousel:hover') || 
                             document.querySelector('.ressource-media:has(.ressource-carousel:hover)');
        
        if (activeCarousel) {
            const carouselId = activeCarousel.id.replace('carousel-', '');
            if (diff > 0) {
                // Swipe gauche ‚Üí suivant
                carouselNext(carouselId);
            } else {
                // Swipe droite ‚Üí pr√©c√©dent
                carouselPrev(carouselId);
            }
        }
    }
}


</script>
{% endblock %}
