{% extends 'base.html' %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/communaute.css') }}">
<style>
  .modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background: white !important;
    color: black !important;
    padding: 20px;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .close {
    float: right;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    color: #555;
  }
  .close:hover {
    color: #000;
  }

  /* Pagination style */
  .pagination {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin: 20px 0;
    flex-wrap: wrap;
  }
  .pagination button {
    padding: 6px 12px;
    border: 1px solid #ccc;
    background: #f8f9fa;
    cursor: pointer;
    border-radius: 4px;
  }
  .pagination button:hover {
    background: #e9ecef;
  }
  .current-page {
    padding: 6px 12px;
    background: #007bff;
    color: white;
    border-radius: 4px;
  }
</style>
{% endblock %}

{% block content %}
<!-- ================= HEADER ================= -->
<header class="header">
  <div class="header-content">
    <h1>Communauté Edushare</h1>
    <p>Echangez, discutez et partagez vos connaissances avec la communauté</p>
  </div>
  <!-- Navigation -->
  <nav>
    <button class="tab active" data-page="discussion">
      <i class="fas fa-chart-line"></i> Discussion
    </button>
    <button class="tab" data-page="partages">
      <i class="fas fa-folder-open"></i> Partages recentes
    </button>
  </nav>
</header>

<main>
  <!-- Section DISCUSSION -->
  <section id="discussion" class="page active">
    <div class="discussion">
      <div class="info-discussion">
        <div class="start-discussion">
          <h2>Nouvelle discussion</h2>
          <div id="area-1">
            <img src="{{ current_user.avatar_url or 'https://cdn.pixabay.com/photo/2024/06/22/22/55/man-8847064_640.jpg' }}" alt="photo">
            <form id="new-discussion-form" class="form-control">
              <textarea id="discussion-content" required placeholder="Poser une question ou commencer une discussion"></textarea>
              <div id="area-3">
                <select id="discussion-subject">
                  <option value="">-- Choisir une matière --</option>
                  <option value="C++">C++</option>
                  <option value="HTML">HTML</option>
                  <option value="CSS">CSS</option>
                  <option value="Javascript">Javascript</option>
                  <option value="Algorithme">Algorithme</option>
                </select>
                <button type="submit">Publier</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Barre de recherche et tri -->
        <div style="margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap; align-items: end;">
          <div style="flex: 1; min-width: 200px;">
            <input type="text" id="search-discussions" placeholder="Rechercher une discussion..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          </div>
          <div style="min-width: 150px;">
            <select id="sort-discussions" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
              <option value="date">Plus récent</option>
              <option value="likes">Populaires</option>
              <option value="subject">Par matière</option>
            </select>
          </div>
        </div>

        <!-- Discussions dynamiques -->
        <div id="discussions-container">
          <!-- Chargé par JavaScript -->
        </div>
        <div id="discussions-pagination"></div> <!-- ✅ Pagination ici -->
      </div>

      <!-- Colonne droite -->
      <div class="block-2">
        <div class="action-rapide">
          <h2>Actions rapides</h2>
          <ul>
            <li class="share-ressource">Partager une ressource</li>
            <li><a href="#" style="color: black; text-decoration: none;">Poser une question</a></li>
            <li class="join-group">Rejoindre un groupe</li>
          </ul>
        </div>

        <div class="sujet-populaire">
          <h2>Sujets populaires</h2>
          <ul>
            <li><span>Optimisation C++</span><span>24</span></li>
            <li><span>CSS Grid</span><span>18</span></li>
            <li><span>Algorithme de tri</span><span>15</span></li>
            <li><span>Gestion mémoire</span><span>12</span></li>
            <li><span>JavaScript async</span><span>10</span></li>
          </ul>
        </div>

        <div class="statistique">
          <h2>Statistiques</h2>
          <ul>
            <li><span>Membres actifs</span><span id="active-users">—</span></li>
            <li><span>Discussions ouvertes</span><span id="total-discussions">—</span></li>
            <li><span>Ressources partagées</span><span id="total-ressources">—</span></li>
            <li><span>Messages aujourd'hui</span><span>12</span></li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal pour les commentaires -->
  <div id="comment-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3 id="modal-title">Commentaires</h3>
      <div id="comments-list"></div>
      <form id="comment-form" style="margin-top:15px;">
        <textarea id="comment-input" placeholder="Écrivez un commentaire..." required style="width:100%; height:60px; padding:8px; border:1px solid #ccc; border-radius:4px;"></textarea>
        <button type="submit" style="margin-top:8px; padding:6px 12px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer;">Envoyer</button>
      </form>
    </div>
  </div>

  <!-- Section PARTAGES -->
  <section id="partages" class="page">
    <div class="discussion">
      <div class="info-discussion">
        <!-- Menu de tri et recherche -->
        <div class="tri-bar">
          <label for="sort">Trier par :</label>
          <select id="sort">
            <option value="date-desc">Date (récent → ancien)</option>
            <option value="date-asc">Date (ancien → récent)</option>
            <option value="file_type-asc">Type (A-Z)</option>
            <option value="file_type-desc">Type (Z-A)</option>
            <option value="likes-desc">Likes (plus aimés)</option>
          </select>
          <div>
            <input type="text" id="search" placeholder="Rechercher un titre ou un sujet...">
          </div>
        </div>

        <!-- Liste dynamique -->
        <div id="ressource-list"></div>
        <div id="ressources-pagination"></div> <!-- ✅ Pagination ici -->
      </div>

      <!-- Colonne droite -->
      <div class="block-2">
        <div class="action-rapide">
          <h2>Actions rapides</h2>
          <ul>
            <li class="share-ressource">Partager une ressource</li>
            <li><a href="{{ url_for('communaute') }}" style="color: black; text-decoration: none;">Poser une question</a></li>
            <li class="join-group">Rejoindre un groupe</li>
          </ul>
        </div>

        <div class="sujet-populaire">
          <h2>Sujets populaires</h2>
          <ul>
            <li><span>Optimisation C++</span><span>24</span></li>
            <li><span>CSS Grid</span><span>18</span></li>
            <li><span>Algorithme de tri</span><span>15</span></li>
            <li><span>Gestion mémoire</span><span>12</span></li>
            <li><span>JavaScript async</span><span>10</span></li>
          </ul>
        </div>

        <div class="statistique">
          <h2>Statistiques</h2>
          <ul>
            <li><span>Membres actifs</span><span>24</span></li>
            <li><span>Discussions ouvertes</span><span>18</span></li>
            <li><span>Ressources partagées</span><span>15</span></li>
            <li><span>Messages aujourd'hui</span><span>12</span></li>
          </ul>
        </div>
      </div>
    </div>
  </section>
</main>

<div id="modal-overlay" class="modal-overlay">
  <!-- Dans votre modal de partage -->
<form id="form-partage" class="form-partage" method="post" action="{{ url_for('share_ressource') }}" enctype="multipart/form-data">
  <label for="titre">Titre:</label>
  <input type="text" id="titre" name="titre" placeholder="Le titre du document" required />

  <label for="MYmatiere">Matière :</label>
  <select id="MYmatiere" name="matiere" required>
    <option value="">-- Sélectionnez --</option>
    <option value="JavaScript">JavaScript</option>
    <option value="HTML">HTML</option>
    <option value="C++">C++</option>
    <option value="CSS">CSS</option>
    <option value="Systèmes">Système</option>
  </select>

  <label for="file">Fichier(s) (images, pdf, vidéo) :</label>
  <!-- ✅ accept multiple + nouveaux formats -->
  <input type="file" id="file" name="files" accept=".png,.jpg,.jpeg,.gif,.pdf,.doc,.docx,.mp4,.mov,.avi,.mkv" multiple required>

  <div class="bbtn">
    <button type="submit">Publier</button>
    <button type="button" onclick="fermerFormulaire()">Annuler</button>
  </div>
</form>
</div>
{% endblock %}

{% block script %}
<script>
  // =============== CONFIGURATION ===============
  const ITEMS_PER_PAGE = 10;
  let currentPageDiscussions = 1;
  let currentPageRessources = 1;

  // =============== PARTAGES ===============
  let ressources = [];
  let filteredRessources = [];

  async function loadRessources() {
    const res = await fetch('/api/ressources');
    ressources = await res.json();
    filteredRessources = [...ressources];
    displayRessources(filteredRessources);
  }

  function displayRessources(list) {
  const container = document.getElementById('ressource-list');
  const totalPages = Math.ceil(list.length / ITEMS_PER_PAGE);
  const start = (currentPageRessources - 1) * ITEMS_PER_PAGE;
  const paginated = list.slice(start, start + ITEMS_PER_PAGE);

  container.innerHTML = '';
  paginated.forEach(res => {
    const pages = res.page_count > 0 ? ` (${res.page_count} pages)` : '';
    const date = new Date(res.created_at).toLocaleDateString();
    
    // Déterminer si c'est une vidéo
    const isVideo = ['mp4', 'mov', 'avi', 'mkv', 'webm'].includes(res.file_type);

    // Déterminer l'état de l'icône de sauvegarde
    const isSaved = res.is_saved || false;
    const bookmarkIconClass = isSaved ? 'fa-solid fa-bookmark' : 'fa-regular fa-bookmark';
    const bookmarkColor = isSaved ? '#007bff' : '#ccc';

    container.innerHTML += `
      <div class="discussion-list">
        <div class="discussion-head">
          <img src="${res.user_avatar}" alt="Avatar de ${res.username}" onerror="this.src='https://via.placeholder.com/150'">
          <div class="discussion-list-info">
            <p class="p1">
              <span>${res.title}</span>
              <span>${res.subject}</span>
              <a href="#" onclick="likeRessource(${res.id}); return false;">
                <i class="fa-solid fa-thumbs-up"></i> <span>${res.likes}</span>
              </a>
              <a href="#" onclick="toggleSaveRessource(${res.id}, this); return false;">
                <i class="${bookmarkIconClass}" style="color: ${bookmarkColor};"></i>
              </a>
            </p>
            <p>Type: ${res.file_type}${pages}</p>
            <div style="margin: 10px 0;">
              ${isVideo ? `
                <video controls width="100%" style="border-radius:4px;">
                  <source src="${res.file_url}" type="video/${res.file_type}">
                  Votre navigateur ne supporte pas la vidéo.
                </video>
              ` : `
                <a href="${res.file_url}" target="_blank">
                  <i class="fa-solid fa-eye"></i> Voir
                </a>
              `}
            </div>
            <p class="p2">
              <span>par ${res.username}</span>
              <span>${date}</span>
            </p>
            <div class="btn-footer">
              <a href="${res.download_url}" download="${res.title}.${res.file_type}">
                <i class="fa-solid fa-download"></i> Télécharger
              </a>
            </div>
          </div>
        </div>
      </div>`;
  });

  renderPagination(totalPages, currentPageRessources, (page) => {
    currentPageRessources = page;
    displayRessources(list);
  }, 'ressources-pagination');
}
  document.getElementById('sort').addEventListener('change', (e) => {
    currentPageRessources = 1;
    const [field, order] = e.target.value.split('-');
    filteredRessources.sort((a, b) => {
      let x = a[field], y = b[field];
      if (field === 'date') {
        x = new Date(a.created_at);
        y = new Date(b.created_at);
      }
      if (x < y) return order === 'asc' ? -1 : 1;
      if (x > y) return order === 'asc' ? 1 : -1;
      return 0;
    });
    displayRessources(filteredRessources);
  });

  document.getElementById('search').addEventListener('input', (e) => {
    currentPageRessources = 1;
    const term = e.target.value.toLowerCase();
    filteredRessources = ressources.filter(r =>
      r.title.toLowerCase().includes(term) ||
      r.subject.toLowerCase().includes(term) ||
      r.file_type.toLowerCase().includes(term)
    );
    displayRessources(filteredRessources);
  });

  // =============== DISCUSSIONS ===============
  let allDiscussions = [];
  let currentDiscussionId = null;

  function formatTimeAgo(dateStr) {
    const now = new Date();
    const date = new Date(dateStr);
    const diffSec = Math.floor((now - date) / 1000);
    if (diffSec < 60) return "à l'instant";
    if (diffSec < 3600) {
      const m = Math.floor(diffSec / 60);
      return `il y a ${m} minute${m > 1 ? 's' : ''}`;
    }
    if (diffSec < 86400) {
      const h = Math.floor(diffSec / 3600);
      return `il y a ${h} heure${h > 1 ? 's' : ''}`;
    }
    if (diffSec < 604800) {
      const d = Math.floor(diffSec / 86400);
      return `il y a ${d} jour${d > 1 ? 's' : ''}`;
    }
    return date.toLocaleDateString('fr-FR');
  }

  function sortDiscussions(discussions, sortBy) {
    return [...discussions].sort((a, b) => {
      if (sortBy === 'likes') return b.likes - a.likes;
      if (sortBy === 'subject') return a.subject.localeCompare(b.subject);
      return new Date(b.created_at) - new Date(a.created_at);
    });
  }

  function filterDiscussions(discussions, query) {
    if (!query) return discussions;
    const q = query.toLowerCase();
    return discussions.filter(d =>
      d.title?.toLowerCase().includes(q) ||
      d.content?.toLowerCase().includes(q) ||
      d.subject?.toLowerCase().includes(q)
    );
  }

  function renderDiscussions(discussions) {
    const container = document.getElementById('discussions-container');
    const totalPages = Math.ceil(discussions.length / ITEMS_PER_PAGE);
    const start = (currentPageDiscussions - 1) * ITEMS_PER_PAGE;
    const paginated = discussions.slice(start, start + ITEMS_PER_PAGE);

    if (discussions.length === 0) {
      container.innerHTML = '<p style="text-align:center; color:#777; padding:20px;">Aucune discussion trouvée.</p>';
      document.getElementById('discussions-pagination').innerHTML = '';
      return;
    }

    container.innerHTML = '';
    paginated.forEach(d => {
      const timeAgo = formatTimeAgo(d.created_at);
      const el = document.createElement('div');
      el.className = 'discussion-list';
      el.innerHTML = `
        <div class="discussion-head">
          <img src="${d.user_avatar || 'https://via.placeholder.com/150'}" alt="avatar" onerror="this.src='https://via.placeholder.com/150'">
          <div class="discussion-list-info">
            <p class="p1">
              <span>${d.title}</span>
              <span>${d.subject}</span>
              <span><i class="fa-solid fa-heart" onclick="likeDiscussion(${d.id})" style="cursor:pointer;"></i> ${d.likes}</span>
            </p>
            <p>${d.content}</p>
            <p>
              <span>par ${d.username}</span>
              <span>${timeAgo}</span>
              <span onclick="openComments(${d.id})" style="cursor:pointer;">
                <i class="fa-solid fa-comment"></i> ${d.comment_count} réponse${d.comment_count !== 1 ? 's' : ''}
              </span>
            </p>
          </div>
        </div>
      `;
      container.appendChild(el);
    });

    renderPagination(totalPages, currentPageDiscussions, (page) => {
      currentPageDiscussions = page;
      renderDiscussions(discussions);
    }, 'discussions-pagination');
  }

  function applyFilters() {
    currentPageDiscussions = 1;
    const query = document.getElementById('search-discussions').value.trim();
    const sortBy = document.getElementById('sort-discussions').value;
    const filtered = filterDiscussions(allDiscussions, query);
    const sorted = sortDiscussions(filtered, sortBy);
    renderDiscussions(sorted);
  }

  function loadAllDiscussions() {
    fetch('/api/discussions')
      .then(res => res.json())
      .then(discussions => {
        allDiscussions = discussions;
        document.getElementById('total-discussions').textContent = discussions.length;
        applyFilters();
      })
      .catch(err => {
        console.error("Erreur chargement discussions:", err);
        document.getElementById('discussions-container').innerHTML = '<p style="color:red; text-align:center;">Erreur de chargement.</p>';
      });
  }

  // =============== MODAL & INTERACTIONS ===============
  function openComments(discussionId) {
    currentDiscussionId = discussionId;
    document.getElementById('comment-modal').style.display = 'flex';
    loadComments(discussionId);
  }

  function loadComments(discussionId) {
    fetch(`/api/discussion/${discussionId}/comments`)
      .then(res => res.json())
      .then(comments => {
        const list = document.getElementById('comments-list');
        list.innerHTML = comments.length ? comments.map(c => `
          <div style="margin-bottom:12px; padding:10px; border-bottom:1px solid #eee;">
            <div style="display:flex; align-items:start; gap:8px;">
              <img src="${c.user_avatar || 'https://via.placeholder.com/30'}" width="30" style="border-radius:50%;">
              <div>
                <strong>${c.username}</strong> • <span style="color:#777;">${formatTimeAgo(c.created_at)}</span>
                <p style="margin:6px 0 0 0;">${c.content}</p>
              </div>
            </div>
          </div>
        `).join('') : '<p style="color:#777;">Aucun commentaire.</p>';
      });
  }

  function likeDiscussion(id) {
    fetch(`/api/discussion/${id}/like`, { method: 'POST' })
      .then(res => res.json())
      .then(data => {
        const disc = allDiscussions.find(d => d.id === id);
        if (disc) disc.likes = data.likes;
        applyFilters();
      });
  }

  function likeRessource(id) {
    fetch(`/like_ressource/${id}`, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/json'
      },
    })
      .then(response => response.json())
      .then(data => {
        // Note: vous n'avez pas d'ID like-count dans le HTML, donc on ne met pas à jour visuellement ici
        // Si besoin, ajoutez un span avec id="like-count-${id}" dans le HTML
      })
      .catch(error => {
        console.error('Erreur:', error);
        alert('Impossible de liker pour le moment.');
      });
  }

  // =============== ÉVÉNEMENTS ===============
  document.getElementById('new-discussion-form')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const content = document.getElementById('discussion-content').value.trim();
    const subject = document.getElementById('discussion-subject').value;
    if (!content || !subject) return alert("Veuillez remplir tous les champs.");
    const title = content.length > 60 ? content.substring(0, 60) + "…" : content;

    fetch('/api/discussion', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, subject, content })
    }).then(() => {
      document.getElementById('discussion-content').value = '';
      document.getElementById('discussion-subject').value = '';
      loadAllDiscussions();
    }).catch(() => alert("Erreur lors de la publication."));
  });

  document.getElementById('search-discussions')?.addEventListener('input', applyFilters);
  document.getElementById('sort-discussions')?.addEventListener('change', applyFilters);

  document.querySelector('.close')?.addEventListener('click', () => {
    document.getElementById('comment-modal').style.display = 'none';
  });
  window.addEventListener('click', e => {
    if (e.target.id === 'comment-modal') {
      document.getElementById('comment-modal').style.display = 'none';
    }
  });

  document.getElementById('comment-form')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const content = document.getElementById('comment-input').value.trim();
    if (!content) return;
    fetch(`/api/discussion/${currentDiscussionId}/comment`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content })
    }).then(() => {
      document.getElementById('comment-input').value = '';
      loadComments(currentDiscussionId);
    });
  });

  // =============== STATS ===============
  function loadStats() {
    fetch('/api/stats')
      .then(res => res.json())
      .then(data => {
        document.getElementById('active-users').textContent = data.active_users;
        document.getElementById('total-ressources').textContent = data.total_ressources || 0;
      });
  }

  // =============== PAGINATION GÉNÉRIQUE ===============
  function renderPagination(totalPages, currentPage, onPageChange, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    if (totalPages <= 1) {
      container.innerHTML = '';
      return;
    }

    let html = '<div class="pagination">';

    if (currentPage > 1) {
      html += `<button onclick="(${onPageChange})(${currentPage - 1})">&laquo; Précédent</button>`;
    }

    const maxVisible = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = Math.min(totalPages, startPage + maxVisible - 1);
    if (endPage - startPage + 1 < maxVisible) {
      startPage = Math.max(1, endPage - maxVisible + 1);
    }

    for (let i = startPage; i <= endPage; i++) {
      if (i === currentPage) {
        html += `<span class="current-page">${i}</span>`;
      } else {
        html += `<button onclick="(${onPageChange})(${i})">${i}</button>`;
      }
    }

    if (currentPage < totalPages) {
      html += `<button onclick="(${onPageChange})(${currentPage + 1})">Suivant &raquo;</button>`;
    }

    html += '</div>';
    container.innerHTML = html;
  }

  // =============== NAVIGATION ===============
  const tabs = document.querySelectorAll(".tab");
  const pages = document.querySelectorAll(".page");

  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      tabs.forEach(t => t.classList.remove("active"));
      tab.classList.add("active");
      pages.forEach(page => page.classList.remove("active"));
      const target = tab.getAttribute("data-page");
      document.getElementById(target).classList.add("active");
    });
  });

  // =============== MODAL PARTAGE ===============
  const partages = document.querySelectorAll('.share-ressource');
  const modalOverlay = document.getElementById('modal-overlay');
  const form_p = document.getElementById('form-partage');

  function ouvrirFormulaire() {
    modalOverlay.style.display = 'flex';
  }

  function fermerFormulaire() {
    modalOverlay.style.display = 'none';
  }

  partages.forEach(btn => {
    btn.addEventListener('click', ouvrirFormulaire);
  });

  modalOverlay.addEventListener('click', (e) => {
    if (e.target === modalOverlay) fermerFormulaire();
  });

  form_p.addEventListener('click', (e) => {
    e.stopPropagation();
  });

  // =============== INITIALISATION ===============
  document.addEventListener('DOMContentLoaded', () => {
    loadAllDiscussions();
    loadRessources();
    loadStats();
  });
</script>
<script>
 function toggleSaveRessource(ressourceId, linkElement) {
  // Trouver l'icône à l'intérieur du lien
  const icon = linkElement.querySelector('i');
  const isCurrentlySaved = icon.classList.contains('fa-solid'); // plein = sauvegardé

  const url = isCurrentlySaved 
    ? `/api/unsave_ressource/${ressourceId}` 
    : `/api/save_ressource/${ressourceId}`;

  fetch(url, { method: 'POST' })
    .then(response => response.json())
    .then(data => {
      if (data.saved) {
        icon.className = 'fa-solid fa-bookmark';
        icon.style.color = '#007bff';
      } else {
        icon.className = 'fa-regular fa-bookmark';
        icon.style.color = '#ccc';
      }
    })
    .catch(err => {
      console.error('Erreur:', err);
      alert('Impossible de sauvegarder.');
    });
}

  document.getElementById('form-partage').addEventListener('submit', function(e) {
    const files = document.getElementById('file').files;
    const maxSize = 100 * 1024 * 1024; // 100 Mo
  
    for (let file of files) {
      if (file.size > maxSize) {
        e.preventDefault();
        alert(`Le fichier "${file.name}" est trop volumineux.\nTaille maximale : 100 Mo.`);
        return false;
      }
    }
  });
  </script>
{% endblock %}