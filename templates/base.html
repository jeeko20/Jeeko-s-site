<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eudushare</title>
  <link rel="stylesheet" href="{{url_for('static',filename='css/base.css')}}">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" rel="stylesheet">
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">

  {%block extra_css%}
    {%endblock%}
  <style>
    /* ================= MODAL ================= */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal.show { display: flex; }

    .modal-content {
      background: linear-gradient(135deg, #6c5ce7, #a29bfe);
      width: 380px;
      max-width: 95%;
      padding: 40px 30px;
      border-radius: 20px;
      color: #fff;
      position: relative;
      overflow: hidden;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9);}
      to {opacity: 1; transform: scale(1);}
    }

    .close-btn {
      position: absolute;
      right: 15px;
      top: 15px;
      font-size: 20px;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
    }

    h2 { text-align: center; margin-bottom: 25px; }

    .form-group { position: relative; margin-bottom: 20px; }
    .form-group input {
      width: 100%;
      padding: 12px 15px;
      border: none;
      border-radius: 10px;
      outline: none;
      font-size: 14px;
      color: #333;
      box-sizing: border-box;
    }
    .form-group i {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #888;
    }

    .btn-submit {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 30px;
      font-size: 15px;
      font-weight: bold;
      background: #fff;
      color: #6c5ce7;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      transition: 0.3s;
    }
    .btn-submit:hover { background: #f1f1f1; }

    .toggle-link { text-align: center; margin-top: 15px; cursor: pointer; text-decoration: underline; color: #fff; }

    .form-wrapper {
      display: none;
      opacity: 0;
      transform: translateX(30px);
      transition: all 0.3s ease;
    }
    .form-wrapper.active {
      display: block;
      opacity: 1;
      transform: translateX(0);
    }
  </style>
</head>
<body>

 
<!-- ================= NAVBAR ================= -->
<nav class="custom-navbar">
  <!-- Logo -->
  <h3>Edushare</h3> 

  <!-- Menu Desktop -->
  <div class="menu">
    <a href="{{url_for('home')}}" class="navbar-menu">Accueil</a>
    <a href="{{url_for('communaute')}}" class="navbar-menu">Communauté</a>
    <a href="{{url_for('notes')}}" class="navbar-menu">Mes notes</a>
    <a href="{{url_for('profile')}}" class="navbar-menu">Profil</a>
  </div>

  <!-- Notifications et utilisateur -->
  <div class="nav-right">
    {% if current_user.is_authenticated %}
    <!-- Cloche de notifications -->
    <div class="notification-bell">
      <i class="fa-solid fa-bell" id="notificationBell"></i>
      <span class="notification-count" id="notificationCount">0</span>
      <div class="notification-dropdown" id="notificationDropdown">
        <div class="notification-header">
          <h4>Notifications</h4>
          <button id="markAllRead">Tout marquer comme lu</button>
        </div>
        <div class="notification-list" id="notificationList">
          <div class="notification-item">
            <div class="notification-message">Chargement des notifications...</div>
          </div>
        </div>
        <div class="notification-footer">
          <a href="{{url_for('profile')}}#overview">Voir tout dans le profil</a>
        </div>
      </div>
    </div>
    
    <!-- Menu utilisateur avec avatar -->
    <div class="user-menu">
      <div class="user-avatar">
        <img src="{{ current_user.avatar_url }}" alt="Avatar" />
        <div class="user-dropdown">
          <a href="{{url_for('profile')}}">
            <i class="fa-solid fa-user"></i>
            Mon profil
          </a>
          <a href="{{url_for('notes')}}">
            <i class="fa-solid fa-note-sticky"></i>
            Mes notes
          </a>
        </div>
      </div>
      
      <!-- Bouton déconnexion visible -->
      <a href="{{url_for('logout')}}" class="logout-btn-visible">
        <i class="fa-solid fa-right-from-bracket"></i>
        Déconnexion
      </a>
    </div>
    {% else %}
    <!-- Boutons connexion/inscription -->
    <div class="auth-buttons">
      <a class="btn-connexion" id="openLogin">Connexion</a>
      <a class="btn-signup" id="openRegister">S'inscrire</a>
    </div>
    {% endif %}
  </div>

  <!-- Menu Mobile -->
  <div class="menu-hamburger" id="menu-hamburger">
    {% if current_user.is_authenticated %}
    <!-- Avatar utilisateur mobile -->
    <div class="mobile-user-info">
      <img src="{{ current_user.avatar_url }}" alt="Avatar" class="mobile-avatar" />
      <div class="mobile-user-details">
        <strong>{{ current_user.username }}</strong>
        <span>{{ current_user.profile.complete_name if current_user.profile else 'Utilisateur' }}</span>
      </div>
    </div>
    <div class="dropdown-divider"></div>
    {% endif %}
    
    <a href="{{url_for('home')}}" class="navbar-menu">
      <i class="fa-solid fa-house"></i>
      Accueil
    </a>
    <a href="{{url_for('communaute')}}" class="navbar-menu">
      <i class="fa-solid fa-users"></i>
      Communauté
    </a>
    <a href="{{url_for('notes')}}" class="navbar-menu">
      <i class="fa-solid fa-note-sticky"></i>
      Mes notes
    </a>
    <a href="{{url_for('profile')}}" class="navbar-menu">
      <i class="fa-solid fa-user"></i>
      Profil
    </a>
    
    {% if current_user.is_authenticated %}
    <!-- Notification dans le menu mobile -->
    <div class="mobile-notification">
      <a href="{{url_for('profile')}}#overview" class="navbar-menu">
        <i class="fa-solid fa-bell"></i>
        Notifications <span class="mobile-notification-count" id="mobileNotificationCount">0</span>
      </a>
    </div>
    <div class="dropdown-divider"></div>
    <a href="{{url_for('logout')}}" class="navbar-menu logout-mobile">
      <i class="fa-solid fa-right-from-bracket"></i>
      Déconnexion
    </a>
    {% else %}
    <a class="btn-connexion mobile-auth-btn" id="openLoginMobile">
      <i class="fa-solid fa-right-to-bracket"></i>
      Connexion
    </a>
    <a class="btn-signup mobile-auth-btn" id="openRegisterMobile">
      <i class="fa-solid fa-user-plus"></i>
      S'inscrire
    </a>
    {% endif %}
  </div>

  <!-- Bouton hamburger -->
  <i class="fa-solid fa-bars hamburger" id="hamburger"></i>
</nav>
 <!-- Flash messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div id="flash-messages">
            {% for category, message in messages %}
              {% set bs_class = 'success' if category=='success' else 'danger' %}
              <div class="alert alert-{{ bs_class }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

  <!-- ================= MODAL ================= -->
  <div class="modal" id="authModal">
    <div class="modal-content">
      <button class="close-btn" id="closeModal">&times;</button>

      <!-- LOGIN -->
      <form method="post" action="{{url_for('login')}}" class="form-wrapper" id="loginForm">
        <h2>Connexion</h2>
        <div class="form-group">
          <input type="email" name="email" placeholder="Email" required>
          <i class="fa fa-envelope"></i>
        </div>
        <div class="form-group">
          <input type="password" name="password" placeholder="Mot de passe" required>
          <i class="fa fa-lock"></i>
        </div>
        <button type="submit" class="btn-submit">Se connecter <i class="fa fa-arrow-right"></i></button>
        <div class="toggle-link" id="toRegister">Pas de compte ? Créez-en un</div>
      </form>

      <!-- REGISTER -->
      <form method="post" action="{{url_for('register')}}" class="form-wrapper" id="registerForm">
        <h2>S’inscrire</h2>
        <div class="form-group">
          <input type="text" name="username" placeholder="Nom d’utilisateur" required>
          <i class="fa fa-user"></i>
        </div>
        <div class="form-group">
          <input type="email" name="email" placeholder="Email" required>
          <i class="fa fa-envelope"></i>
        </div>
        <div class="form-group">
          <input type="password" name="password" placeholder="Mot de passe" required>
          <i class="fa fa-lock"></i>
        </div>
        <button class="btn-submit" type="submit">Créer un compte <i class="fa fa-arrow-right"></i></button>
        <div class="toggle-link" id="toLogin">Déjà inscrit ? Connectez-vous</div>
      </form>
    </div>
  </div>

{%block content%}
{%endblock%}


  <!-- ================= FOOTER ================= -->
  <footer>
    <div class="footer-content">
      <div class="footer-col">
        <h3>Edushare</h3>
        <p>La plateforme de partage de connaissances pour les étudiants en informatique</p>
      </div>

      <div class="footer-col">
        <h3>Matières</h3>
        <p>C++</p>
        <p>HTML / CSS</p>
        <p>JavaScript</p>
        <p>Systèmes</p>
      </div>

      <div class="footer-col">
        <h3>Ressources</h3>
        <p>Notes et cours</p>
        <p>Devoirs</p>
        <p>Projets</p>
        <p>Astuces</p>
      </div>

      <div class="footer-col">
        <h3>Support</h3>
        <p>Aide</p>
        <p>Contact</p>
        <p>FAQ</p>
        <p>Made by David</p>
      </div>
    </div>

    <div class="footer-bottom">
      <p>© 2025 Edushare. Tous droits réservés.</p>
    </div>
  </footer>


  <!-- ================= SCRIPT ================= -->
  
  <script>
    /*menu hamburger*/
    const hamburger = document.getElementById('hamburger');
    const menu_hamburger = document.getElementById('menu-hamburger');
     const body=document.body;
    hamburger.addEventListener('click', (e) => {
      menu_hamburger.classList.toggle('open');

      // Change l'icône
      hamburger.classList.toggle('fa-bars');
      hamburger.classList.toggle('fa-xmark');
	    e.stopPropagation();
    });
    
	   body.addEventListener("click", () => {
    if (menu_hamburger.classList.contains("open")) {
      menu_hamburger.classList.remove("open");
      hamburger.classList.add("fa-bars");
      hamburger.classList.remove("fa-xmark");
    }
  });
    /*..................................*/
  // Sélection de tous les boutons Connexion
const openLoginButtons = document.querySelectorAll(".btn-connexion");
// Sélection de tous les boutons S'inscrire
const openRegisterButtons = document.querySelectorAll(".btn-signup");

const modal = document.getElementById("authModal");
const loginForm = document.getElementById("loginForm");
const registerForm = document.getElementById("registerForm");
const closeModal = document.getElementById("closeModal");
const toRegister = document.getElementById("toRegister");
const toLogin = document.getElementById("toLogin");

// Fonction pour ouvrir le modal et afficher login
function showLogin() {
  modal.classList.add("show");
  loginForm.classList.add("active");
  registerForm.classList.remove("active");
}

// Fonction pour ouvrir le modal et afficher register
function showRegister() {
  modal.classList.add("show");
  registerForm.classList.add("active");
  loginForm.classList.remove("active");
}

// Ajoute l'événement à tous les boutons Connexion
openLoginButtons.forEach(btn => btn.addEventListener("click", showLogin));

// Ajoute l'événement à tous les boutons S'inscrire
openRegisterButtons.forEach(btn => btn.addEventListener("click", showRegister));

// Fermer le modal
closeModal.addEventListener("click", () => modal.classList.remove("show"));
window.addEventListener("click", (e) => { if (e.target === modal) modal.classList.remove("show"); });

// Toggle Login <-> Register
toRegister.addEventListener("click", () => {
  loginForm.classList.remove("active");
  registerForm.classList.add("active");
});
toLogin.addEventListener("click", () => {
  registerForm.classList.remove("active");
  loginForm.classList.add("active");
});

 // Faire disparaître les messages flash après 3 secondes
  setTimeout(function() {
    const flash = document.getElementById('flash-messages');
    if (flash) {
      flash.style.transition = "opacity 0.5s ease";
      flash.style.opacity = 0;
      setTimeout(() => flash.remove(), 500); // supprime après fade out
    }
  }, 4000);

  // ================= NOTIFICATIONS SYSTEM =================
let notificationCheckInterval;

function loadNotifications() {
  if (!document.getElementById('notificationBell')) return;
  
  fetch('/api/notifications')
    .then(res => {
      if (!res.ok) throw new Error('Network response was not ok');
      return res.json();
    })
    .then(notifications => {
      console.log('Notifications chargées:', notifications); // Debug
      updateNotificationUI(notifications);
    })
    .catch(err => {
      console.error('Erreur chargement notifications:', err);
      // Afficher un état d'erreur
      updateNotificationUI([]);
    });
}

function updateNotificationUI(notifications) {
  const unreadCount = notifications.filter(n => !n.is_read).length;
  
  console.log('Notifications non lues:', unreadCount); // Debug
  
  // Mettre à jour les compteurs
  const notificationCount = document.getElementById('notificationCount');
  const mobileCount = document.getElementById('mobileNotificationCount');
  
  if (notificationCount) {
    notificationCount.textContent = unreadCount;
    notificationCount.style.display = unreadCount > 0 ? 'flex' : 'none';
  }
  
  if (mobileCount) {
    mobileCount.textContent = unreadCount;
    mobileCount.style.display = unreadCount > 0 ? 'inline-flex' : 'none';
  }
  
  // Mettre à jour la liste
  const list = document.getElementById('notificationList');
  if (list) {
    if (notifications.length === 0) {
      list.innerHTML = '<div class="notification-item"><div class="notification-message">Aucune notification</div></div>';
    } else {
      list.innerHTML = notifications.map(notif => `
        <div class="notification-item ${notif.is_read ? '' : 'unread'}" 
             onclick="handleNotificationClick(${notif.id}, '${notif.ressource_type}', ${notif.ressource_id})">
          <div class="notification-message">${notif.message}</div>
          <div class="notification-time">${formatTimeAgo(notif.created_at)}</div>
        </div>
      `).join('');
    }
  }
}

function handleNotificationClick(notificationId, ressourceType, ressourceId) {
  console.log('Clic sur notification:', notificationId, ressourceType, ressourceId); // Debug
  
  // Marquer comme lu
  fetch(`/api/notifications/read/${notificationId}`, { method: 'POST' })
    .then(() => {
      // Recharger les notifications pour mettre à jour l'UI
      loadNotifications();
    })
    .catch(err => console.error('Erreur marquage comme lu:', err));
  
  // Rediriger selon le type de ressource
  if (ressourceType === 'youtube' || ['mp4','mov','avi','mkv','webm'].includes(ressourceType)) {
    window.location.href = `/videos#video-${ressourceId}`;
  } else {
    window.location.href = `/communaute#ressource-${ressourceId}`;
  }
}

function formatTimeAgo(dateStr) {
  const now = new Date();
  const date = new Date(dateStr);
  const diffSec = Math.floor((now - date) / 1000);
  
  if (diffSec < 60) return "à l'instant";
  if (diffSec < 3600) {
    const m = Math.floor(diffSec / 60);
    return `il y a ${m} minute${m > 1 ? 's' : ''}`;
  }
  if (diffSec < 86400) {
    const h = Math.floor(diffSec / 3600);
    return `il y a ${h} heure${h > 1 ? 's' : ''}`;
  }
  if (diffSec < 604800) {
    const d = Math.floor(diffSec / 86400);
    return `il y a ${d} jour${d > 1 ? 's' : ''}`;
  }
  return date.toLocaleDateString('fr-FR');
}

// Gestionnaire d'événements pour la cloche
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM chargé - Initialisation notifications'); // Debug
  
  const bell = document.getElementById('notificationBell');
  const dropdown = document.getElementById('notificationDropdown');
  const markAllRead = document.getElementById('markAllRead');
  
  // Charger les notifications immédiatement au chargement de la page
  loadNotifications();
  
  if (bell && dropdown) {
    bell.addEventListener('click', function(e) {
      e.stopPropagation();
      console.log('Clic sur cloche'); // Debug
      dropdown.classList.toggle('show');
      loadNotifications(); // Recharger à chaque ouverture
    });
    
    // Fermer en cliquant ailleurs
    document.addEventListener('click', function() {
      dropdown.classList.remove('show');
    });
    
    dropdown.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  }
  
  if (markAllRead) {
    markAllRead.addEventListener('click', function() {
      console.log('Marquer tout comme lu'); // Debug
      fetch('/api/notifications/read_all', { method: 'POST' })
        .then(() => {
          loadNotifications();
          dropdown.classList.remove('show');
        })
        .catch(err => console.error('Erreur marquage tout comme lu:', err));
    });
  }
  
  // Boutons mobile
  const openLoginMobile = document.getElementById('openLoginMobile');
  const openRegisterMobile = document.getElementById('openRegisterMobile');
  
  if (openLoginMobile) openLoginMobile.addEventListener('click', showLogin);
  if (openRegisterMobile) openRegisterMobile.addEventListener('click', showRegister);
  
  // Vérifier les nouvelles notifications toutes les 30 secondes
  if (document.getElementById('notificationBell')) {
    notificationCheckInterval = setInterval(loadNotifications, 30000);
  }
});

// Nettoyer l'intervalle quand la page est quittée
window.addEventListener('beforeunload', function() {
  if (notificationCheckInterval) {
    clearInterval(notificationCheckInterval);
  }
});

  </script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  {%block script%}
    {%endblock%}
</body>
</html>
