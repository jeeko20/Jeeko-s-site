{% extends 'base.html' %}
{% block title %}Notes | Univloop{% endblock %}
{% block description %}Consulte et partage tes notes sur Univloop.{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/note.css') }}">
<style>
  /* Grille uniforme */
  .ressources-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 24px;
    padding: 20px 0;
    align-items: start;
  }

  /* ‚úÖ CARTE DE HAUTEUR FIXE */
  .ressources-list {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    height: 520px; /* üîë Hauteur fixe pour TOUTES les cartes */
    overflow: hidden; /* Emp√™che tout d√©bordement */
  }

  /* En-t√™te : hauteur fixe */
  .ressource-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 18px 18px 12px;
    flex-shrink: 0; /* Ne r√©tr√©cit pas */
  }

  .ressource-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #f0f0f0;
    flex-shrink: 0;
  }

  .ressource-title {
    font-size: 1.1em;
    font-weight: 600;
    margin: 0;
    color: #212529;
    /* Troncature √† 2 lignes max */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.3;
  }

  /* M√©tadonn√©es : hauteur fixe */
  .ressource-meta-container {
    padding: 0 18px 12px;
    flex-shrink: 0;
  }

  .ressource-meta {
    display: flex;
    justify-content: space-between;
    font-size: 0.85em;
    color: #6c757d;
    flex-wrap: wrap;
    gap: 8px;
  }

  .ressource-subject {
    background: #e9ecef;
    padding: 2px 10px;
    border-radius: 20px;
    font-weight: 500;
    white-space: nowrap;
  }

  /* ‚úÖ M√âDIA : HAUTEUR FIXE ABSOLUE */
  .ressource-media {
    flex: 1; /* Prend tout l'espace restant */
    margin: 0 18px;
    border-radius: 8px;
    overflow: hidden;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  .ressource-media img,
  .ressource-media video {
    width: 100%;
    height: 100%;
    object-fit: contain; /* üîë Contient sans d√©former */
    background: white;
  }

  .ressource-media .icon-placeholder {
    text-align: center;
    color: #6c757d;
    padding: 20px;
  }

  .ressource-media .icon-placeholder i {
    font-size: 3em;
    margin-bottom: 12px;
    color: #007bff;
  }

  /* Actions : hauteur fixe */
  .ressource-actions {
    display: flex;
    gap: 10px;
    padding: 12px 18px 18px;
    border-top: 1px solid #eee;
    flex-shrink: 0;
  }

  .ressource-actions button {
    flex: 1;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
  }

  .btn-view { background: #007bff; color: white; }
  .btn-view:hover { background: #0069d9; }
  .btn-download { background: #28a745; color: white; }
  .btn-download:hover { background: #218838; }
  .btn-delete { background: #dc3545; color: white; }
  .btn-delete:hover { background: #c82333; }

  /* =============== STYLE PAGINATION =============== */
  .pagination {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin: 30px 0;
    flex-wrap: wrap;
  }

  .pagination button {
    padding: 8px 14px;
    border: 1px solid #dee2e6;
    background: #fff;
    color: #007bff;
    cursor: pointer;
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s ease;
    min-width: 40px;
    text-align: center;
  }

  .pagination button:hover {
    background: #e9ecef;
    border-color: #adb5bd;
    transform: translateY(-1px);
  }

  .pagination .current-page {
    padding: 8px 14px;
    background: #007bff;
    color: white;
    border-radius: 6px;
    font-weight: 600;
    min-width: 40px;
    text-align: center;
    border: 1px solid #007bff;
  }

  .pagination button:disabled {
    background: #f8f9fa;
    color: #6c757d;
    cursor: not-allowed;
    transform: none;
  }

  .pagination button:first-child,
  .pagination button:last-child {
    padding: 8px 16px;
    font-weight: 600;
  }

  /* Responsive mobile */
  @media (max-width: 768px) {
    .ressources-grid {
      grid-template-columns: 1fr;
      gap: 16px;
    }
    .ressources-list {
      height: 480px; /* Un peu moins sur mobile */
    }
    
    .pagination {
      gap: 4px;
      margin: 20px 0;
    }
    
    .pagination button {
      padding: 6px 10px;
      min-width: 36px;
      font-size: 0.9em;
    }
    
    .pagination .current-page {
      padding: 6px 10px;
      min-width: 36px;
    }
  }

  /* Animation pour le changement de page */
  .ressources-grid {
    transition: opacity 0.3s ease;
  }

  .ressources-grid.loading {
    opacity: 0.6;
  }
  /* Styles pour les notes */
.notes-section {
    margin-bottom: 30px;
}

.notes-section h3 {
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f0f0f0;
    color: #333;
}

.notes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}

.note-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #007bff;
    transition: transform 0.2s ease;
}

.note-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.note-header {
    margin-bottom: 10px;
}

.note-type-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: 500;
    margin-bottom: 8px;
}

.note-type-badge.shared {
    background: #e8f5e8;
    color: #28a745;
}

.note-type-badge.saved {
    background: #e3f2fd;
    color: #007bff;
}

.note-title {
    font-size: 1.1em;
    font-weight: 600;
    margin: 0;
    color: #333;
    line-height: 1.3;
}

.note-meta {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
    font-size: 0.9em;
    color: #666;
}

.note-subject {
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: 500;
}

.note-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.note-actions button {
    flex: 1;
    min-width: 80px;
    padding: 6px 10px;
    font-size: 0.85em;
}

.empty-state, .error-state {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.empty-state h3, .error-state h3 {
    margin-bottom: 10px;
    color: #333;
}

/* Animation pour le compteur */
.info {
    font-weight: bold;
    transition: all 0.5s ease;
}

.info.updated {
    transform: scale(1.2);
    color: #6c5ce7;
}

/* Responsive */
@media (max-width: 768px) {
    .notes-grid {
        grid-template-columns: 1fr;
    }
    
    .note-actions {
        flex-direction: column;
    }
    
    .note-actions button {
        min-width: 100%;
    }
}
</style>  
{% endblock %}

{% block content %}
<!-- ================= HEADER ================= -->
<header class="header">
  <div class="header-content">
    <h1>Bienvenue sur votre espace de notes</h1>
    <p>G√©rez et partagez vos notes facilement</p>
    <div class="header-buttons">
      <a href="#" onclick="shareRessourceFromProfile()" class="btn btn-primary" style="color: black !important;">Partager une ressource</a>
    </div>
  </div>

  <div data-aos="zoom-in" class="info-matiere">
    <div>
        <span class="info" id="total-notes">0</span>
        <span>Notes Totales</span>
    </div>
    <div>
        <span class="info" id="total-saved">0</span>
        <span>Sauvegard√©es</span>
    </div>
    <div>
        <span class="info" id="total-shared">0</span>
        <span>Partag√©es</span>
    </div>
    <div>
        <span class="info" id="total-subjects">0</span>
        <span>Matieres</span>
    </div>
</div>
</header>

<!-- Navigation -->
<nav>
  <button class="tab active" data-page="all_note"><i class="fa-solid fa-file"></i>&nbsp;mes notes</button>
  <button class="tab" data-page="Partagees"><i class="fa-solid fa-bookmark"></i>&nbsp;sauvegarder</button>
  <button class="tab" onclick="window.location.href='/videos'" 
          style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <i class="fa-solid fa-video"></i>&nbsp;vid√©os
  </button>
</nav>

<div class="filter">
  <div>
    <label for="matiere">Mati√®re :</label>
    <select name="matiere" id="matiere">
      <option value="">Toutes</option>
      <option value="javascript">JavaScript</option>
      <option value="HTML">HTML</option>
      <option value="CSS">CSS</option>
      <option value="Algorithme">Algorithme</option>
      <option value="C++">C++</option>
      <option value="systeme">Syst√®me</option>
      <option value="autre">Autre</option>
    </select>

    <label for="tri">Trier par :</label>
    <select name="tri" id="tri">
      <option value="date-desc">Plus r√©cent</option>
      <option value="date-asc">Plus ancien</option>
      <option value="title-asc">Titre (A-Z)</option>
      <option value="title-desc">Titre (Z-A)</option>
      <option value="subject-asc">Mati√®re (A-Z)</option>
      <option value="subject-desc">Mati√®re (Z-A)</option>
    </select>
  </div>

  <div class="search-box">
    <label for="search"><i class="fa-solid fa-magnifying-glass"></i></label>
    <input type="search" id="search" placeholder="Rechercher dans mes notes">
  </div>
</div>

<main>
  <section id="all_note" class="page active">
    <div id="my-ressources-container"></div>
    <div id="my-pagination"></div> <!-- Conteneur de pagination pour mes notes -->
  </section>

  <section id="Partagees" class="page">
    <div id="saved-ressources-container"></div>
    <div id="saved-pagination"></div> <!-- Conteneur de pagination pour les sauvegardes -->
  </section>
</main>
{% endblock %}

{% block script %}
<script>
const ITEMS_PER_PAGE = 10;
let myRessources = [];
let savedRessources = [];
let currentPageMy = 1;
let currentPageSaved = 1;

// Fonction de suppression d'une ressource
async function deleteRessource(id) {
    if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette ressource ?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/ressource/${id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            // Recharger les donn√©es apr√®s la suppression
            await loadAllData();
            alert('Ressource supprim√©e avec succ√®s');
        } else {
            alert('Erreur lors de la suppression de la ressource');
        }
    } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la suppression de la ressource');
    }
}

// Fonction de tri des ressources
function sortRessources(ressources, sortBy) {
    return [...ressources].sort((a, b) => {
        switch(sortBy) {
            case 'date-desc':
                return new Date(b.created_at) - new Date(a.created_at);
            case 'date-asc':
                return new Date(a.created_at) - new Date(b.created_at);
            case 'title-asc':
                return a.title.localeCompare(b.title);
            case 'title-desc':
                return b.title.localeCompare(a.title);
            case 'subject-asc':
                return a.subject.localeCompare(b.subject);
            case 'subject-desc':
                return b.subject.localeCompare(a.subject);
            default:
                return 0;
        }
    });
}

let originalMyRessources = [];
let originalSavedRessources = [];

async function loadAllData() {
    try {
        // Charger mes ressources
        const myRes = await fetch('/api/my_ressources');
        let fetchedMyRessources = await myRes.json();
        originalMyRessources = groupRessourcesByTitle(fetchedMyRessources);

        // Charger les IDs des ressources sauvegard√©es
        const savedRes = await fetch('/api/saved_ressources');
        const savedList = await savedRes.json();
        const savedIds = new Set(savedList.map(s => s.id));
        
        // üî• SOLUTION SIMPLE : Charger TOUTES les ressources de la communaut√© pour filtrer les sauvegard√©es
        const allRes = await fetch('/api/ressources');
        const allRessources = await allRes.json();
        const allGrouped = groupRessourcesByTitle(allRessources);
        
        // Filtrer pour garder seulement les ressources group√©es qui sont sauvegard√©es
        originalSavedRessources = allGrouped.filter(group => {
            // V√©rifier si au moins un fichier de ce groupe est sauvegard√©
            return group.files.some(file => savedIds.has(file.id));
        });

        // Appliquer les filtres et le tri apr√®s le chargement initial
        applyFilters();

        // Mettre √† jour les statistiques
        document.getElementById('total-notes').textContent = originalMyRessources.length + originalSavedRessources.length;
        document.getElementById('total-shared').textContent = originalMyRessources.length;
        document.getElementById('total-saved').textContent = originalSavedRessources.length;

        // Compter les mati√®res uniques
        const allSubjects = new Set();
        originalMyRessources.forEach(r => allSubjects.add(r.subject));
        originalSavedRessources.forEach(r => allSubjects.add(r.subject));
        document.getElementById('total-subjects').textContent = allSubjects.size;

    } catch (err) {
        console.error("Erreur lors du chargement des donn√©es:", err);
        // G√©rer l'affichage d'erreur si n√©cessaire
    }
}

function applyFilters() {
    const searchTerm = document.getElementById('search').value.toLowerCase().trim();
    const subjectFilter = document.getElementById('matiere').value;
    const sortBy = document.getElementById('tri').value;
    
    // Filtrer mes ressources
    let filteredMy = [...originalMyRessources]; // Travailler sur une copie
    if (searchTerm !== '') {
        filteredMy = filteredMy.filter(ressource => {
            return ressource.title.toLowerCase().includes(searchTerm) ||
                   ressource.subject.toLowerCase().includes(searchTerm);
        });
    }
    
    if (subjectFilter !== '') {
        filteredMy = filteredMy.filter(ressource => {
            const ressourceSubjectLower = ressource.subject.toLowerCase();
            if (subjectFilter === 'autre') {
                const predefined = ['javascript', 'html', 'css', 'algorithme', 'c++', 'systeme'];
                return !predefined.includes(ressourceSubjectLower);
            } else {
                return ressourceSubjectLower === subjectFilter.toLowerCase();
            }
        });
    }
    
    // Trier
    filteredMy = sortRessources(filteredMy, sortBy);
    
    // Filtrer les ressources sauvegard√©es
    let filteredSaved = [...originalSavedRessources]; // Travailler sur une copie
    if (searchTerm !== '') {
        filteredSaved = filteredSaved.filter(ressource => {
            return ressource.title.toLowerCase().includes(searchTerm) ||
                   ressource.subject.toLowerCase().includes(searchTerm);
        });
    }
    
    if (subjectFilter !== '') {
        filteredSaved = filteredSaved.filter(ressource => {
            const ressourceSubjectLower = ressource.subject.toLowerCase();
            if (subjectFilter === 'autre') {
                const predefined = ['javascript', 'html', 'css', 'algorithme', 'c++', 'systeme'];
                return !predefined.includes(ressourceSubjectLower);
            } else {
                return ressourceSubjectLower === subjectFilter.toLowerCase();
            }
        });
    }

    // Trier les sauvegard√©es
    filteredSaved = sortRessources(filteredSaved, sortBy);

    // R√©initialiser les pages et afficher
    currentPageMy = 1;
    currentPageSaved = 1;
    
    renderPaginatedMy(filteredMy, currentPageMy);
    renderPaginatedSaved(filteredSaved, currentPageSaved);
}

function renderPaginatedMy(list, page) {
  currentPageMy = page;
  const totalPages = Math.ceil(list.length / ITEMS_PER_PAGE);
  const start = (page - 1) * ITEMS_PER_PAGE;
  const paginated = list.slice(start, start + ITEMS_PER_PAGE);
  renderRessources(paginated, 'my-ressources-container');
  renderPagination(totalPages, page, (newPage) => {
    renderPaginatedMy(list, newPage);
  }, 'my-ressources-container', 'my-pagination');
}

function renderPaginatedSaved(list, page) {
  currentPageSaved = page;
  const totalPages = Math.ceil(list.length / ITEMS_PER_PAGE);
  const start = (page - 1) * ITEMS_PER_PAGE;
  const paginated = list.slice(start, start + ITEMS_PER_PAGE);
  renderRessources(paginated, 'saved-ressources-container');
  renderPagination(totalPages, page, (newPage) => {
    renderPaginatedSaved(list, newPage);
  }, 'saved-ressources-container', 'saved-pagination');
}

 // Fonction pour d√©terminer le type d'affichage
function getDisplayType(files) {
    if (!files || files.length === 0) return 'single';
    
    const imageCount = files.filter(f => 
        f.file_type && ['png','jpg','jpeg','gif'].includes(f.file_type.toLowerCase())
    ).length;
    
    const totalCount = files.length;
    
    console.log('Analyse fichiers:', { imageCount, totalCount, files });
    
    // Si seulement des images ET plus d'une image -> carousel
    if (imageCount === totalCount && totalCount > 1) {
        return 'carousel';
    }
    // Si m√©lange d'images et autres fichiers -> modal
    else if (imageCount > 0 && totalCount > 1) {
        return 'modal';
    }
    // Si seulement d'autres types de fichiers ET plus d'un fichier -> modal
    else if (totalCount > 1) {
        return 'modal';
    }
    // Si un seul fichier -> affichage simple
    else {
        return 'single';
    }
}
// Fonction modifi√©e pour cr√©er le HTML m√©dia
function createMediaHtml(files, ressourceId) {
    const displayType = getDisplayType(files);
    
    switch(displayType) {
        case 'carousel':
            // Uniquement des images -> carousel
            return `
                <div class="ressource-media">
                    ${createCarouselHtml(files, ressourceId)}
                </div>`;
        
        case 'modal':
            // M√©lange ou autres fichiers -> premier fichier + badge modal
            const firstFile = files[0];
            return `
                <div class="ressource-media" style="position: relative;">
                    ${createSingleMediaHtml(firstFile, ressourceId, false)}
                    <div class="multi-file-badge" onclick="openTreeModal(${ressourceId}, false)" style="cursor: pointer;">
                        <i class="fa-solid fa-folder-open"></i> 
                        ${files.length} fichiers
                    </div>
                </div>`;
        
        case 'single':
            // Un seul fichier -> affichage simple
            const singleFile = files[0];
            const isZip = singleFile.file_type === 'zip';
            
            if (isZip) {
                return `
                    <div class="ressource-media" onclick="openTreeModal(${ressourceId}, true)" style="cursor: pointer;">
                        ${createSingleMediaHtml(singleFile, ressourceId, false)}
                    </div>`;
            } else {
                return `
                    <div class="ressource-media">
                        ${createSingleMediaHtml(singleFile, ressourceId, false)}
                    </div>`;
            }
    }
}
 function renderRessources(list, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    if (list.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding:30px; color:#777; font-size:1.1em;">Aucune ressource.</p>';
        return;
    }

    container.innerHTML = '<div class="ressources-grid"></div>';
    const grid = container.querySelector('.ressources-grid');

    list.forEach(r => {
        const date = new Date(r.created_at).toLocaleDateString('fr-FR');
        
        // √âtat de sauvegarde
        const isSaved = r.is_saved || false;
        const bookmarkIconClass = isSaved ? 'fa-solid fa-bookmark' : 'fa-regular fa-bookmark';
        const bookmarkColor = isSaved ? '#007bff' : '#ccc';

        // üî• NOUVELLE LOGIQUE : Utiliser createMediaHtml
        const mediaHtml = createMediaHtml(r.files, r.id);

        grid.innerHTML += `
            <div class="ressources-list" data-ressource-id="${r.id}">
                <div class="ressource-header">
                    <img src="${r.user_avatar}" 
                         alt="Avatar" 
                         class="ressource-avatar"
                         loading="lazy"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9Ijc1IiB5PSI3NSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSI+QXZhdGFyPC90ZXh0Pjwvc3ZnPg=='">
                    <h3 class="ressource-title">${r.title}</h3>
                    <div class="save-icon" onclick="toggleSaveRessource(${r.id}, this)">
                        <i class="${bookmarkIconClass}" style="color: ${bookmarkColor};"></i>
                    </div>
                </div>
                
                <div class="ressource-meta">
                    <span class="ressource-subject">${r.subject}</span>
                    <span>par ${r.username || 'Utilisateur'}</span>
                </div>

                ${mediaHtml}

                <div class="ressource-meta">
                    <span>${date}</span>
                    <span>${r.files[0].page_count ? r.files[0].page_count + ' pages' : '‚Äî'}</span>
                </div>

                <div class="ressource-actions">
                    ${r.files[0].is_video ? `
                        <button class="btn-view" onclick="window.location.href='/videos#video-${r.id}'" style="background: #667eea;">
                            <i class="fa-solid fa-video"></i> Voir la vid√©o
                        </button>
                    ` : `
                        <button class="btn-view" onclick="handleViewClick(${r.id}, ${r.files.length > 1})">
                            <i class="fa-solid fa-eye"></i> Voir
                        </button>
                    `}
                    <button class="btn-download" onclick="downloadRessource(${r.id})">
                        <i class="fa-solid fa-download"></i> T√©l√©charger
                    </button>
                </div>
            </div>`;
    });
}

// Fonction pour g√©rer le clic sur le bouton "Voir"
function handleViewClick(ressourceId, hasMultipleFiles) {
    if (hasMultipleFiles) {
        // Ouvrir le modal d'exploration
        openTreeModal(ressourceId, false);
    } else {
        // Ouvrir le fichier unique directement
        const ressource = ressources.find(r => r.id === ressourceId) || 
                         filteredRessources.find(r => r.id === ressourceId);
        if (ressource && ressource.files.length === 1) {
            const file = ressource.files[0];
            if (file.is_video) {
                window.location.href = `/videos#video-${ressourceId}`;
            } else {
                window.open(file.file_url, '_blank');
            }
        }
    }
}

// Fonction pour afficher les fichiers multiples dans le modal
function renderMultipleFilesModal(files, ressourceTitle) {
    showTreeModal(ressourceTitle, false);
    
    const treeContainer = document.getElementById('tree-container');
    treeContainer.innerHTML = '';
    
    files.forEach((file, index) => {
        const item = document.createElement('div');
        item.className = 'tree-item file';
        
        const fileType = file.file_type || 'file';
        const icon = getFileIcon(fileType);
        const fileName = file.title || `Fichier ${index + 1}.${fileType}`;
        
        item.innerHTML = `
            ${icon}
            <span>${fileName}</span>
            <small style="margin-left: auto; color: #6c757d;">
                ${file.page_count ? `${file.page_count} pages` : ''}
            </small>
        `;
        
        item.addEventListener('click', () => {
            if (file.is_video || ['mp4','mov','avi','mkv','webm'].includes(fileType)) {
                window.location.href = `/videos#video-${currentTreeRessource}`;
            } else if (fileType === 'zip') {
                // Si c'est un ZIP dans une ressource multiple, charger sa structure
                loadZipStructureFromFile(file, ressourceTitle);
            } else {
                // Si c'est un fichier texte (js, json, c, etc.) -> pr√©visualiser
                const TEXT_FILE_TYPES = ['txt','md','json','js','ts','py','c','cpp','java','xml','csv','html','css','scss','less','yaml','yml','ini','sh','bat','rs','go','rb','php','sql'];
                if (TEXT_FILE_TYPES.includes((fileType || '').toLowerCase())) {
                    previewRemoteFile(file.download_url || file.file_url, fileName, fileType);
                } else {
                    // Ouvrir le fichier directement
                    window.open(file.file_url || file.download_url, '_blank');
                }
            }
        });
        
        treeContainer.appendChild(item);
    });
}
// Pr√©visualiser un fichier distant (essaye fetch direct puis bascule sur le proxy serveur si CORS)
async function previewRemoteFile(url, filename, fileType) {
    const contentContainer = document.getElementById('file-content-container');
    contentContainer.innerHTML = '<p style="text-align:center">Chargement...</p>';

    // Helper pour afficher texte
    const showText = (text) => {
        contentContainer.innerHTML = `
            <div class="file-content">
                <h4>${filename}</h4>
                <pre class="text-content">${escapeHtml(text)}</pre>
            </div>`;
    };

    try {
        // Essayer fetch direct (peut √©chouer √† cause du CORS)
        const resp = await fetch(url);
        if (resp.ok) {
            const ct = resp.headers.get('content-type') || '';
            if (ct.startsWith('image/')) {
                const blob = await resp.blob();
                const blobUrl = URL.createObjectURL(blob);
                contentContainer.innerHTML = `
                    <div class="file-content">
                        <h4>${filename}</h4>
                        <img src="${blobUrl}" alt="${filename}" style="max-width:100%" />
                    </div>`;
                return;
            }

            if (ct.includes('text') || ct.includes('json') || filename.match(/\.(js|json|py|c|cpp|java|xml|css|html|md|txt|sh|sql)$/i)) {
                const text = await resp.text();
                showText(text);
                return;
            }

            // Pour les autres types, proposer d'ouvrir dans un nouvel onglet
            const blob = await resp.blob();
            const blobUrl = URL.createObjectURL(blob);
            contentContainer.innerHTML = `
                <div class="file-content">
                    <h4>${filename}</h4>
                    <p>Ce type de fichier ne peut pas √™tre pr√©visualis√©. <a href="${blobUrl}" target="_blank">Ouvrir / T√©l√©charger</a></p>
                </div>`;
            return;
        }
    } catch (err) {
        console.warn('Fetch direct failed (CORS?):', err);
    }

    // Fallback : utiliser le proxy serveur /api/ressources/download
    try {
        const proxyResp = await fetch('/api/ressources/download', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ files: [url], title: filename || '' })
        });
        if (!proxyResp.ok) throw new Error('Proxy failed');
        const blob = await proxyResp.blob();
        const mime = blob.type || '';
        if (mime.startsWith('image/')) {
            const bUrl = URL.createObjectURL(blob);
            contentContainer.innerHTML = `
                <div class="file-content">
                    <h4>${filename}</h4>
                    <img src="${bUrl}" alt="${filename}" style="max-width:100%" />
                </div>`;
            return;
        }
        // Lire en texte si possible
        const text = await blob.text();
        showText(text);
        return;
    } catch (err) {
        console.error('Proxy preview failed:', err);
        contentContainer.innerHTML = '<p style="color:red; text-align:center;">Impossible de pr√©visualiser ce fichier.</p>';
    }
}
// Fonction pour charger la structure d'un fichier ZIP sp√©cifique
async function loadZipStructureFromFile(file, ressourceTitle) {
    try {
        const response = await fetch(file.download_url || file.file_url);
        const zipContent = await response.arrayBuffer();
        
        const structure = getZipStructure(new Uint8Array(zipContent));
        if (structure) {
            currentZipStructure = structure;
            renderTreeStructure(currentZipStructure);
            
            // Mettre √† jour le titre du modal
            const modalTitle = document.querySelector('.tree-modal-header h3');
            if (modalTitle) {
                modalTitle.textContent = `${ressourceTitle} - ${file.file_type.toUpperCase()}`;
            }
        }
    } catch (error) {
        console.error('Erreur chargement ZIP:', error);
        alert('Erreur lors du chargement du fichier ZIP');
    }
}
// Wire delete ressource actions (delegated since elements may be re-rendered)

function renderPagination(totalPages, currentPage, onPageChange, containerId, paginationId) {
  // Trouver ou cr√©er le conteneur de pagination
  let paginationContainer = document.getElementById(paginationId);
  const mainContainer = document.getElementById(containerId);
  
  if (!paginationContainer) {
    paginationContainer = document.createElement('div');
    paginationContainer.id = paginationId;
    if (mainContainer) {
      mainContainer.after(paginationContainer);
    }
  }

  /* ==========================
     T√©l√©chargement des ressources (images / pdf / multiple)
     (m√™me logique que dans communaute)
  ========================== */
  function getFilenameFromUrl(url){
    try{ const u = url.split('?')[0]; return decodeURIComponent(u.substring(u.lastIndexOf('/')+1)) || 'file'; }catch(e){return 'file';}
  }
  function sanitizeFilename(name){ return name.replace(/[^a-z0-9._-]/gi, '_'); }
  async function downloadUrlAsFile(url, filename){
    try{ const resp = await fetch(url); if(!resp.ok) throw new Error('Erreur r√©seau'); const blob = await resp.blob(); const a = document.createElement('a'); const objectUrl = URL.createObjectURL(blob); a.href = objectUrl; a.download = filename || getFilenameFromUrl(url); document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=> URL.revokeObjectURL(objectUrl), 10000); }
    catch(err){
      console.error('download error', err);
      try{
        const resp2 = await fetch('/api/ressources/download', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ files: [url], title: filename || '' })
        });
        if(!resp2.ok) throw new Error('Proxy failed');
        const blob2 = await resp2.blob();
        const a2 = document.createElement('a');
        const objectUrl2 = URL.createObjectURL(blob2);
        a2.href = objectUrl2;
        a2.download = filename || getFilenameFromUrl(url) || 'download';
        document.body.appendChild(a2);
        a2.click();
        a2.remove();
        setTimeout(()=> URL.revokeObjectURL(objectUrl2), 10000);
        return;
      }catch(proxyErr){
        console.error('proxy download error', proxyErr);
        alert('Erreur lors du t√©l√©chargement (CORS ou r√©seau).');
      }
    }
  }
  function ensureLibs(){ return new Promise((resolve)=>{ const libs = []; if(!window.JSZip){ libs.push(new Promise(res=>{ const s=document.createElement('script'); s.src='https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js'; s.onload=res; s.onerror=res; document.head.appendChild(s); })); } if(!window.saveAs){ libs.push(new Promise(res=>{ const s=document.createElement('script'); s.src='https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js'; s.onload=res; s.onerror=res; document.head.appendChild(s); })); } if(libs.length===0) return resolve(); Promise.all(libs).then(()=>resolve()).catch(()=>resolve()); }); }
  async function downloadRessource(ressourceId){
    let resObj = (typeof ressources !== 'undefined' && ressources ? ressources.find(r=>r.id == ressourceId) : null) || (typeof filteredRessources !== 'undefined' && filteredRessources ? filteredRessources.find(r=>r.id == ressourceId) : null);
    if(!resObj){ try{ const r = await fetch(`/api/ressources`); const all = await r.json(); resObj = all.find(x=>x.id==ressourceId); }catch(e){}
    }
    if(!resObj) return alert('Ressource introuvable pour le t√©l√©chargement.');
    const files = resObj.files || [];
    if(files.length === 0) return alert('Aucun fichier disponible.');
    if(files.length === 1){ const url = files[0].download_url || files[0].file_url; const name = getFilenameFromUrl(url) || (`ressource-${resObj.id}`); return downloadUrlAsFile(url, name); }
    // Plusieurs fichiers -> demander au serveur de cr√©er un ZIP (√©vite probl√®mes CORS)
    try{
      const urls = files.map(f => f.download_url || f.file_url);
      const resp = await fetch('/api/ressources/download', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ files: urls, title: resObj.title || `ressources-${resObj.id}` })
      });
      if(!resp.ok) throw new Error('Proxy ZIP failed');
      const blob = await resp.blob();
      const zipName = sanitizeFilename(resObj.title || `ressources-${resObj.id}`) + '.zip';
      const a = document.createElement('a');
      const objectUrl = URL.createObjectURL(blob);
      a.href = objectUrl;
      a.download = zipName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=> URL.revokeObjectURL(objectUrl), 10000);
    }catch(err){ console.error('proxy zip error', err); alert('Erreur lors du t√©l√©chargement du ZIP.'); }
  
  // Exposer les helpers et la fonction principale globalement pour les onclick inline
  try{
    window.getFilenameFromUrl = getFilenameFromUrl;
    window.sanitizeFilename = sanitizeFilename;
    window.downloadUrlAsFile = downloadUrlAsFile;
    window.ensureLibs = ensureLibs;
    window.downloadRessource = downloadRessource;
  }catch(e){ console.warn('Impossible d\'exposer download helpers globalement', e); }
  }
  
  if (totalPages <= 1) {
    paginationContainer.innerHTML = '';
    return;
  }

  let html = '<div class="pagination">';
  
  // Bouton pr√©c√©dent
  if (currentPage > 1) {
    html += `<button onclick="pageChangeHandler(${currentPage - 1}, '${paginationId}')" title="Page pr√©c√©dente">&laquo; Pr√©c√©dent</button>`;
  }
  
  // Pages - afficher maximum 7 pages pour ne pas surcharger
  const maxVisiblePages = 7;
  let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
  let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
  
  // Ajuster si on est pr√®s du d√©but
  if (endPage - startPage + 1 < maxVisiblePages) {
    startPage = Math.max(1, endPage - maxVisiblePages + 1);
  }
  
  // Premi√®re page + points de suspension si n√©cessaire
  if (startPage > 1) {
    html += `<button onclick="pageChangeHandler(1, '${paginationId}')">1</button>`;
    if (startPage > 2) {
      html += `<span style="padding: 8px 6px; color: #6c757d;">...</span>`;
    }
  }
  
  // Pages principales
  for (let i = startPage; i <= endPage; i++) {
    if (i === currentPage) {
      html += `<span class="current-page">${i}</span>`;
    } else {
      html += `<button onclick="pageChangeHandler(${i}, '${paginationId}')">${i}</button>`;
    }
  }
  
  // Derni√®re page + points de suspension si n√©cessaire
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      html += `<span style="padding: 8px 6px; color: #6c757d;">...</span>`;
    }
    html += `<button onclick="pageChangeHandler(${totalPages}, '${paginationId}')">${totalPages}</button>`;
  }
  
  // Bouton suivant
  if (currentPage < totalPages) {
    html += `<button onclick="pageChangeHandler(${currentPage + 1}, '${paginationId}')" title="Page suivante">Suivant &raquo;</button>`;
  }
  
  html += '</div>';
  paginationContainer.innerHTML = html;
  
  // Stocker le callback
  paginationContainer._pageChangeCallback = onPageChange;
}
function renderPaginatedMy(list, page) {
  currentPageMy = page;
  const totalPages = Math.ceil(list.length / ITEMS_PER_PAGE);
  const start = (page - 1) * ITEMS_PER_PAGE;
  const paginated = list.slice(start, start + ITEMS_PER_PAGE);
  
  // Animation de chargement
  const container = document.getElementById('my-ressources-container');
  if (container) {
    container.style.opacity = '0.6';
    setTimeout(() => {
      renderRessources(paginated, 'my-ressources-container');
      container.style.opacity = '1';
    }, 150);
  }
  
  renderPagination(totalPages, page, (newPage) => {
    renderPaginatedMy(list, newPage);
  }, 'my-ressources-container', 'my-pagination');
}

// Gestionnaire global pour les changements de page
function pageChangeHandler(page, paginationId) {
  const container = document.getElementById(paginationId);
  if (container && container._pageChangeCallback) {
    container._pageChangeCallback(page);
  }
}

// Filtres et recherche
function setupFilters() {
  const matiereSelect = document.getElementById('matiere');
  const triSelect = document.getElementById('tri');
  const searchInput = document.getElementById('search');

  if (matiereSelect) {
    matiereSelect.addEventListener('change', applyFilters);
  }
  if (triSelect) {
    triSelect.addEventListener('change', applyFilters);
  }
  if (searchInput) {
    searchInput.addEventListener('input', applyFilters);
  }
}

// Navigation entre onglets
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.page).classList.add("active");
  });
});

// Initialisation
document.addEventListener('DOMContentLoaded', () => {
  loadAllData();
  setupFilters();
});

function shareRessourceFromProfile() {
    // Marquer qu'on veut ouvrir le formulaire
    sessionStorage.setItem('openShareForm', 'true');
    
    // Rediriger
    window.location.href = "{{ url_for('communaute') }}";
}

// carroussel
// =============== FONCTIONS DE REGROUPEMENT ===============

function groupRessourcesByTitle(ressources) {
    const grouped = {};
    
    ressources.forEach(ressource => {
        const key = `${ressource.title}-${ressource.subject}-${ressource.user_id}`;
        
        if (!grouped[key]) {
            grouped[key] = {
                id: ressource.id, // Garder le premier ID
                title: ressource.title,
                subject: ressource.subject,
                user_id: ressource.user_id,
                username: ressource.username,
                user_avatar: ressource.user_avatar,
                created_at: ressource.created_at,
                likes: ressource.likes,
                is_saved: ressource.is_saved,
                page_count: ressource.page_count,
                files: [{
                    id: ressource.id, // üî• TR√àS IMPORTANT : inclure l'ID original
                    file_url: ressource.file_url,
                    download_url: ressource.download_url,
                    file_type: ressource.file_type,
                    page_count: ressource.page_count,
                    is_video: ressource.is_video
                }],
                is_multiple: false
            };
        } else {
            grouped[key].files.push({
                id: ressource.id, // üî• TR√àS IMPORTANT : inclure l'ID original
                file_url: ressource.file_url,
                download_url: ressource.download_url,
                file_type: ressource.file_type,
                page_count: ressource.page_count,
                is_video: ressource.is_video
            });
        }
    });
    
    // Marquer les groupes multiples
    const result = Object.values(grouped).map(group => {
        if (group.files.length > 1) {
            group.is_multiple = true;
        }
        return group;
    });
    
    return result;
}

// =============== FONCTIONS POUR LE CAROUSEL ===============

function createCarouselHtml(files, ressourceId) {
    let slidesHtml = '';
    files.forEach((file, index) => {
        slidesHtml += `
            <div class="carousel-slide" data-index="${index}">
                ${createSingleMediaHtml(file, ressourceId, true)}
            </div>`;
    });

    let indicatorsHtml = '';
    files.forEach((_, index) => {
        const isActive = index === 0 ? 'active' : '';
        indicatorsHtml += `<button class="carousel-indicator ${isActive}" data-index="${index}"></button>`;
    });

    return `
        <div class="ressource-carousel" id="carousel-${ressourceId}">
            <div class="carousel-count">1/${files.length}</div>
            <div class="multi-file-badge">
                <i class="fa-solid fa-layer-group"></i> ${files.length} fichiers
            </div>
            <div class="carousel-track">
                ${slidesHtml}
            </div>
            ${files.length > 1 ? `
                <button class="carousel-nav carousel-prev" onclick="carouselPrev('${ressourceId}')">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
                <button class="carousel-nav carousel-next" onclick="carouselNext('${ressourceId}')">
                    <i class="fa-solid fa-chevron-right"></i>
                </button>
                <div class="carousel-indicators">
                    ${indicatorsHtml}
                </div>
            ` : ''}
        </div>`;
}

function createSingleMediaHtml(file, ressourceId, isInCarousel = false) {
    const containerClass = isInCarousel ? 'carousel-media' : '';
    const { file_url, file_type, is_video } = file;

    if (is_video || ['mp4','mov','avi','mkv','webm'].includes(file_type)) {
        return `
            <div class="${containerClass}" style="cursor: pointer;" onclick="window.location.href='/videos#video-${ressourceId}'">
                <div class="carousel-icon-placeholder" style="padding: 25px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px;">
                    <i class="fa-solid fa-video" style="font-size: 2.5em; margin-bottom: 12px;"></i>
                    <p style="margin: 0; font-weight: 500;">üìπ Vid√©o disponible</p>
                    <p style="margin: 8px 0 0 0; font-size: 0.9em; opacity: 0.9;">Cliquez pour voir dans la page Vid√©os</p>
                </div>
            </div>`;
    } else if (['png','jpg','jpeg','gif'].includes(file_type)) {
        return `
            <div class="${containerClass}">
                <img src="${file_url}" alt="Image" 
                     loading="lazy" 
                     style="width: 100%; height: 100%; object-fit: contain;"
                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5Ij5JbWFnZTwvdGV4dD48L3N2Zz4='">
            </div>`;
    } else if (file_type === 'pdf') {
        return `
            <div class="${containerClass}">
                <div class="carousel-icon-placeholder">
                    <i class="fa-solid fa-file-pdf"></i>
                    <p>Document PDF</p>
                    ${file.page_count ? `<small>${file.page_count} pages</small>` : ''}
                </div>
            </div>`;
    } else {
        return `
            <div class="${containerClass}">
                <div class="carousel-icon-placeholder">
                    <i class="fa-solid fa-file-lines"></i>
                    <p>${(file_type || 'DOC').toUpperCase()}</p>
                </div>
            </div>`;
    }
}

// =============== FONCTIONS DE NAVIGATION CAROUSEL ===============

function initializeCarousels() {
    document.querySelectorAll('.ressource-carousel').forEach(carousel => {
        const carouselId = carousel.id.replace('carousel-', '');
        carousel.currentSlide = 0;
        updateCarousel(carouselId);
    });
}

function carouselNext(carouselId) {
    const carousel = document.getElementById(`carousel-${carouselId}`);
    if (!carousel) return;
    
    const slides = carousel.querySelectorAll('.carousel-slide');
    carousel.currentSlide = (carousel.currentSlide + 1) % slides.length;
    updateCarousel(carouselId);
}

function carouselPrev(carouselId) {
    const carousel = document.getElementById(`carousel-${carouselId}`);
    if (!carousel) return;
    
    const slides = carousel.querySelectorAll('.carousel-slide');
    carousel.currentSlide = (carousel.currentSlide - 1 + slides.length) % slides.length;
    updateCarousel(carouselId);
}

function updateCarousel(carouselId) {
    const carousel = document.getElementById(`carousel-${carouselId}`);
    if (!carousel) return;
    
    const track = carousel.querySelector('.carousel-track');
    const slides = carousel.querySelectorAll('.carousel-slide');
    const indicators = carousel.querySelectorAll('.carousel-indicator');
    const count = carousel.querySelector('.carousel-count');
    
    if (!track || !slides.length) return;
    
    const slideWidth = 100; // 100% par slide
    track.style.transform = `translateX(-${carousel.currentSlide * slideWidth}%)`;
    
    // Mettre √† jour les indicateurs
    indicators.forEach((indicator, index) => {
        indicator.classList.toggle('active', index === carousel.currentSlide);
    });
    
    // Mettre √† jour le compteur
    if (count) {
        count.textContent = `${carousel.currentSlide + 1}/${slides.length}`;
    }
}

// Navigation par indicateurs et swipe
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('carousel-indicator')) {
        const carousel = e.target.closest('.ressource-carousel');
        const carouselId = carousel.id.replace('carousel-', '');
        const index = parseInt(e.target.getAttribute('data-index'));
        if (carousel && !isNaN(index)) {
            carousel.currentSlide = index;
            updateCarousel(carouselId);
        }
    }
});

// Support du swipe sur mobile
let touchStartX = 0;
let touchEndX = 0;

document.addEventListener('touchstart', e => {
    touchStartX = e.changedTouches[0].screenX;
});

document.addEventListener('touchend', e => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
});

function handleSwipe() {
    const swipeThreshold = 50;
    const diff = touchStartX - touchEndX;
    
    if (Math.abs(diff) > swipeThreshold) {
        const activeCarousel = document.querySelector('.ressource-carousel:hover') || 
                             document.querySelector('.ressource-media:has(.ressource-carousel:hover)');
        
        if (activeCarousel) {
            const carouselId = activeCarousel.id.replace('carousel-', '');
            if (diff > 0) {
                // Swipe gauche ‚Üí suivant
                carouselNext(carouselId);
            } else {
                // Swipe droite ‚Üí pr√©c√©dent
                carouselPrev(carouselId);
            }
        }
    }
}
</script>
<script>
  // Fonction pour charger les statistiques des notes
async function loadNotesStats() {
    try {
        console.log('Chargement des statistiques des notes...');
        
        const response = await fetch('/api/notes/stats');
        const result = await response.json();
        
        if (result.success) {
            const stats = result.stats;
            
            // Mettre √† jour les √©l√©ments HTML avec les vraies donn√©es
            document.getElementById('total-notes').textContent = stats.total_notes;
            document.getElementById('total-saved').textContent = stats.total_saved;
            document.getElementById('total-shared').textContent = stats.total_shared;
            document.getElementById('total-subjects').textContent = stats.total_subjects;
            
            console.log('Statistiques charg√©es:', stats);
        } else {
            console.error('Erreur dans les stats:', result.error);
            // Garder les valeurs par d√©faut (0)
        }
    } catch (error) {
        console.error('Erreur lors du chargement des stats:', error);
        // En cas d'erreur, les valeurs restent √† 0
    }
}

// Fonction pour charger les notes d√©taill√©es
async function loadMyNotes() {
    try {
        const response = await fetch('/api/my_notes');
        const result = await response.json();
        
        if (result.success) {
            console.log(`Chargement de ${result.notes.length} notes`);
            renderNotesList(result.notes);
        } else {
            console.error('Erreur chargement notes:', result.error);
            showNotesError();
        }
    } catch (error) {
        console.error('Erreur chargement notes:', error);
        showNotesError();
    }
}

// Fonction pour afficher la liste des notes
function renderNotesList(notes) {
    const container = document.getElementById('notes-list-container'); // √Ä cr√©er dans votre HTML
    if (!container) return;
    
    if (notes.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox" style="font-size: 3em; color: #ccc; margin-bottom: 15px;"></i>
                <h3>Aucune note disponible</h3>
                <p>Commencez par partager ou sauvegarder des ressources !</p>
                <button class="btn btn-primary" onclick="window.location.href='/communaute'">
                    <i class="fas fa-share"></i> Partager une ressource
                </button>
            </div>
        `;
        return;
    }
    
    // Grouper par type (partag√©es vs sauvegard√©es)
    const sharedNotes = notes.filter(note => note.type === 'shared');
    const savedNotes = notes.filter(note => note.type === 'saved');
    
    let html = '';
    
    // Afficher les notes sauvegard√©es
    if (savedNotes.length > 0) {
        html += `
            <div class="notes-section">
                <h3><i class="fas fa-bookmark" style="color: #007bff;"></i> Notes Sauvegard√©es (${savedNotes.length})</h3>
                <div class="notes-grid">
                    ${savedNotes.map(note => createNoteCard(note)).join('')}
                </div>
            </div>
        `;
    }
    
    // Afficher les notes partag√©es
    if (sharedNotes.length > 0) {
        html += `
            <div class="notes-section">
                <h3><i class="fas fa-share" style="color: #28a745;"></i> Notes Partag√©es (${sharedNotes.length})</h3>
                <div class="notes-grid">
                    ${sharedNotes.map(note => createNoteCard(note)).join('')}
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// Fonction pour cr√©er une carte de note
function createNoteCard(note) {
    const date = new Date(note.created_at).toLocaleDateString('fr-FR');
    const isVideo = note.file_type === 'youtube' || ['mp4','mov','avi','mkv','webm'].includes(note.file_type);
    
    return `
        <div class="note-card" data-note-id="${note.id}">
            <div class="note-header">
                <div class="note-type-badge ${note.type}">
                    ${note.type === 'shared' ? '<i class="fas fa-share"></i> Partag√©e' : '<i class="fas fa-bookmark"></i> Sauvegard√©e'}
                </div>
                <h4 class="note-title">${note.title}</h4>
            </div>
            <div class="note-meta">
                <span class="note-subject">${note.subject}</span>
                <span class="note-date">${date}</span>
            </div>
            <div class="note-actions">
                ${isVideo ? `
                    <button class="btn btn-primary" onclick="window.location.href='/videos#video-${note.id}'">
                        <i class="fas fa-video"></i> Voir
                    </button>
                ` : `
                    <button class="btn btn-primary" onclick="window.open('${note.file_url}', '_blank')">
                        <i class="fas fa-eye"></i> Voir
                    </button>
                `}
                <button class="btn btn-success" onclick="window.open('${note.download_url || note.file_url}', '_blank')">
                    <i class="fas fa-download"></i> T√©l√©charger
                </button>
                ${note.type === 'saved' ? `
                    <button class="btn btn-danger" onclick="unsaveNote(${note.id})">
                        <i class="fas fa-trash"></i> Retirer
                    </button>
                ` : ''}
            </div>
        </div>
    `;
}

// Fonction pour retirer une note sauvegard√©e
async function unsaveNote(noteId) {
    if (!confirm('√ätes-vous s√ªr de vouloir retirer cette note de vos sauvegardes ?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/unsave_ressource/${noteId}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            showNotification('‚úÖ Note retir√©e des sauvegardes', 'success');
            // Recharger les donn√©es
            await loadAllData();
        } else {
            throw new Error('Erreur lors de la suppression');
        }
    } catch (error) {
        console.error('Erreur retrait note:', error);
        showNotification('‚ùå Erreur lors du retrait de la note', 'error');
    }
}

// Fonction d'affichage d'erreur
function showNotesError() {
    const container = document.getElementById('notes-list-container');
    if (container) {
        container.innerHTML = `
            <div class="error-state">
                <i class="fas fa-exclamation-triangle" style="font-size: 3em; color: #dc3545; margin-bottom: 15px;"></i>
                <h3>Erreur de chargement</h3>
                <p>Impossible de charger vos notes. Veuillez r√©essayer.</p>
                <button class="btn btn-primary" onclick="loadMyNotes()">
                    <i class="fas fa-redo"></i> R√©essayer
                </button>
            </div>
        `;
    }
}


// Variables globales
let currentTreeRessource = null;
let currentZipStructure = null;

// Fonction pour ouvrir le modal d'arborescence
// Fonction modifi√©e pour ouvrir le modal
function openTreeModal(ressourceId, isZip = false) {
    currentTreeRessource = ressourceId;
    
    // R√©cup√©rer les informations de la ressource en cherchant dans
    // plusieurs collections possibles (note: 'ressources' n'existe pas
    // dans ce template ‚Äî on utilise les tableaux group√©s locaux).
    let ressource = null;

    // 1) Variables potentiellement pr√©sentes (s√©curis√©es avec typeof)
    if (typeof ressources !== 'undefined' && ressources) {
        ressource = ressources.find(r => r.id === ressourceId) || null;
    }
    if (!ressource && typeof filteredRessources !== 'undefined' && filteredRessources) {
        ressource = filteredRessources.find(r => r.id === ressourceId) || null;
    }

    // 2) Rechercher dans les donn√©es locales de la page (mes / sauvegard√©es)
    if (!ressource && typeof originalMyRessources !== 'undefined' && originalMyRessources) {
        ressource = originalMyRessources.find(r => r.id === ressourceId) || null;
    }
    if (!ressource && typeof originalSavedRessources !== 'undefined' && originalSavedRessources) {
        ressource = originalSavedRessources.find(r => r.id === ressourceId) || null;
    }

    // 3) Si toujours introuvable, rediriger vers la page serveur qui affiche
    // l'arborescence (route '/ressource/group/<id>'), plut√¥t que planter.
    if (!ressource) {
        window.location.href = `/ressource/group/${ressourceId}`;
        return;
    }

    if (isZip) {
        loadZipStructure(ressourceId);
    } else {
        // Afficher les fichiers multiples dans le modal
        renderMultipleFilesModal(ressource.files, ressource.title);
    }
}

// Fonction pour analyser la structure ZIP c√¥t√© frontend
function getZipStructure(zipContent) {
    try {
        // Cette fonction n√©cessite la biblioth√®que JSZip
        if (typeof JSZip !== 'undefined') {
            const zip = new JSZip();
            return zip.loadAsync(zipContent).then(zip => {
                const structure = {"type": "folder", "name": "root", "children": []};
                const files = [];
                
                zip.forEach((relativePath, zipEntry) => {
                    if (!zipEntry.dir) {
                        files.push({
                            path: relativePath,
                            name: relativePath.split('/').pop(),
                            size: zipEntry._data.uncompressedSize
                        });
                    }
                });
                
                // Organiser en structure hi√©rarchique
                files.forEach(file => {
                    const parts = file.path.split('/');
                    let currentLevel = structure.children;
                    
                    for (let i = 0; i < parts.length; i++) {
                        const part = parts[i];
                        if (i === parts.length - 1) {
                            // Fichier
                            currentLevel.push({
                                type: "file",
                                name: part,
                                path: file.path,
                                size: file.size
                            });
                        } else {
                            // Dossier
                            let folder = currentLevel.find(item => 
                                item.type === "folder" && item.name === part
                            );
                            if (!folder) {
                                folder = {
                                    type: "folder",
                                    name: part,
                                    children: []
                                };
                                currentLevel.push(folder);
                            }
                            currentLevel = folder.children;
                        }
                    }
                });
                
                return structure;
            });
        } else {
            console.warn('JSZip non disponible');
            return null;
        }
    } catch (error) {
        console.error('Erreur analyse ZIP:', error);
        return null;
    }
}
// Fonction pour charger la structure ZIP
async function loadZipStructure(ressourceId) {
    try {
        const response = await fetch(`/api/ressource/${ressourceId}/zip_structure`);
        const result = await response.json();
        
        if (result.success) {
            currentZipStructure = result.structure;
            showTreeModal(result.ressource_title, true);
            renderTreeStructure(currentZipStructure);
        } else {
            alert('Erreur lors du chargement de la structure ZIP');
        }
    } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors du chargement de la structure ZIP');
    }
}

// Fonction pour charger les fichiers multiples
async function loadMultipleFiles(ressourceId) {
    // R√©cup√©rer les informations de la ressource
    const ressource = ressources.find(r => r.id === ressourceId) || 
                     filteredRessources.find(r => r.id === ressourceId);
    
    if (ressource && ressource.is_multiple) {
        showTreeModal(ressource.title, false);
        renderMultipleFiles(ressource.files);
    }
}

// Fonction pour afficher le modal
function showTreeModal(title, isZip) {
    const modalHtml = `
        <div class="tree-modal">
            <div class="tree-modal-content">
                <div class="tree-modal-header">
                    <h3>${title} ${isZip ? '(ZIP)' : ''}</h3>
                    <div>
                        ${isZip ? `
                            <button class="zip-download-btn" onclick="downloadRessource(${currentTreeRessource})">
                                <i class="fa-solid fa-download"></i>
                                T√©l√©charger le ZIP
                            </button>
                        ` : ''}
                        <button class="close-tree-modal" style="margin-left: 10px; background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                            <i class="fa-solid fa-times"></i> Fermer
                        </button>
                    </div>
                </div>
                <div class="tree-modal-body">
                    <div class="tree-sidebar">
                        <div id="tree-container"></div>
                    </div>
                    <div class="tree-viewer">
                        <div id="file-content-container">
                            <p style="text-align: center; color: #6c757d; margin-top: 50px;">
                                S√©lectionnez un fichier pour afficher son contenu
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Gestionnaire pour fermer le modal
    document.querySelector('.close-tree-modal').addEventListener('click', closeTreeModal);
    document.querySelector('.tree-modal').addEventListener('click', function(e) {
        if (e.target === this) closeTreeModal();
    });
}

// Fonction pour rendre l'arborescence ZIP
function renderTreeStructure(structure, container = null, level = 0) {
    const treeContainer = container || document.getElementById('tree-container');
    treeContainer.innerHTML = '';
    
    const renderNode = (node, parentElement) => {
        const item = document.createElement('div');
        item.className = `tree-item ${node.type} ${node.type === 'folder' ? 'folder' : 'file'}`;
        item.style.paddingLeft = `${level * 20 + 10}px`;
        
        const icon = node.type === 'folder' ? 
            '<i class="fa-solid fa-folder"></i>' : 
            '<i class="fa-solid fa-file"></i>';
        
        item.innerHTML = `
            ${icon}
            <span>${node.name}</span>
            ${node.type === 'file' ? `<small style="margin-left: auto; color: #6c757d;">${formatFileSize(node.size)}</small>` : ''}
        `;
        
        if (node.type === 'file') {
            item.addEventListener('click', () => loadFileContent(node.path, node.name));
        } else if (node.type === 'folder' && node.children) {
            item.addEventListener('click', function(e) {
                e.stopPropagation();
                const wasExpanded = this.classList.contains('expanded');
                
                // Retirer l'expansion de tous les √©l√©ments
                document.querySelectorAll('.tree-item.folder').forEach(el => {
                    el.classList.remove('expanded');
                });
                
                if (!wasExpanded) {
                    this.classList.add('expanded');
                    renderChildren(node.children, this, level + 1);
                }
            });
        }
        
        parentElement.appendChild(item);
    };
    
    if (structure.children) {
        structure.children.forEach(child => renderNode(child, treeContainer));
    } else {
        renderNode(structure, treeContainer);
    }
}

// Fonction pour rendre les enfants d'un dossier
function renderChildren(children, parentElement, level) {
    // Supprimer les enfants existants
    const existingChildren = parentElement.nextElementSibling;
    if (existingChildren && existingChildren.classList.contains('tree-children')) {
        existingChildren.remove();
    }
    
    const childrenContainer = document.createElement('div');
    childrenContainer.className = 'tree-children';
    
    children.forEach(child => {
        const renderNode = (node) => {
            const item = document.createElement('div');
            item.className = `tree-item ${node.type} ${node.type === 'folder' ? 'folder' : 'file'}`;
            item.style.paddingLeft = `${level * 20 + 10}px`;
            
            const icon = node.type === 'folder' ? 
                '<i class="fa-solid fa-folder"></i>' : 
                '<i class="fa-solid fa-file"></i>';
            
            item.innerHTML = `
                ${icon}
                <span>${node.name}</span>
                ${node.type === 'file' ? `<small style="margin-left: auto; color: #6c757d;">${formatFileSize(node.size)}</small>` : ''}
            `;
            
            if (node.type === 'file') {
                item.addEventListener('click', () => loadFileContent(node.path, node.name));
            } else if (node.type === 'folder' && node.children) {
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const wasExpanded = this.classList.contains('expanded');
                    
                    if (!wasExpanded) {
                        this.classList.add('expanded');
                        renderChildren(node.children, this, level + 1);
                    } else {
                        this.classList.remove('expanded');
                        const nextSibling = this.nextElementSibling;
                        if (nextSibling && nextSibling.classList.contains('tree-children')) {
                            nextSibling.remove();
                        }
                    }
                });
            }
            
            childrenContainer.appendChild(item);
        };
        
        renderNode(child);
    });
    
    parentElement.after(childrenContainer);
}

// Fonction pour rendre les fichiers multiples (non-ZIP)
function renderMultipleFiles(files) {
    const treeContainer = document.getElementById('tree-container');
    treeContainer.innerHTML = '';
    
    files.forEach((file, index) => {
        const item = document.createElement('div');
        item.className = 'tree-item file';
        
        const fileType = file.file_type || 'file';
        const icon = getFileIcon(fileType);
        
        item.innerHTML = `
            ${icon}
            <span>Fichier ${index + 1}.${fileType}</span>
            <small style="margin-left: auto; color: #6c757d;">
                ${file.page_count ? `${file.page_count} pages` : ''}
            </small>
        `;
        
        item.addEventListener('click', () => {
            if (file.is_video) {
                window.location.href = `/videos#video-${currentTreeRessource}`;
            } else {
                window.open(file.file_url, '_blank');
            }
        });
        
        treeContainer.appendChild(item);
    });
}

// Fonction pour charger le contenu d'un fichier
async function loadFileContent(filePath, fileName) {
    const contentContainer = document.getElementById('file-content-container');
    contentContainer.innerHTML = '<p style="text-align: center;">Chargement...</p>';
    
    try {
        const response = await fetch(`/api/ressource/${currentTreeRessource}/zip_file?path=${encodeURIComponent(filePath)}`);
        
        if (response.ok) {
            const contentType = response.headers.get('content-type');
            
            if (contentType && contentType.startsWith('image/')) {
                // Afficher l'image
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                contentContainer.innerHTML = `
                    <div class="file-content">
                        <h4>${fileName}</h4>
                        <img src="${url}" alt="${fileName}" style="max-width: 100%;">
                        <div style="margin-top: 15px;">
                            <button onclick="window.open('${url}')" class="btn-view">
                                <i class="fa-solid fa-expand"></i> Ouvrir en plein √©cran
                            </button>
                        </div>
                    </div>
                `;
            } else if (contentType && (contentType.includes('text/') || contentType.includes('application/json'))) {
                // Afficher le texte
                const text = await response.text();
                contentContainer.innerHTML = `
                    <div class="file-content">
                        <h4>${fileName}</h4>
                        <pre class="text-content">${escapeHtml(text)}</pre>
                    </div>
                `;
            } else {
                // T√©l√©charger pour les autres types
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                contentContainer.innerHTML = `
                    <div class="file-content">
                        <h4>${fileName}</h4>
                        <p>Ce type de fichier ne peut pas √™tre pr√©visualis√©.</p>
                        <button onclick="downloadFileFromUrl('${url}', '${fileName}')" class="btn-download">
                            <i class="fa-solid fa-download"></i> T√©l√©charger
                        </button>
                    </div>
                `;
            }
        } else {
            contentContainer.innerHTML = '<p style="color: red;">Erreur lors du chargement du fichier</p>';
        }
    } catch (error) {
        console.error('Erreur:', error);
        contentContainer.innerHTML = '<p style="color: red;">Erreur lors du chargement du fichier</p>';
    }
}

// Fonctions utilitaires
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function getFileIcon(fileType) {
    const type = (fileType || '').toLowerCase();
    const icons = {
        'pdf': '<i class="fa-solid fa-file-pdf" style="color: #e74c3c;"></i>',
        'zip': '<i class="fa-solid fa-file-zipper" style="color: #f39c12;"></i>',
        'doc': '<i class="fa-solid fa-file-word" style="color: #2b579a;"></i>',
        'docx': '<i class="fa-solid fa-file-word" style="color: #2b579a;"></i>',
        'png': '<i class="fa-solid fa-file-image" style="color: #3498db;"></i>',
        'jpg': '<i class="fa-solid fa-file-image" style="color: #3498db;"></i>',
        'jpeg': '<i class="fa-solid fa-file-image" style="color: #3498db;"></i>',
        'gif': '<i class="fa-solid fa-file-image" style="color: #3498db;"></i>',
        'mp4': '<i class="fa-solid fa-file-video" style="color: #9b59b6;"></i>',
        'mov': '<i class="fa-solid fa-file-video" style="color: #9b59b6;"></i>',
        'avi': '<i class="fa-solid fa-file-video" style="color: #9b59b6;"></i>',
        'mkv': '<i class="fa-solid fa-file-video" style="color: #9b59b6;"></i>',
        'webm': '<i class="fa-solid fa-file-video" style="color: #9b59b6;"></i>',
        'txt': '<i class="fa-solid fa-file-lines" style="color: #2ecc71;"></i>',
        'md': '<i class="fa-solid fa-file-lines" style="color: #2ecc71;"></i>',
        'html': '<i class="fa-solid fa-file-code" style="color: #e67e22;"></i>',
        'css': '<i class="fa-solid fa-file-code" style="color: #e67e22;"></i>',
        'js': '<i class="fa-solid fa-file-code" style="color: #e67e22;"></i>',
        'json': '<i class="fa-solid fa-file-code" style="color: #e67e22;"></i>'
    };
    
    return icons[type] || '<i class="fa-solid fa-file" style="color: #95a5a6;"></i>';
}
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function downloadFileFromUrl(url, filename) {
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function closeTreeModal() {
    const modal = document.querySelector('.tree-modal');
    if (modal) {
        modal.remove();
    }
    currentTreeRessource = null;
    currentZipStructure = null;
}

function createSingleMediaHtml(file, ressourceId, isInCarousel = false) {
    const containerClass = isInCarousel ? 'carousel-media' : '';
    const { file_url, file_type, is_video, page_count } = file;

    // D√©terminer le type de fichier
    const actualFileType = file_type || 'file';
    
    if (actualFileType === 'youtube') {
        return `
            <div class="${containerClass}">
                <iframe 
                    width="100%" 
                    height="200" 
                    src="${file_url}" 
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen>
                </iframe>
            </div>`;
    } else if (is_video || ['mp4','mov','avi','mkv','webm'].includes(actualFileType)) {
        return `
            <div class="${containerClass}" style="cursor: pointer;" onclick="window.location.href='/videos#video-${ressourceId}'">
                <div class="carousel-icon-placeholder" style="padding: 25px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px;">
                    <i class="fa-solid fa-video" style="font-size: 2.5em; margin-bottom: 12px;"></i>
                    <p style="margin: 0; font-weight: 500;">üìπ Vid√©o disponible</p>
                    <p style="margin: 8px 0 0 0; font-size: 0.9em; opacity: 0.9;">Cliquez pour voir dans la page Vid√©os</p>
                </div>
            </div>`;
    } else if (['png','jpg','jpeg','gif'].includes(actualFileType)) {
        return `
            <div class="${containerClass}">
                <img src="${file_url}" alt="Image" 
                     loading="lazy" 
                     style="width: 100%; height: 100%; object-fit: contain;"
                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5Ij5JbWFnZTwvdGV4dD48L3N2Zz4='">
            </div>`;
    } else if (actualFileType === 'pdf') {
        return `
            <div class="${containerClass}">
                <div class="carousel-icon-placeholder">
                    <i class="fa-solid fa-file-pdf" style="color: #e74c3c; font-size: 2.5em; margin-bottom: 12px;"></i>
                    <p style="margin: 0; font-weight: 500;">Document PDF</p>
                    ${page_count ? `<small style="margin-top: 8px;">${page_count} pages</small>` : ''}
                </div>
            </div>`;
    } else if (actualFileType === 'zip') {
        return `
            <div class="${containerClass}">
                <div class="carousel-icon-placeholder">
                    <i class="fa-solid fa-file-zipper" style="color: #f39c12; font-size: 2.5em; margin-bottom: 12px;"></i>
                    <p style="margin: 0; font-weight: 500;">Archive ZIP</p>
                    <small style="margin-top: 8px;">Cliquez pour explorer</small>
                </div>
            </div>`;
    } else if (['doc', 'docx'].includes(actualFileType)) {
        return `
            <div class="${containerClass}">
                <div class="carousel-icon-placeholder">
                    <i class="fa-solid fa-file-word" style="color: #2b579a; font-size: 2.5em; margin-bottom: 12px;"></i>
                    <p style="margin: 0; font-weight: 500;">Document Word</p>
                </div>
            </div>`;
    } else {
        return `
            <div class="${containerClass}">
                <div class="carousel-icon-placeholder">
                    <i class="fa-solid fa-file-lines" style="color: #6c757d; font-size: 2.5em; margin-bottom: 12px;"></i>
                    <p style="margin: 0; font-weight: 500;">${actualFileType.toUpperCase()}</p>
                </div>
            </div>`;
    }
}
</script>
{% endblock %}