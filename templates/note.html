{% extends 'base.html' %}
{% block title %}Notes | Eudushare{% endblock %}
{% block description %}Consulte et partage tes notes sur Eudushare.{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/note.css') }}">
<style>
  /* Grille uniforme */
  .ressources-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 24px;
    padding: 20px 0;
    align-items: start;
  }

  /* ✅ CARTE DE HAUTEUR FIXE */
  .ressources-list {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    height: 520px; /* 🔑 Hauteur fixe pour TOUTES les cartes */
    overflow: hidden; /* Empêche tout débordement */
  }

  /* En-tête : hauteur fixe */
  .ressource-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 18px 18px 12px;
    flex-shrink: 0; /* Ne rétrécit pas */
  }

  .ressource-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #f0f0f0;
    flex-shrink: 0;
  }

  .ressource-title {
    font-size: 1.1em;
    font-weight: 600;
    margin: 0;
    color: #212529;
    /* Troncature à 2 lignes max */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.3;
  }

  /* Métadonnées : hauteur fixe */
  .ressource-meta-container {
    padding: 0 18px 12px;
    flex-shrink: 0;
  }

  .ressource-meta {
    display: flex;
    justify-content: space-between;
    font-size: 0.85em;
    color: #6c757d;
    flex-wrap: wrap;
    gap: 8px;
  }

  .ressource-subject {
    background: #e9ecef;
    padding: 2px 10px;
    border-radius: 20px;
    font-weight: 500;
    white-space: nowrap;
  }

  /* ✅ MÉDIA : HAUTEUR FIXE ABSOLUE */
  .ressource-media {
    flex: 1; /* Prend tout l'espace restant */
    margin: 0 18px;
    border-radius: 8px;
    overflow: hidden;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  .ressource-media img,
  .ressource-media video {
    width: 100%;
    height: 100%;
    object-fit: contain; /* 🔑 Contient sans déformer */
    background: white;
  }

  .ressource-media .icon-placeholder {
    text-align: center;
    color: #6c757d;
    padding: 20px;
  }

  .ressource-media .icon-placeholder i {
    font-size: 3em;
    margin-bottom: 12px;
    color: #007bff;
  }

  /* Actions : hauteur fixe */
  .ressource-actions {
    display: flex;
    gap: 10px;
    padding: 12px 18px 18px;
    border-top: 1px solid #eee;
    flex-shrink: 0;
  }

  .ressource-actions button {
    flex: 1;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
  }

  .btn-view { background: #007bff; color: white; }
  .btn-view:hover { background: #0069d9; }
  .btn-download { background: #28a745; color: white; }
  .btn-download:hover { background: #218838; }

  /* =============== STYLE PAGINATION =============== */
  .pagination {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin: 30px 0;
    flex-wrap: wrap;
  }

  .pagination button {
    padding: 8px 14px;
    border: 1px solid #dee2e6;
    background: #fff;
    color: #007bff;
    cursor: pointer;
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s ease;
    min-width: 40px;
    text-align: center;
  }

  .pagination button:hover {
    background: #e9ecef;
    border-color: #adb5bd;
    transform: translateY(-1px);
  }

  .pagination .current-page {
    padding: 8px 14px;
    background: #007bff;
    color: white;
    border-radius: 6px;
    font-weight: 600;
    min-width: 40px;
    text-align: center;
    border: 1px solid #007bff;
  }

  .pagination button:disabled {
    background: #f8f9fa;
    color: #6c757d;
    cursor: not-allowed;
    transform: none;
  }

  .pagination button:first-child,
  .pagination button:last-child {
    padding: 8px 16px;
    font-weight: 600;
  }

  /* Responsive mobile */
  @media (max-width: 768px) {
    .ressources-grid {
      grid-template-columns: 1fr;
      gap: 16px;
    }
    .ressources-list {
      height: 480px; /* Un peu moins sur mobile */
    }
    
    .pagination {
      gap: 4px;
      margin: 20px 0;
    }
    
    .pagination button {
      padding: 6px 10px;
      min-width: 36px;
      font-size: 0.9em;
    }
    
    .pagination .current-page {
      padding: 6px 10px;
      min-width: 36px;
    }
  }

  /* Animation pour le changement de page */
  .ressources-grid {
    transition: opacity 0.3s ease;
  }

  .ressources-grid.loading {
    opacity: 0.6;
  }
  /* Styles pour les notes */
.notes-section {
    margin-bottom: 30px;
}

.notes-section h3 {
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f0f0f0;
    color: #333;
}

.notes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}

.note-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #007bff;
    transition: transform 0.2s ease;
}

.note-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.note-header {
    margin-bottom: 10px;
}

.note-type-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: 500;
    margin-bottom: 8px;
}

.note-type-badge.shared {
    background: #e8f5e8;
    color: #28a745;
}

.note-type-badge.saved {
    background: #e3f2fd;
    color: #007bff;
}

.note-title {
    font-size: 1.1em;
    font-weight: 600;
    margin: 0;
    color: #333;
    line-height: 1.3;
}

.note-meta {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
    font-size: 0.9em;
    color: #666;
}

.note-subject {
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: 500;
}

.note-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.note-actions button {
    flex: 1;
    min-width: 80px;
    padding: 6px 10px;
    font-size: 0.85em;
}

.empty-state, .error-state {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.empty-state h3, .error-state h3 {
    margin-bottom: 10px;
    color: #333;
}

/* Animation pour le compteur */
.info {
    font-weight: bold;
    transition: all 0.5s ease;
}

.info.updated {
    transform: scale(1.2);
    color: #6c5ce7;
}

/* Responsive */
@media (max-width: 768px) {
    .notes-grid {
        grid-template-columns: 1fr;
    }
    
    .note-actions {
        flex-direction: column;
    }
    
    .note-actions button {
        min-width: 100%;
    }
}
</style>  
{% endblock %}

{% block content %}
<!-- ================= HEADER ================= -->
<header class="header">
  <div class="header-content">
    <h1>Bienvenue sur votre espace de notes</h1>
    <p>Gérez et partagez vos notes facilement</p>
    <div class="header-buttons">
      <a href="#" onclick="shareRessourceFromProfile()" class="btn btn-primary" style="color: black !important;">Partager une ressource</a>
    </div>
  </div>

  <div data-aos="zoom-in" class="info-matiere">
    <div>
        <span class="info" id="total-notes">0</span>
        <span>Notes Totales</span>
    </div>
    <div>
        <span class="info" id="total-saved">0</span>
        <span>Sauvegardées</span>
    </div>
    <div>
        <span class="info" id="total-shared">0</span>
        <span>Partagées</span>
    </div>
    <div>
        <span class="info" id="total-subjects">0</span>
        <span>Matieres</span>
    </div>
</div>
</header>

<!-- Navigation -->
<nav>
  <button class="tab active" data-page="all_note"><i class="fa-solid fa-file"></i>&nbsp;mes notes</button>
  <button class="tab" data-page="Partagees"><i class="fa-solid fa-bookmark"></i>&nbsp;sauvegarder</button>
  <button class="tab" onclick="window.location.href='/videos'" 
          style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <i class="fa-solid fa-video"></i>&nbsp;vidéos
  </button>
</nav>

<div class="filter">
  <div>
    <label for="matiere">Matière :</label>
    <select name="matiere" id="matiere">
      <option value="">Toutes</option>
      <option value="javascript">JavaScript</option>
      <option value="HTML">HTML</option>
      <option value="CSS">CSS</option>
      <option value="Algorithme">Algorithme</option>
      <option value="C++">C++</option>
      <option value="systeme">Système</option>
      <option value="autre">Autre</option>
    </select>

    <label for="tri">Trier par :</label>
    <select name="tri" id="tri">
      <option value="date">Date</option>
      <option value="subject">Matière</option>
    </select>
  </div>

  <div class="search-box">
    <label for="search"><i class="fa-solid fa-magnifying-glass"></i></label>
    <input type="search" id="search" placeholder="Rechercher dans mes notes">
  </div>
</div>

<main>
  <section id="all_note" class="page active">
    <div id="my-ressources-container"></div>
    <div id="my-pagination"></div> <!-- Conteneur de pagination pour mes notes -->
  </section>

  <section id="Partagees" class="page">
    <div id="saved-ressources-container"></div>
    <div id="saved-pagination"></div> <!-- Conteneur de pagination pour les sauvegardes -->
  </section>
</main>
{% endblock %}

{% block script %}
<script>
const ITEMS_PER_PAGE = 10;
let myRessources = [];
let savedRessources = [];
let currentPageMy = 1;
let currentPageSaved = 1;

async function loadAllData() {
    try {
        // Charger mes ressources
        const myRes = await fetch('/api/my_ressources');
        let myRessources = await myRes.json();
        myRessources = groupRessourcesByTitle(myRessources);
        renderPaginatedMy(myRessources, currentPageMy);

        document.getElementById('total-notes').textContent = myRessources.length;
        document.getElementById('total-shared').textContent = myRessources.length;

        // 🔥 SOLUTION SIMPLE : Charger TOUTES les ressources de la communauté
        const allRes = await fetch('/api/ressources');
        const allRessources = await allRes.json();
        const allGrouped = groupRessourcesByTitle(allRessources);
        
        // Charger les IDs des ressources sauvegardées
        const savedRes = await fetch('/api/saved_ressources');
        const savedList = await savedRes.json();
        const savedIds = new Set(savedList.map(s => s.id));
        
        // Filtrer pour garder seulement les ressources groupées qui sont sauvegardées
        const savedRessources = allGrouped.filter(group => {
            // Vérifier si au moins un fichier de ce groupe est sauvegardé
            return group.files.some(file => savedIds.has(file.id));
        });

        renderPaginatedSaved(savedRessources, currentPageSaved);
        document.getElementById('total-saved').textContent = savedRessources.length;

        // Compter les matières uniques
        const subjects = [...new Set(myRessources.map(r => r.subject))];
        document.getElementById('total-subjects').textContent = subjects.length;

    } catch (err) {
        console.error("Erreur:", err);
    }
}

function renderPaginatedMy(list, page) {
  currentPageMy = page;
  const totalPages = Math.ceil(list.length / ITEMS_PER_PAGE);
  const start = (page - 1) * ITEMS_PER_PAGE;
  const paginated = list.slice(start, start + ITEMS_PER_PAGE);
  renderRessources(paginated, 'my-ressources-container');
  renderPagination(totalPages, page, (newPage) => {
    renderPaginatedMy(list, newPage);
  }, 'my-ressources-container', 'my-pagination');
}

function renderPaginatedSaved(list, page) {
  currentPageSaved = page;
  const totalPages = Math.ceil(list.length / ITEMS_PER_PAGE);
  const start = (page - 1) * ITEMS_PER_PAGE;
  const paginated = list.slice(start, start + ITEMS_PER_PAGE);
  renderRessources(paginated, 'saved-ressources-container');
  renderPagination(totalPages, page, (newPage) => {
    renderPaginatedSaved(list, newPage);
  }, 'saved-ressources-container', 'saved-pagination');
}

function renderRessources(list, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    if (list.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding:30px; color:#777; font-size:1.1em;">Aucune ressource.</p>';
        return;
    }

    container.innerHTML = '<div class="ressources-grid"></div>';
    const grid = container.querySelector('.ressources-grid');

    list.forEach(r => {
        const date = new Date(r.created_at).toLocaleDateString('fr-FR');
        
        // État de sauvegarde
        const isSaved = r.is_saved || false;
        const bookmarkIconClass = isSaved ? 'fa-solid fa-bookmark' : 'fa-regular fa-bookmark';
        const bookmarkColor = isSaved ? '#007bff' : '#ccc';

        // 🔥 AFFICHAGE INTELLIGENT (CAROUSEL OU SIMPLE)
        let mediaHtml = '';
        if (r.is_multiple) {
            mediaHtml = `
                <div class="ressource-media">
                    ${createCarouselHtml(r.files, r.id)}
                </div>`;
        } else {
            const singleFile = r.files[0];
            mediaHtml = `
                <div class="ressource-media">
                    ${createSingleMediaHtml(singleFile, r.id, false)}
                </div>`;
        }

        grid.innerHTML += `
            <div class="ressources-list" data-ressource-id="${r.id}">
                <div class="ressource-header">
                    <img src="${r.user_avatar}" 
                         alt="Avatar" 
                         class="ressource-avatar"
                         loading="lazy"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9Ijc1IiB5PSI3NSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSI+QXZhdGFyPC90ZXh0Pjwvc3ZnPg=='">
                    <h3 class="ressource-title">${r.title}</h3>
                    <div class="save-icon" onclick="toggleSaveRessource(${r.id}, this)">
                        <i class="${bookmarkIconClass}" style="color: ${bookmarkColor};"></i>
                    </div>
                </div>
                
                <div class="ressource-meta">
                    <span class="ressource-subject">${r.subject}</span>
                    <span>par ${r.username || 'Utilisateur'}</span>
                </div>

                ${mediaHtml}

                <div class="ressource-meta">
                    <span>${date}</span>
                    <span>${r.files[0].page_count ? r.files[0].page_count + ' pages' : '—'}</span>
                </div>

                <div class="ressource-actions">
                    ${r.files[0].is_video ? `
                        <button class="btn-view" onclick="window.location.href='/videos#video-${r.id}'" style="background: #667eea;">
                            <i class="fa-solid fa-video"></i> Voir la vidéo
                        </button>
                    ` : `
                        <button class="btn-view" onclick="window.open('${r.files[0].file_url}', '_blank')">
                            <i class="fa-solid fa-eye"></i> Voir
                        </button>
                    `}
                    <button class="btn-download" onclick="window.open('${r.files[0].download_url || r.files[0].file_url}', '_blank')">
                        <i class="fa-solid fa-download"></i> Télécharger
                    </button>
                </div>
            </div>`;
    });

    // Initialiser les carousels après le rendu
    setTimeout(initializeCarousels, 100);
}


function renderPagination(totalPages, currentPage, onPageChange, containerId, paginationId) {
  // Trouver ou créer le conteneur de pagination
  let paginationContainer = document.getElementById(paginationId);
  const mainContainer = document.getElementById(containerId);
  
  if (!paginationContainer) {
    paginationContainer = document.createElement('div');
    paginationContainer.id = paginationId;
    if (mainContainer) {
      mainContainer.after(paginationContainer);
    }
  }
  
  if (totalPages <= 1) {
    paginationContainer.innerHTML = '';
    return;
  }

  let html = '<div class="pagination">';
  
  // Bouton précédent
  if (currentPage > 1) {
    html += `<button onclick="pageChangeHandler(${currentPage - 1}, '${paginationId}')" title="Page précédente">&laquo; Précédent</button>`;
  }
  
  // Pages - afficher maximum 7 pages pour ne pas surcharger
  const maxVisiblePages = 7;
  let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
  let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
  
  // Ajuster si on est près du début
  if (endPage - startPage + 1 < maxVisiblePages) {
    startPage = Math.max(1, endPage - maxVisiblePages + 1);
  }
  
  // Première page + points de suspension si nécessaire
  if (startPage > 1) {
    html += `<button onclick="pageChangeHandler(1, '${paginationId}')">1</button>`;
    if (startPage > 2) {
      html += `<span style="padding: 8px 6px; color: #6c757d;">...</span>`;
    }
  }
  
  // Pages principales
  for (let i = startPage; i <= endPage; i++) {
    if (i === currentPage) {
      html += `<span class="current-page">${i}</span>`;
    } else {
      html += `<button onclick="pageChangeHandler(${i}, '${paginationId}')">${i}</button>`;
    }
  }
  
  // Dernière page + points de suspension si nécessaire
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      html += `<span style="padding: 8px 6px; color: #6c757d;">...</span>`;
    }
    html += `<button onclick="pageChangeHandler(${totalPages}, '${paginationId}')">${totalPages}</button>`;
  }
  
  // Bouton suivant
  if (currentPage < totalPages) {
    html += `<button onclick="pageChangeHandler(${currentPage + 1}, '${paginationId}')" title="Page suivante">Suivant &raquo;</button>`;
  }
  
  html += '</div>';
  paginationContainer.innerHTML = html;
  
  // Stocker le callback
  paginationContainer._pageChangeCallback = onPageChange;
}
function renderPaginatedMy(list, page) {
  currentPageMy = page;
  const totalPages = Math.ceil(list.length / ITEMS_PER_PAGE);
  const start = (page - 1) * ITEMS_PER_PAGE;
  const paginated = list.slice(start, start + ITEMS_PER_PAGE);
  
  // Animation de chargement
  const container = document.getElementById('my-ressources-container');
  if (container) {
    container.style.opacity = '0.6';
    setTimeout(() => {
      renderRessources(paginated, 'my-ressources-container');
      container.style.opacity = '1';
    }, 150);
  }
  
  renderPagination(totalPages, page, (newPage) => {
    renderPaginatedMy(list, newPage);
  }, 'my-ressources-container', 'my-pagination');
}

// Gestionnaire global pour les changements de page
function pageChangeHandler(page, paginationId) {
  const container = document.getElementById(paginationId);
  if (container && container._pageChangeCallback) {
    container._pageChangeCallback(page);
  }
}

// Filtres et recherche
function setupFilters() {
  const matiereSelect = document.getElementById('matiere');
  const triSelect = document.getElementById('tri');
  const searchInput = document.getElementById('search');

  if (matiereSelect) {
    matiereSelect.addEventListener('change', applyFilters);
  }
  if (triSelect) {
    triSelect.addEventListener('change', applyFilters);
  }
  if (searchInput) {
    searchInput.addEventListener('input', applyFilters);
  }
}

function applyFilters() {
  const matiere = document.getElementById('matiere')?.value || '';
  const tri = document.getElementById('tri')?.value || 'date';
  const search = document.getElementById('search')?.value.toLowerCase() || '';

  // Filtrer mes ressources
  let filteredMy = myRessources.filter(r => {
    const matchesMatiere = !matiere || 
                           matiere === 'autre' ? 
                           !['javascript', 'HTML', 'CSS', 'Algorithme', 'C++', 'systeme'].includes(r.subject.toLowerCase()) :
                           r.subject.toLowerCase() === matiere.toLowerCase();
    const matchesSearch = !search || 
      r.title.toLowerCase().includes(search) || 
      r.subject.toLowerCase().includes(search);
    return matchesMatiere && matchesSearch;
  });

  // Trier
  if (tri === 'date') {
    filteredMy.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
  } else if (tri === 'subject') {
    filteredMy.sort((a, b) => a.subject.localeCompare(b.subject));
  }

  // Filtrer les ressources sauvegardées
  let filteredSaved = savedRessources.filter(r => {
    const matchesMatiere = !matiere || 
                           matiere === 'autre' ? 
                           !['javascript', 'HTML', 'CSS', 'Algorithme', 'C++', 'systeme'].includes(r.subject.toLowerCase()) :
                           r.subject.toLowerCase() === matiere.toLowerCase();
    const matchesSearch = !search || 
      r.title.toLowerCase().includes(search) || 
      r.subject.toLowerCase().includes(search);
    return matchesMatiere && matchesSearch;
  });

  // Trier les sauvegardées
  if (tri === 'date') {
    filteredSaved.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
  } else if (tri === 'subject') {
    filteredSaved.sort((a, b) => a.subject.localeCompare(b.subject));
  }

  // Réinitialiser les pages et afficher
  currentPageMy = 1;
  currentPageSaved = 1;
  
  renderPaginatedMy(filteredMy, currentPageMy);
  renderPaginatedSaved(filteredSaved, currentPageSaved);
}
// Navigation entre onglets
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.page).classList.add("active");
  });
});

// Initialisation
document.addEventListener('DOMContentLoaded', () => {
  loadAllData();
  setupFilters();
});

function shareRessourceFromProfile() {
    // Marquer qu'on veut ouvrir le formulaire
    sessionStorage.setItem('openShareForm', 'true');
    
    // Rediriger
    window.location.href = "{{ url_for('communaute') }}";
}

// carroussel
// =============== FONCTIONS DE REGROUPEMENT ===============

function groupRessourcesByTitle(ressources) {
    const grouped = {};
    
    ressources.forEach(ressource => {
        const key = `${ressource.title}-${ressource.subject}-${ressource.user_id}`;
        
        if (!grouped[key]) {
            grouped[key] = {
                id: ressource.id, // Garder le premier ID
                title: ressource.title,
                subject: ressource.subject,
                user_id: ressource.user_id,
                username: ressource.username,
                user_avatar: ressource.user_avatar,
                created_at: ressource.created_at,
                likes: ressource.likes,
                is_saved: ressource.is_saved,
                page_count: ressource.page_count,
                files: [{
                    id: ressource.id, // 🔥 TRÈS IMPORTANT : inclure l'ID original
                    file_url: ressource.file_url,
                    download_url: ressource.download_url,
                    file_type: ressource.file_type,
                    page_count: ressource.page_count,
                    is_video: ressource.is_video
                }],
                is_multiple: false
            };
        } else {
            grouped[key].files.push({
                id: ressource.id, // 🔥 TRÈS IMPORTANT : inclure l'ID original
                file_url: ressource.file_url,
                download_url: ressource.download_url,
                file_type: ressource.file_type,
                page_count: ressource.page_count,
                is_video: ressource.is_video
            });
        }
    });
    
    // Marquer les groupes multiples
    const result = Object.values(grouped).map(group => {
        if (group.files.length > 1) {
            group.is_multiple = true;
        }
        return group;
    });
    
    return result;
}

// =============== FONCTIONS POUR LE CAROUSEL ===============

function createCarouselHtml(files, ressourceId) {
    let slidesHtml = '';
    files.forEach((file, index) => {
        slidesHtml += `
            <div class="carousel-slide" data-index="${index}">
                ${createSingleMediaHtml(file, ressourceId, true)}
            </div>`;
    });

    let indicatorsHtml = '';
    files.forEach((_, index) => {
        const isActive = index === 0 ? 'active' : '';
        indicatorsHtml += `<button class="carousel-indicator ${isActive}" data-index="${index}"></button>`;
    });

    return `
        <div class="ressource-carousel" id="carousel-${ressourceId}">
            <div class="carousel-count">1/${files.length}</div>
            <div class="multi-file-badge">
                <i class="fa-solid fa-layer-group"></i> ${files.length} fichiers
            </div>
            <div class="carousel-track">
                ${slidesHtml}
            </div>
            ${files.length > 1 ? `
                <button class="carousel-nav carousel-prev" onclick="carouselPrev('${ressourceId}')">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
                <button class="carousel-nav carousel-next" onclick="carouselNext('${ressourceId}')">
                    <i class="fa-solid fa-chevron-right"></i>
                </button>
                <div class="carousel-indicators">
                    ${indicatorsHtml}
                </div>
            ` : ''}
        </div>`;
}

function createSingleMediaHtml(file, ressourceId, isInCarousel = false) {
    const containerClass = isInCarousel ? 'carousel-media' : '';
    const { file_url, file_type, is_video } = file;

    if (is_video || ['mp4','mov','avi','mkv','webm'].includes(file_type)) {
        return `
            <div class="${containerClass}" style="cursor: pointer;" onclick="window.location.href='/videos#video-${ressourceId}'">
                <div class="carousel-icon-placeholder" style="padding: 25px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px;">
                    <i class="fa-solid fa-video" style="font-size: 2.5em; margin-bottom: 12px;"></i>
                    <p style="margin: 0; font-weight: 500;">📹 Vidéo disponible</p>
                    <p style="margin: 8px 0 0 0; font-size: 0.9em; opacity: 0.9;">Cliquez pour voir dans la page Vidéos</p>
                </div>
            </div>`;
    } else if (['png','jpg','jpeg','gif'].includes(file_type)) {
        return `
            <div class="${containerClass}">
                <img src="${file_url}" alt="Image" 
                     loading="lazy" 
                     style="width: 100%; height: 100%; object-fit: contain;"
                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5Ij5JbWFnZTwvdGV4dD48L3N2Zz4='">
            </div>`;
    } else if (file_type === 'pdf') {
        return `
            <div class="${containerClass}">
                <div class="carousel-icon-placeholder">
                    <i class="fa-solid fa-file-pdf"></i>
                    <p>Document PDF</p>
                    ${file.page_count ? `<small>${file.page_count} pages</small>` : ''}
                </div>
            </div>`;
    } else {
        return `
            <div class="${containerClass}">
                <div class="carousel-icon-placeholder">
                    <i class="fa-solid fa-file-lines"></i>
                    <p>${(file_type || 'DOC').toUpperCase()}</p>
                </div>
            </div>`;
    }
}

// =============== FONCTIONS DE NAVIGATION CAROUSEL ===============

function initializeCarousels() {
    document.querySelectorAll('.ressource-carousel').forEach(carousel => {
        const carouselId = carousel.id.replace('carousel-', '');
        carousel.currentSlide = 0;
        updateCarousel(carouselId);
    });
}

function carouselNext(carouselId) {
    const carousel = document.getElementById(`carousel-${carouselId}`);
    if (!carousel) return;
    
    const slides = carousel.querySelectorAll('.carousel-slide');
    carousel.currentSlide = (carousel.currentSlide + 1) % slides.length;
    updateCarousel(carouselId);
}

function carouselPrev(carouselId) {
    const carousel = document.getElementById(`carousel-${carouselId}`);
    if (!carousel) return;
    
    const slides = carousel.querySelectorAll('.carousel-slide');
    carousel.currentSlide = (carousel.currentSlide - 1 + slides.length) % slides.length;
    updateCarousel(carouselId);
}

function updateCarousel(carouselId) {
    const carousel = document.getElementById(`carousel-${carouselId}`);
    if (!carousel) return;
    
    const track = carousel.querySelector('.carousel-track');
    const slides = carousel.querySelectorAll('.carousel-slide');
    const indicators = carousel.querySelectorAll('.carousel-indicator');
    const count = carousel.querySelector('.carousel-count');
    
    if (!track || !slides.length) return;
    
    const slideWidth = 100; // 100% par slide
    track.style.transform = `translateX(-${carousel.currentSlide * slideWidth}%)`;
    
    // Mettre à jour les indicateurs
    indicators.forEach((indicator, index) => {
        indicator.classList.toggle('active', index === carousel.currentSlide);
    });
    
    // Mettre à jour le compteur
    if (count) {
        count.textContent = `${carousel.currentSlide + 1}/${slides.length}`;
    }
}

// Navigation par indicateurs et swipe
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('carousel-indicator')) {
        const carousel = e.target.closest('.ressource-carousel');
        const carouselId = carousel.id.replace('carousel-', '');
        const index = parseInt(e.target.getAttribute('data-index'));
        if (carousel && !isNaN(index)) {
            carousel.currentSlide = index;
            updateCarousel(carouselId);
        }
    }
});

// Support du swipe sur mobile
let touchStartX = 0;
let touchEndX = 0;

document.addEventListener('touchstart', e => {
    touchStartX = e.changedTouches[0].screenX;
});

document.addEventListener('touchend', e => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
});

function handleSwipe() {
    const swipeThreshold = 50;
    const diff = touchStartX - touchEndX;
    
    if (Math.abs(diff) > swipeThreshold) {
        const activeCarousel = document.querySelector('.ressource-carousel:hover') || 
                             document.querySelector('.ressource-media:has(.ressource-carousel:hover)');
        
        if (activeCarousel) {
            const carouselId = activeCarousel.id.replace('carousel-', '');
            if (diff > 0) {
                // Swipe gauche → suivant
                carouselNext(carouselId);
            } else {
                // Swipe droite → précédent
                carouselPrev(carouselId);
            }
        }
    }
}
</script>
<script>
  // Fonction pour charger les statistiques des notes
async function loadNotesStats() {
    try {
        console.log('Chargement des statistiques des notes...');
        
        const response = await fetch('/api/notes/stats');
        const result = await response.json();
        
        if (result.success) {
            const stats = result.stats;
            
            // Mettre à jour les éléments HTML avec les vraies données
            document.getElementById('total-notes').textContent = stats.total_notes;
            document.getElementById('total-saved').textContent = stats.total_saved;
            document.getElementById('total-shared').textContent = stats.total_shared;
            document.getElementById('total-subjects').textContent = stats.total_subjects;
            
            console.log('Statistiques chargées:', stats);
        } else {
            console.error('Erreur dans les stats:', result.error);
            // Garder les valeurs par défaut (0)
        }
    } catch (error) {
        console.error('Erreur lors du chargement des stats:', error);
        // En cas d'erreur, les valeurs restent à 0
    }
}

// Fonction pour charger les notes détaillées
async function loadMyNotes() {
    try {
        const response = await fetch('/api/my_notes');
        const result = await response.json();
        
        if (result.success) {
            console.log(`Chargement de ${result.notes.length} notes`);
            renderNotesList(result.notes);
        } else {
            console.error('Erreur chargement notes:', result.error);
            showNotesError();
        }
    } catch (error) {
        console.error('Erreur chargement notes:', error);
        showNotesError();
    }
}

// Fonction pour afficher la liste des notes
function renderNotesList(notes) {
    const container = document.getElementById('notes-list-container'); // À créer dans votre HTML
    if (!container) return;
    
    if (notes.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox" style="font-size: 3em; color: #ccc; margin-bottom: 15px;"></i>
                <h3>Aucune note disponible</h3>
                <p>Commencez par partager ou sauvegarder des ressources !</p>
                <button class="btn btn-primary" onclick="window.location.href='/communaute'">
                    <i class="fas fa-share"></i> Partager une ressource
                </button>
            </div>
        `;
        return;
    }
    
    // Grouper par type (partagées vs sauvegardées)
    const sharedNotes = notes.filter(note => note.type === 'shared');
    const savedNotes = notes.filter(note => note.type === 'saved');
    
    let html = '';
    
    // Afficher les notes sauvegardées
    if (savedNotes.length > 0) {
        html += `
            <div class="notes-section">
                <h3><i class="fas fa-bookmark" style="color: #007bff;"></i> Notes Sauvegardées (${savedNotes.length})</h3>
                <div class="notes-grid">
                    ${savedNotes.map(note => createNoteCard(note)).join('')}
                </div>
            </div>
        `;
    }
    
    // Afficher les notes partagées
    if (sharedNotes.length > 0) {
        html += `
            <div class="notes-section">
                <h3><i class="fas fa-share" style="color: #28a745;"></i> Notes Partagées (${sharedNotes.length})</h3>
                <div class="notes-grid">
                    ${sharedNotes.map(note => createNoteCard(note)).join('')}
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// Fonction pour créer une carte de note
function createNoteCard(note) {
    const date = new Date(note.created_at).toLocaleDateString('fr-FR');
    const isVideo = note.file_type === 'youtube' || ['mp4','mov','avi','mkv','webm'].includes(note.file_type);
    
    return `
        <div class="note-card" data-note-id="${note.id}">
            <div class="note-header">
                <div class="note-type-badge ${note.type}">
                    ${note.type === 'shared' ? '<i class="fas fa-share"></i> Partagée' : '<i class="fas fa-bookmark"></i> Sauvegardée'}
                </div>
                <h4 class="note-title">${note.title}</h4>
            </div>
            <div class="note-meta">
                <span class="note-subject">${note.subject}</span>
                <span class="note-date">${date}</span>
            </div>
            <div class="note-actions">
                ${isVideo ? `
                    <button class="btn btn-primary" onclick="window.location.href='/videos#video-${note.id}'">
                        <i class="fas fa-video"></i> Voir
                    </button>
                ` : `
                    <button class="btn btn-primary" onclick="window.open('${note.file_url}', '_blank')">
                        <i class="fas fa-eye"></i> Voir
                    </button>
                `}
                <button class="btn btn-success" onclick="window.open('${note.download_url || note.file_url}', '_blank')">
                    <i class="fas fa-download"></i> Télécharger
                </button>
                ${note.type === 'saved' ? `
                    <button class="btn btn-danger" onclick="unsaveNote(${note.id})">
                        <i class="fas fa-trash"></i> Retirer
                    </button>
                ` : ''}
            </div>
        </div>
    `;
}

// Fonction pour retirer une note sauvegardée
async function unsaveNote(noteId) {
    if (!confirm('Êtes-vous sûr de vouloir retirer cette note de vos sauvegardes ?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/unsave_ressource/${noteId}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            showNotification('✅ Note retirée des sauvegardes', 'success');
            // Recharger les données
            loadNotesStats();
            loadMyNotes();
        } else {
            throw new Error('Erreur lors de la suppression');
        }
    } catch (error) {
        console.error('Erreur retrait note:', error);
        showNotification('❌ Erreur lors du retrait de la note', 'error');
    }
}

// Fonction d'affichage d'erreur
function showNotesError() {
    const container = document.getElementById('notes-list-container');
    if (container) {
        container.innerHTML = `
            <div class="error-state">
                <i class="fas fa-exclamation-triangle" style="font-size: 3em; color: #dc3545; margin-bottom: 15px;"></i>
                <h3>Erreur de chargement</h3>
                <p>Impossible de charger vos notes. Veuillez réessayer.</p>
                <button class="btn btn-primary" onclick="loadMyNotes()">
                    <i class="fas fa-redo"></i> Réessayer
                </button>
            </div>
        `;
    }
}

// Chargement initial
document.addEventListener('DOMContentLoaded', function() {
    console.log('Chargement des statistiques des notes...');
    loadNotesStats();
    loadMyNotes();
    
    // Recharger les stats toutes les 30 secondes (optionnel)
    setInterval(loadNotesStats, 30000);
});
</script>
{% endblock %}